<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>FlashChat Pro ‚Äî –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#111827;
      --card:rgba(31,41,55,.6);
      --border:rgba(148,163,184,.15);
      --muted:#9ca3af;
      --text:#e5e7eb;
      --purple:#8b5cf6;
      --blue:#60a5fa;
    }

    *{ box-sizing:border-box; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; margin:0; padding:0; }

    body{
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
      height:100vh;
      height:100svh;
      height:100dvh;
    }

    .gradient-bg{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .gradient-green{ background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .gradient-orange{ background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .glass{ background: rgba(255,255,255,.06); backdrop-filter: blur(14px); }

    /* App shell */
    #appShell{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
      height:100vh;
      height:100svh;
      height:100dvh;
      overflow:hidden;
    }

    #authScreen{ position:absolute; inset:0; overflow:auto; -webkit-overflow-scrolling:touch; }

    #chatScreen{ position:absolute; inset:0; display:none; }
    #chatScreen.active{ display:flex; }

    /* === RESPONSIVE LAYOUT === */
    
    /* Desktop (>1200px) */
    #sidebar{ 
      width:380px; 
      min-width:320px; 
      max-width:420px;
      display:flex; 
      flex-direction:column; 
      height:100%; 
      border-right:1px solid var(--border); 
      background:rgba(15, 23, 42, .55); 
    }
    #chatArea{ 
      flex:1 1 auto; 
      min-width:0; 
      display:flex; 
      flex-direction:column; 
      height:100%; 
      background:rgba(2,6,23,.35); 
    }

    /* Tablet (769px - 1200px) */
    @media (min-width: 769px) and (max-width: 1200px){
      #sidebar{ width:320px; min-width:280px; max-width:350px; }
    }

    /* Mobile (<=768px) */
    @media (max-width: 768px){
      #chatScreen.active{ display:block; }
      #sidebar, #chatArea{ 
        position:absolute; 
        inset:0; 
        width:100%; 
        max-width:none; 
        min-width:0; 
        height:100%; 
        height:100svh; 
        height:100dvh; 
      }
      #sidebar{ display:flex; }
      #chatArea{ display:none; }
      #chatArea.active{ display:flex; }
    }

    @supports (height: -webkit-fill-available){
      body{ height: -webkit-fill-available; }
      #appShell{ height: -webkit-fill-available; }
    }

    /* Sidebar internals */
    #chatList{ flex:1 1 auto; min-height:0; overflow:auto; -webkit-overflow-scrolling:touch; }
    #searchResults{ max-height: 40vh; overflow:auto; }

    /* Chat area internals */
    #emptyChat{ flex:1 1 auto; display:flex; align-items:center; justify-content:center; padding:24px; }
    #activeChat{ flex:1 1 auto; min-height:0; display:none; flex-direction:column; overflow:hidden; }
    #activeChat.active{ display:flex; }
    .chat-header{ flex:0 0 auto; border-bottom:1px solid var(--border); background:rgba(15, 23, 42, .85); }

    #messagesContainer{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding:16px;
      padding-bottom:20px;
    }

    #typingIndicator{ flex:0 0 auto; }
    #uploadPreview{ flex:0 0 auto; }

    /* Input pinned */
    #messageInputArea{
      flex:0 0 auto;
      border-top:1px solid var(--border);
      background:rgba(15, 23, 42, .92);
      padding:10px;
      padding-bottom:max(10px, env(safe-area-inset-bottom));
    }

    #messageForm{ display:flex; align-items:center; gap:8px; }
    #messageInput{
      flex:1 1 auto;
      min-width:0;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(31,41,55,.5);
      color:white;
      padding:0 14px;
      font-size:15px;
      outline:none;
    }
    #messageInput:focus{ border-color: rgba(139,92,246,.9); box-shadow: 0 0 0 3px rgba(139,92,246,.15); }

    .icon-btn{
      width:44px; height:44px;
      display:grid; place-items:center;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(31,41,55,.25);
      color:#cbd5e1;
      flex:0 0 auto;
      cursor:pointer;
      transition: all .15s;
    }
    .icon-btn:hover{ background:rgba(31,41,55,.45); color:white; }

    .send-btn{
      width:44px; height:44px;
      display:grid; place-items:center;
      border-radius:14px;
      border:none;
      color:white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 8px 20px rgba(102,126,234,.28);
      flex:0 0 auto;
      cursor:pointer;
      transition: opacity .15s;
    }
    .send-btn:hover{ opacity:.92; }

    /* Scrollbars */
    .scrollbar::-webkit-scrollbar{ width:6px; height:6px; }
    .scrollbar::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.25); border-radius:999px; }
    .scrollbar::-webkit-scrollbar-track{ background: transparent; }

    /* === MESSAGES - RESPONSIVE (TG-like bubbles) === */
    .message-row{ display:flex; width:100%; margin-bottom:6px; }
    .message-row.out{ justify-content:flex-end; }
    .message-row.in{ justify-content:flex-start; }

    /*
      IMPORTANT:
      –ù–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö (–æ—Å–æ–±–µ–Ω–Ω–æ Safari) "—Ä–∞–Ω–Ω–∏–π –ø–µ—Ä–µ–Ω–æ—Å" —Å–ª—É—á–∞–µ—Ç—Å—è,
      –∫–æ–≥–¥–∞ –æ–±—ë—Ä—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∂–∏–º–∞–µ—Ç—Å—è –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É, –∞ max-width –≤ % —Å—á–∏—Ç–∞–µ—Ç—Å—è
      –æ—Ç —ç—Ç–æ–π –º–∞–ª–µ–Ω—å–∫–æ–π —à–∏—Ä–∏–Ω—ã. –ü–æ—ç—Ç–æ–º—É –æ–±—ë—Ä—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å width:100%.
    */
    .message-row > div{
      width:100%;
      display:flex;
      flex-direction:column;
      min-width:0;
      max-width:100%;
    }
    .message-row.out > div{ align-items:flex-end; }
    .message-row.in > div{ align-items:flex-start; }

    /* Bubble: –Ω–µ –∑–∞–¥–∞—ë–º width:fit-content, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–µ–π —Å —Ä–∞—Å—á—ë—Ç–æ–º —à–∏—Ä–∏–Ω—ã –≤ flex.
       Inline-block —Å–∞–º —Å–æ–∂–º—ë—Ç—Å—è –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É, –∞ max-width –æ–≥—Ä–∞–Ω–∏—á–∏—Ç –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. */
    .bubble{
      display:inline-block;
      max-width: 72%;
      border-radius:18px;
      padding:10px 14px;
      position:relative;
      overflow:hidden;
      text-align:left;
      white-space: normal;
      /* –Ω–µ –ª–æ–º–∞–µ–º —Å–ª–æ–≤–∞ ¬´—Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏¬ª */
      overflow-wrap: normal;
      word-break: normal;
      hyphens: manual;
    }
    .bubble.out{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-top-right-radius:6px; }
    .bubble.in{ background: rgba(31,41,55,.75); border-top-left-radius:6px; border:1px solid rgba(148,163,184,.12); }

    /* Tablet bubbles */
    @media (min-width: 769px) and (max-width: 1200px){
      .bubble{ max-width: 78%; }
    }

    /* Mobile bubbles */
    @media (max-width: 768px){
      .bubble{ max-width: 88%; padding: 8px 12px; }
      #messagesContainer{ padding: 10px; }
    }

    /* Small phones */
    @media (max-width: 400px){
      .bubble{ max-width: 92%; padding: 7px 10px; font-size: 14px; }
      #messagesContainer{ padding: 8px; }
    }

    .msg-wrap{ width:100%; min-width:0; max-width:100%; display:flex; flex-direction:column; }

    .sender-line{ font-size:12px; color: rgba(167,139,250, .95); margin: 0 0 6px 2px; display:flex; align-items:center; gap:6px; }

    /* Prevent time/checks from wrapping and causing bubble width jumps */
    .meta{ display:flex; justify-content:flex-end; align-items:center; gap:6px; margin-top:6px; white-space:nowrap; }
    .meta .time{ font-size:11px; color: rgba(255,255,255,.75); }
    .bubble.in .meta .time{ color: rgba(148,163,184,.85); }

    /* === MEDIA IN MESSAGES - RESPONSIVE === */
    .message-media{
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.45);
      display:inline-block; /* don't stretch the bubble */
      width: fit-content;
      max-width: 100%;
    }
    .message-media img, .message-media video{
      display:block;
      width:auto;
      height:auto;
      max-width:100%;
      max-height:400px;
      object-fit:contain;
      background:black;
      cursor:pointer;
    }

    /* Desktop media */
    @media (min-width: 1201px){
      .message-media img, .message-media video{ max-width: 400px; max-height: 450px; }
    }

    /* Tablet media */
    @media (min-width: 769px) and (max-width: 1200px){
      .message-media img, .message-media video{ max-width: 320px; max-height: 380px; }
    }

    /* Mobile media */
    @media (max-width: 768px){
      .message-media img, .message-media video{ max-width: 280px; max-height: 350px; }
    }

    /* Small phones media */
    @media (max-width: 400px){
      .message-media img, .message-media video{ max-width: 220px; max-height: 280px; }
      .message-media{ border-radius: 10px; }
    }

    .msg-text{
      font-size: 14px;
      line-height: 1.4;
      max-width: 100%;
      min-width: 0;
      /* –æ–±—ã—á–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–∞–∫ –≤ Telegram: –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞ –Ω–µ –ª–æ–º–∞–µ–º */
      white-space: pre-wrap;
      word-break: normal;
      overflow-wrap: break-word; /* –ø–µ—Ä–µ–Ω–æ—Å–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ª–æ–≤–æ/URL —Ä–µ–∞–ª—å–Ω–æ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è */
      hyphens: manual;
    }

    .media-caption{ margin-top: 6px; }
    .bubble .text-sm{ line-height: 1.4; }

    .file-chip{ 
      display:flex; 
      align-items:center; 
      gap:10px; 
      padding:10px; 
      border-radius:14px; 
      background:rgba(15,23,42,.45); 
      border:1px solid rgba(148,163,184,.15);
      max-width: 100%;
      min-width: 0;
    }
    .file-chip *{ min-width:0; }
    .file-chip .min-w-0{ min-width: 0; }

    /* Voice message styles */
    .voice-message{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:18px;
      background:rgba(15,23,42,.35);
      border:1px solid rgba(148,163,184,.12);
      max-width:280px;
      min-width:200px;
    }
    .bubble.out .voice-message{
      background:rgba(255,255,255,.1);
      border-color:rgba(255,255,255,.15);
    }
    .voice-play-btn{
      width:36px;
      height:36px;
      border-radius:50%;
      background:rgba(139,92,246,.85);
      border:none;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex-shrink:0;
      transition:all .15s;
    }
    .voice-play-btn:hover{
      background:rgba(139,92,246,1);
      transform:scale(1.05);
    }
    .voice-play-btn svg{
      width:16px;
      height:16px;
      color:white;
    }
    .voice-waveform{
      flex:1;
      height:32px;
      display:flex;
      align-items:center;
      gap:2px;
      min-width:0;
    }
    .voice-bar{
      flex:1;
      min-width:2px;
      background:rgba(139,92,246,.4);
      border-radius:2px;
      transition:all .2s;
    }
    .voice-bar.active{
      background:rgba(139,92,246,.9);
    }
    .bubble.out .voice-bar{
      background:rgba(255,255,255,.3);
    }
    .bubble.out .voice-bar.active{
      background:rgba(255,255,255,.8);
    }
    .voice-duration{
      font-size:12px;
      color:rgba(148,163,184,.85);
      white-space:nowrap;
      flex-shrink:0;
    }
    .bubble.out .voice-duration{
      color:rgba(255,255,255,.75);
    }

    /* Recording indicator */
    .recording-indicator{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      background:rgba(239,68,68,.15);
      border:1px solid rgba(239,68,68,.3);
      border-radius:12px;
      color:#f87171;
      font-size:14px;
    }
    .recording-dot{
      width:8px;
      height:8px;
      background:#ef4444;
      border-radius:50%;
      animation:pulse 1.5s infinite;
    }
    @keyframes pulse{
      0%,100%{ opacity:1; transform:scale(1); }
      50%{ opacity:.5; transform:scale(1.2); }
    }

    /* Safety: nothing inside bubble should force bubble to grow wider than max-width */
    .bubble > *{ max-width:100%; }

    @media (max-width: 768px){
      .file-chip{ padding: 8px; gap: 8px; border-radius: 12px; }
      .file-chip svg{ width: 24px; height: 24px; }
    }

    /* Typing indicator */
    .typing-dot{ width:7px; height:7px; background:rgba(148,163,184,.9); border-radius:999px; display:inline-block; animation:typing 1.2s infinite; }
    .typing-dot:nth-child(2){ animation-delay:.15s; }
    .typing-dot:nth-child(3){ animation-delay:.3s; }
    @keyframes typing{ 0%,60%,100%{ transform:translateY(0); opacity:.7 } 30%{ transform:translateY(-4px); opacity:1 } }

    /* Toast */
    #toast{ position:fixed; top:14px; left:14px; right:14px; max-width:520px; margin:0 auto; z-index:80; }

    /* Modals */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:70; background:rgba(0,0,0,.65); backdrop-filter: blur(6px); }
    .modal.show{ display:flex; }
    .sheet{ width:100%; max-width:520px; border-radius:22px; border:1px solid rgba(148,163,184,.18); background:rgba(15,23,42,.95); box-shadow: 0 18px 60px rgba(0,0,0,.45); overflow:hidden; max-height: 90vh; overflow-y: auto; }

    @media (max-width:768px){
      .modal{ padding: 10px; }
      .sheet{ max-width: 100%; border-radius: 20px; max-height: 85vh; }
      .sheet.bottom{ align-self:flex-end; border-bottom-left-radius:0; border-bottom-right-radius:0; }
    }

    /* Emoji picker */
    #emojiPicker{ display:none; margin-top:10px; border-radius:16px; border:1px solid rgba(148,163,184,.15); overflow:hidden; background:rgba(15,23,42,.85); }
    #emojiPicker.show{ display:block; }
    .emoji-tabs{ display:flex; border-bottom:1px solid rgba(148,163,184,.12); overflow-x:auto; }
    .emoji-tab{ flex:1; min-width:40px; padding:10px 0; text-align:center; font-size:18px; color:#cbd5e1; border-bottom:2px solid transparent; background:rgba(2,6,23,.18); }
    .emoji-tab.active{ border-bottom-color: rgba(139,92,246,.9); color:white; }
    .emoji-grid{ padding:10px; max-height:200px; overflow:auto; display:grid; grid-template-columns: repeat(8, 1fr); gap:6px; }
    .emoji-btn{ 
      border-radius:8px; 
      padding:8px; 
      font-size:20px; 
      line-height:1; 
      cursor:pointer; 
      border:1px solid rgba(148,163,184,.15); 
      background:rgba(2,6,23,.3);
      transition: all 0.15s ease;
    }
    .emoji-btn:hover{ 
      background:rgba(139,92,246,.2); 
      border-color:rgba(139,92,246,.4);
      transform: scale(1.1);
    }

    @media (max-width: 768px){
      .emoji-grid{ grid-template-columns: repeat(7, 1fr); max-height: 180px; gap:5px; }
      .emoji-btn{ font-size: 22px; padding: 8px; }
    }

    @media (max-width: 400px){
      .emoji-grid{ grid-template-columns: repeat(6, 1fr); gap:4px; }
      .emoji-btn{ padding: 6px; }
    }

    /* Developer badge */
    .dev-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:.6px;
      color:white;
      background: linear-gradient(135deg,#f093fb 0%, #f5576c 100%);
      border:1px solid rgba(255,255,255,.18);
      vertical-align:middle;
      white-space:nowrap;
    }
    .dev-badge svg{ width:12px; height:12px; }

    /* Message context menu */
    #messageContextMenu{ position:fixed; display:none; z-index:75; border-radius:16px; background:rgba(15,23,42,.95); border:1px solid rgba(148,163,184,.18); box-shadow: 0 14px 40px rgba(0,0,0,.45); min-width: 180px; overflow:hidden; }
    #messageContextMenu.show{ display:block; }
    .context-menu-btn{ width:100%; display:flex; align-items:center; gap:10px; padding:12px 16px; border:none; background:transparent; color:#e5e7eb; cursor:pointer; font-size:14px; transition: background .15s; }
    .context-menu-btn:hover{ background:rgba(148,163,184,.12); }
    .context-menu-btn.text-red-400{ color:#f87171; }
    .context-menu-btn.text-red-400:hover{ background:rgba(248,113,113,.12); }
    .context-menu-divider{ height:1px; background:rgba(148,163,184,.15); margin:4px 0; }

    /* Reaction picker */
    .reaction-btn{ font-size:22px; padding:6px; border-radius:12px; border:none; background:transparent; cursor:pointer; transition: transform .15s; }
    .reaction-btn:hover{ background:rgba(148,163,184,.12); transform:scale(1.15); }

    /* Edited message indicator */
    .edited-indicator{ font-size:11px; color:rgba(148,163,184,.7); font-style:italic; }

    /* Image viewer */
    #imageViewer{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:90; background:rgba(0,0,0,.95); padding:16px; }
    #imageViewer.show{ display:flex; }
    #imageViewer img{ max-width: 95vw; max-height: 90vh; object-fit: contain; }

    /* Avatar upload button */
    .avatar-upload{
      position:relative;
      cursor:pointer;
    }
    .avatar-upload input[type="file"]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
      z-index:10;
    }
    .avatar-upload-overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.5);
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      transition: opacity .2s;
      pointer-events:none;
    }
    .avatar-upload:hover .avatar-upload-overlay{ opacity:1; }

    /* Chat avatar with image support */
    .chat-avatar{
      width:48px;
      height:48px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      font-size:18px;
      overflow:hidden;
      flex-shrink:0;
    }
    .chat-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .chat-avatar-sm{
      width:40px;
      height:40px;
      font-size:16px;
    }

    .chat-avatar-lg{
      width:80px;
      height:80px;
      font-size:28px;
    }

    @media (max-width: 768px){
      .chat-avatar{ width: 44px; height: 44px; font-size: 16px; }
      .chat-avatar-lg{ width: 64px; height: 64px; font-size: 24px; }
    }

    /* Small helpers */
    .fade-in{ animation: fade .18s ease; }
    @keyframes fade{ from{ opacity:0; transform: translateY(8px);} to{ opacity:1; transform: translateY(0);} }
    
    .truncate-2{ display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* –ó–∞–ø—Ä–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
    body, .bubble, .msg-text, #chatList, #messagesContainer {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* –†–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞ */
    input, textarea {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    /* Confirm Modal */
    #confirmModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      background: rgba(0,0,0,.7);
      backdrop-filter: blur(6px);
      padding: 16px;
    }
    #confirmModal.show { display: flex; }
    .confirm-box {
      width: 100%;
      max-width: 320px;
      border-radius: 20px;
      background: rgba(15,23,42,.98);
      border: 1px solid rgba(148,163,184,.18);
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      overflow: hidden;
      animation: fade .2s ease;
    }
    .confirm-box .confirm-header {
      padding: 20px 20px 12px;
      text-align: center;
    }
    .confirm-box .confirm-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(239,68,68,.15);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
    }
    .confirm-box .confirm-icon svg {
      width: 28px;
      height: 28px;
      color: #f87171;
    }
    .confirm-box .confirm-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .confirm-box .confirm-text {
      font-size: 14px;
      color: #9ca3af;
      line-height: 1.4;
    }
    .confirm-box .confirm-buttons {
      display: flex;
      border-top: 1px solid rgba(148,163,184,.15);
    }
    .confirm-box .confirm-btn {
      flex: 1;
      padding: 14px;
      border: none;
      background: transparent;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background .15s;
    }
    .confirm-box .confirm-btn:first-child {
      color: #9ca3af;
      border-right: 1px solid rgba(148,163,184,.15);
    }
    .confirm-box .confirm-btn:first-child:hover {
      background: rgba(148,163,184,.1);
    }
    .confirm-box .confirm-btn.danger {
      color: #f87171;
    }
    .confirm-box .confirm-btn.danger:hover {
      background: rgba(239,68,68,.15);
    }

    /* Theme button active state */
    .theme-btn.active {
      border-color: rgba(139,92,246,.9) !important;
      background: rgba(139,92,246,.1);
    }

    /* Light theme */
    body.light-theme {
      --bg: #f0f4f8;
      --panel: #ffffff;
      --panel2: #fafbfd;
      --card: rgba(255,255,255,.98);
      --border: rgba(100,116,139,.15);
      --muted: #6b7280;
      --text: #1e293b;
      --text-secondary: #475569;
      --purple: #7c3aed;
      --purple-light: #a78bfa;
      --blue: #3b82f6;
      background: var(--bg);
      color: var(--text);
    }

    body.light-theme #sidebar {
      background: var(--panel);
      border-color: var(--border);
      box-shadow: 2px 0 16px rgba(15,23,42,.04);
    }
    
    body.light-theme #chatArea {
      background: #fafbfd;
      border-color: var(--border);
    }
    
    body.light-theme .chat-header {
      background: rgba(255,255,255,.98);
      border-bottom: 1px solid rgba(100,116,139,.1);
      box-shadow: 0 1px 3px rgba(15,23,42,.03);
      backdrop-filter: blur(12px);
    }
    
    body.light-theme #messageInputArea {
      background: rgba(255,255,255,.98);
      border-top: 1px solid rgba(100,116,139,.1);
      box-shadow: 0 -1px 3px rgba(15,23,42,.02);
    }

    body.light-theme .bubble.in {
      background: #ffffff;
      border: 1px solid rgba(148,163,184,.1);
      color: #1e293b;
      box-shadow: 0 1px 3px rgba(15,23,42,.04), 0 1px 2px rgba(15,23,42,.02);
    }
    
    body.light-theme .bubble.out {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(124,58,237,.2), 0 1px 3px rgba(124,58,237,.15);
      border: none;
    }

    body.light-theme .bubble.in .meta .time,
    body.light-theme .bubble.in .meta svg {
      color: #94a3b8;
    }
    
    body.light-theme .bubble.out .meta .time,
    body.light-theme .bubble.out .meta svg {
      color: rgba(255,255,255,.9);
    }

    body.light-theme #messageInput {
      background: #f8fafc;
      color: #1e293b;
      border: 1px solid rgba(148,163,184,.18);
    }
    
    body.light-theme #messageInput:focus {
      background: white;
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124,58,237,.08);
    }
    
    body.light-theme .icon-btn {
      background: #f8fafc;
      color: #6b7280;
      border-color: rgba(148,163,184,.12);
    }
    
    body.light-theme .icon-btn:hover {
      background: #f3f0ff;
      color: #7c3aed;
      border-color: rgba(124,58,237,.25);
    }
    
    body.light-theme .send-btn {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      color: white;
      box-shadow: 0 4px 14px rgba(124,58,237,.25);
    }
    
    body.light-theme .send-btn:hover {
      box-shadow: 0 6px 20px rgba(124,58,237,.35);
      transform: translateY(-1px);
    }

    body.light-theme .sheet,
    body.light-theme .modal > div {
      background: white;
      border: 1px solid rgba(148,163,184,.1);
      box-shadow: 0 20px 60px rgba(15,23,42,.08), 0 8px 16px rgba(15,23,42,.04);
    }

    body.light-theme .glass {
      background: rgba(255,255,255,.96);
      backdrop-filter: blur(16px);
    }

    body.light-theme input,
    body.light-theme textarea,
    body.light-theme select {
      background: #f8fafc;
      color: #1e293b;
      border: 1px solid rgba(148,163,184,.18);
    }
    
    body.light-theme input:focus,
    body.light-theme textarea:focus,
    body.light-theme select:focus {
      background: white;
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124,58,237,.08);
    }

    body.light-theme .voice-message {
      background: white;
      border: 1px solid rgba(148,163,184,.1);
      box-shadow: 0 1px 3px rgba(15,23,42,.04);
    }

    body.light-theme .voice-bar {
      background: rgba(124,58,237,.18);
    }

    body.light-theme .voice-bar.active {
      background: #7c3aed;
    }

    body.light-theme .voice-duration {
      color: #6b7280;
    }
    
    body.light-theme .chat-avatar {
      box-shadow: 0 2px 8px rgba(15,23,42,.06);
    }
    
    body.light-theme #chatList > div {
      border-bottom: 1px solid rgba(148,163,184,.06);
    }
    
    body.light-theme #chatList > div:hover {
      background: #fafbfd;
    }
    
    body.light-theme #emptyChat {
      color: #6b7280;
    }
    
    body.light-theme .context-menu-btn {
      color: #1e293b;
    }
    
    body.light-theme .context-menu-btn:hover {
      background: #f8fafc;
    }
    
    body.light-theme .context-menu-btn.text-red-400 {
      color: #dc2626;
    }
    
    body.light-theme .context-menu-btn.text-red-400:hover {
      background: rgba(220,38,38,.06);
    }
    
    body.light-theme #messageContextMenu {
      background: white;
      border: 1px solid rgba(148,163,184,.1);
      box-shadow: 0 8px 24px rgba(15,23,42,.08), 0 2px 8px rgba(15,23,42,.04);
    }
    
    body.light-theme .context-menu-divider {
      background: rgba(148,163,184,.1);
    }
    
    body.light-theme .emoji-picker {
      background: white;
      border: 1px solid rgba(148,163,184,.1);
      box-shadow: 0 8px 24px rgba(15,23,42,.08), 0 2px 8px rgba(15,23,42,.04);
    }
    
    body.light-theme .emoji-tab {
      background: #f8fafc;
      color: #6b7280;
    }
    
    body.light-theme .emoji-tab.active {
      background: white;
      color: #7c3aed;
      border-bottom-color: #7c3aed;
    }
    
    body.light-theme .emoji-btn {
      background: #fafbfd;
      border-color: rgba(148,163,184,.1);
    }
    
    body.light-theme .emoji-btn:hover {
      background: #f3f0ff;
      border-color: #a78bfa;
      transform: scale(1.1);
    }
    
    body.light-theme .file-chip {
      background: white;
      border: 1px solid rgba(148,163,184,.1);
      box-shadow: 0 1px 3px rgba(15,23,42,.04);
    }
    
    body.light-theme #messagesContainer {
      background: #fafbfd;
    }
    
    body.light-theme #pinnedMessage {
      background: rgba(124,58,237,.05);
      border-bottom: 1px solid rgba(124,58,237,.12);
    }
    
    body.light-theme .scrollbar::-webkit-scrollbar-track {
      background: #f8fafc;
    }
    
    body.light-theme .scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    body.light-theme .scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    body.light-theme .confirm-box {
      background: white;
      border: 1px solid rgba(148,163,184,.1);
      box-shadow: 0 20px 60px rgba(15,23,42,.12), 0 8px 16px rgba(15,23,42,.06);
    }
    
    body.light-theme .confirm-box .confirm-text {
      color: #6b7280;
    }
    
    body.light-theme .confirm-box .confirm-buttons {
      border-top: 1px solid rgba(148,163,184,.1);
    }
    
    body.light-theme .confirm-box .confirm-btn:first-child {
      color: #6b7280;
      border-right: 1px solid rgba(148,163,184,.1);
    }
    
    body.light-theme .confirm-box .confirm-btn:first-child:hover {
      background: #f8fafc;
    }
    
    body.light-theme .confirm-box .confirm-btn.danger {
      color: #dc2626;
    }
    
    body.light-theme .confirm-box .confirm-btn.danger:hover {
      background: rgba(220,38,38,.06);
    }
    
    body.light-theme .reaction-btn:hover {
      background: #f8fafc;
    }
    
    body.light-theme .edited-indicator {
      color: #94a3b8;
    }
    
    body.light-theme #imageViewer {
      background: rgba(255,255,255,.98);
    }
    
    body.light-theme .avatar-upload-overlay {
      background: rgba(0,0,0,.35);
    }
    
    body.light-theme .theme-btn {
      background: #f8fafc;
      border-color: rgba(148,163,184,.18);
      color: #1e293b;
    }
    
    body.light-theme .theme-btn:hover {
      background: #f3f0ff;
      border-color: rgba(124,58,237,.25);
    }
    
    body.light-theme .theme-btn.active {
      border-color: #7c3aed !important;
      background: rgba(124,58,237,.08);
      color: #7c3aed;
    }
    
    body.light-theme #uploadPreview {
      background: rgba(255,255,255,.98);
      border-top: 1px solid rgba(100,116,139,.1);
    }
    
    body.light-theme #typingIndicator {
      color: #6b7280;
    }
    
    body.light-theme .dev-badge {
      background: rgba(124,58,237,.08);
      color: #7c3aed;
      border-color: rgba(124,58,237,.18);
    }
    
    body.light-theme #authScreen {
      background: linear-gradient(135deg, #ddd6fe 0%, #e9d5ff 50%, #fae8ff 100%);
    }
    
    body.light-theme .modal {
      background: rgba(15,23,42,.35);
      backdrop-filter: blur(4px);
    }
    
    body.light-theme button:not(.icon-btn):not(.send-btn):not(.confirm-btn):not(.context-menu-btn):not(.emoji-btn):not(.reaction-btn):not(.theme-btn) {
      background: #7c3aed;
      color: white;
      border: none;
      box-shadow: 0 2px 8px rgba(124,58,237,.2);
    }
    
    body.light-theme button:not(.icon-btn):not(.send-btn):not(.confirm-btn):not(.context-menu-btn):not(.emoji-btn):not(.reaction-btn):not(.theme-btn):hover {
      background: #6d28d9;
      box-shadow: 0 4px 12px rgba(124,58,237,.3);
    }
    
    body.light-theme .scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Toast –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è */
    .copy-toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(148,163,184,.2);
      border-radius: 12px;
      padding: 10px 20px;
      font-size: 14px;
      color: #e5e7eb;
      z-index: 200;
      animation: fadeInUp .2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translate(-50%, 10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
  </style>
</head>
<body>
  <div id="appShell">

    <!-- AUTH -->
    <div id="authScreen" class="px-4 py-10">
      <div class="mx-auto w-full max-w-md">
        <div class="text-center mb-8">
          <div class="w-20 h-20 gradient-bg rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg">
            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
          </div>
          <h1 class="text-3xl font-bold">FlashChat Pro</h1>
          <p class="text-slate-400 mt-2">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è</p>
        </div>

        <div id="savedAccounts" class="hidden mb-4">
          <p class="text-sm text-slate-400 mb-2">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:</p>
          <div id="accountsList" class="space-y-2 max-h-40 overflow-auto scrollbar"></div>
        </div>

        <div class="glass rounded-3xl p-6 border" style="border-color: var(--border)">
          <div class="flex mb-6 bg-white/5 rounded-xl p-1">
            <button id="loginTab" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all bg-violet-600 text-white" onclick="showTab('login')">–í—Ö–æ–¥</button>
            <button id="registerTab" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all text-slate-400" onclick="showTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          </div>

          <form id="loginForm" class="space-y-4" onsubmit="login(event)">
            <input type="email" id="loginEmail" required placeholder="Email" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <input type="password" id="loginPassword" required placeholder="–ü–∞—Ä–æ–ª—å" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <label class="flex items-center gap-2 text-sm text-slate-400">
              <input type="checkbox" id="saveAccount" checked>
              <span>–ó–∞–ø–æ–º–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</span>
            </label>
            <button type="submit" class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95">–í–æ–π—Ç–∏</button>
          </form>

          <form id="registerForm" class="space-y-4 hidden" onsubmit="register(event)">
            <input type="text" id="registerName" required placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <input type="email" id="registerEmail" required placeholder="Email" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <input type="password" id="registerPassword" required minlength="6" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <button type="submit" class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
          </form>

          <div id="authError" class="mt-4 text-red-300 text-sm text-center hidden"></div>
        </div>
      </div>
    </div>

    <!-- CHAT -->
    <div id="chatScreen">
      <!-- Sidebar -->
      <aside id="sidebar" class="safe-top">
        <div class="p-3 border-b" style="border-color: var(--border)">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-bold">FlashChat</h2>
            <div class="flex gap-1">
              <button class="icon-btn" title="–°–æ–∑–¥–∞—Ç—å" onclick="showCreateMenu()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              </button>
              <button class="icon-btn" title="–ê–∫–∫–∞—É–Ω—Ç—ã" onclick="showAccountSwitcher()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </button>
              <button class="icon-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" onclick="showAppSettings()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </button>
              <button class="icon-btn" title="–ü—Ä–æ—Ñ–∏–ª—å" onclick="showProfile()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              </button>
            </div>
          </div>

          <div class="flex gap-1 mb-3 bg-white/5 rounded-xl p-1">
            <button id="tabAll" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-violet-600" onclick="showChatTab('all')">–í—Å–µ</button>
            <button id="tabPrivate" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400" onclick="showChatTab('private')">–õ–∏—á–Ω—ã–µ</button>
            <button id="tabGroups" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400" onclick="showChatTab('groups')">–ì—Ä—É–ø–ø—ã</button>
            <button id="tabChannels" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400" onclick="showChatTab('channels')">–ö–∞–Ω–∞–ª—ã</button>
          </div>

          <div class="relative">
            <input id="searchInput" oninput="searchAll()" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 pl-10 outline-none focus:border-violet-500 text-sm" placeholder="–ü–æ–∏—Å–∫...">
            <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </div>
        </div>

        <div id="searchResults" class="hidden border-b" style="border-color: var(--border)"></div>
        
        <!-- Saved Messages -->
        <div class="border-b" style="border-color: var(--border)">
          <div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-white/5 transition" onclick="openSavedMessages()">
            <div class="relative shrink-0">
              <div class="chat-avatar gradient-bg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-medium">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
              <div class="text-sm text-slate-400">–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
            </div>
          </div>
        </div>
        
        <div id="chatList" class="scrollbar"></div>
      </aside>

      <!-- Chat Area -->
      <main id="chatArea">
        <div id="emptyChat">
          <div class="text-center">
            <div class="w-24 h-24 bg-white/5 rounded-full mx-auto mb-4 grid place-items-center">
              <svg class="w-12 h-12 text-slate-500" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
            </div>
            <h3 class="text-xl font-semibold text-slate-300">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
            <p class="text-slate-500 mt-2">–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
          </div>
        </div>

        <section id="activeChat">
          <div class="chat-header p-3 flex items-center gap-3">
            <button class="icon-btn md:hidden" onclick="closeChat()" title="–ù–∞–∑–∞–¥">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <div id="chatAvatar" class="chat-avatar chat-avatar-sm gradient-bg"></div>
            <div class="flex-1 min-w-0">
              <h3 id="chatName" class="font-semibold truncate"></h3>
              <p id="chatStatus" class="text-xs text-slate-400 truncate"></p>
            </div>
            <div id="chatHeaderActions" class="flex gap-1 flex-shrink-0"></div>
          </div>

          <!-- Pinned Message -->
          <div id="pinnedMessage" class="hidden px-4 py-2 border-b" style="border-color: var(--border); background: rgba(139,92,246,0.1); cursor: pointer;" onclick="scrollToPinnedMessage()">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-violet-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
              <div class="flex-1 min-w-0">
                <div class="text-xs text-violet-400 font-medium">–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                <div id="pinnedMessageText" class="text-sm truncate"></div>
              </div>
              <button class="icon-btn" onclick="event.stopPropagation(); unpinMessage()" title="–û—Ç–∫—Ä–µ–ø–∏—Ç—å">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>

          <div id="messagesContainer" class="scrollbar"></div>

          <div id="typingIndicator" class="hidden px-4 py-2">
            <div class="flex items-center gap-2 text-slate-400 text-sm">
              <div class="flex gap-1">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
              </div>
              <span id="typingText">–ø–µ—á–∞—Ç–∞–µ—Ç...</span>
            </div>
          </div>

          <!-- Upload preview with caption + send -->
          <div id="uploadPreview" class="hidden px-3 py-3 border-t" style="border-color: var(--border); background: rgba(15,23,42,.9)">
            <div class="flex flex-col gap-2">
              <div class="flex items-start gap-3">
                <img id="uploadPreviewImage" src="" class="w-20 h-20 object-contain rounded-xl hidden" style="background: rgba(2,6,23,.55)" alt="preview">
                <div id="uploadPreviewFile" class="hidden items-center gap-2 p-2 bg-white/5 rounded-xl border border-white/10">
                  <svg class="w-8 h-8 text-violet-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  <span id="uploadFileName" class="text-sm truncate max-w-[180px]"></span>
                </div>
                <button class="icon-btn ml-auto" onclick="cancelUpload()" title="–û—Ç–º–µ–Ω–∞">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
              <input id="imageCaption" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none focus:border-violet-500" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å (Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏)..." onkeydown="if(event.key==='Enter'){event.preventDefault();sendFileWithCaption();}" />
              <div id="uploadProgress" class="h-2 bg-white/10 rounded-full overflow-hidden hidden">
                <div id="uploadProgressBar" class="h-full gradient-bg" style="width:0%"></div>
              </div>
            </div>
          </div>

          <div id="messageInputArea">
            <div id="recordingIndicator" class="hidden mb-2">
              <div class="recording-indicator">
                <div class="recording-dot"></div>
                <span id="recordingTime">0:00</span>
                <button class="ml-auto text-xs px-3 py-1 bg-red-500/20 rounded-lg hover:bg-red-500/30" onclick="cancelRecording()">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </div>
            <form id="messageForm" onsubmit="sendMessage(event)">
              <input type="file" id="fileInput" class="hidden" accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.zip,.rar,.ppt,.pptx,.txt" onchange="handleFileSelect(event)">
              <button type="button" class="icon-btn" onclick="openFilePicker()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
              </button>
              <button type="button" id="circleBtn" class="icon-btn" title="–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∫—Ä—É–∂–∫–∞">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
              </button>
              <button type="button" id="voiceBtn" class="icon-btn" title="–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
              </button>
              <button type="button" class="icon-btn" onclick="toggleEmoji()" title="–≠–º–æ–¥–∑–∏">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              </button>
              <input id="messageInput" type="text" autocomplete="off" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="handleTyping()">
              <button class="send-btn" type="submit" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
              </button>
            </form>

            <div id="emojiPicker">
              <div class="emoji-tabs">
                <button type="button" class="emoji-tab active" id="emojiTabSmileys" onclick="showEmojiCategory('smileys')">üòÄ</button>
                <button type="button" class="emoji-tab" id="emojiTabGestures" onclick="showEmojiCategory('gestures')">üëã</button>
                <button type="button" class="emoji-tab" id="emojiTabAnimals" onclick="showEmojiCategory('animals')">üê±</button>
                <button type="button" class="emoji-tab" id="emojiTabFood" onclick="showEmojiCategory('food')">üçï</button>
                <button type="button" class="emoji-tab" id="emojiTabActivities" onclick="showEmojiCategory('activities')">‚öΩ</button>
                <button type="button" class="emoji-tab" id="emojiTabTravel" onclick="showEmojiCategory('travel')">üöó</button>
                <button type="button" class="emoji-tab" id="emojiTabObjects" onclick="showEmojiCategory('objects')">üí°</button>
                <button type="button" class="emoji-tab" id="emojiTabSymbols" onclick="showEmojiCategory('symbols')">‚ù§Ô∏è</button>
              </div>
              <div id="emojiGrid" class="emoji-grid scrollbar"></div>
            </div>
          </div>

          <div id="channelNotice" class="px-4 py-4 text-center text-slate-400" style="display:none; border-top:1px solid var(--border); background:rgba(15,23,42,.9)">
            <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
            –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –≤ —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª
          </div>
        </section>
      </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden" onclick="handleToastClick()">
      <div class="glass border" style="border-color:var(--border); border-radius:16px; padding:12px 14px; cursor:pointer;">
        <div class="flex items-center gap-3">
          <div id="toastIcon" class="w-10 h-10 rounded-full gradient-bg grid place-items-center font-bold shrink-0"></div>
          <div class="min-w-0">
            <div id="toastTitle" class="font-semibold truncate"></div>
            <div id="toastMessage" class="text-sm text-slate-400 truncate"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Context Menu -->
    <div id="messageContextMenu" class="fade-in">
      <button onclick="copyMessage()" id="copyMessageBtn" class="context-menu-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
        <span>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
      </button>
      <button onclick="togglePinMessage()" id="pinMessageBtn" class="context-menu-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
        <span id="pinMessageText">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</span>
      </button>
      <button onclick="startEditMessage()" id="editMessageBtn" class="context-menu-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
        <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
      </button>
      <button onclick="deleteMessage()" id="deleteMessageBtn" class="context-menu-btn text-red-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        <span>–£–¥–∞–ª–∏—Ç—å</span>
      </button>
      <div class="context-menu-divider"></div>
      <div class="flex gap-1 p-2">
        <button class="reaction-btn" onclick="addReaction('ÔøΩ')"">ÔøΩ</butto>n>
        <button class="reaction-btn" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
        <button class="reaction-btn" onclick="addReaction('üòÇ')">üòÇ</button>
        <button class="reaction-btn" onclick="addReaction('üòÆ')">üòÆ</button>
        <button class="reaction-btn" onclick="addReaction('üò¢')">üò¢</button>
        <button class="reaction-btn" onclick="addReaction('üî•')">üî•</button>
      </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmModal">
      <div class="confirm-box">
        <div class="confirm-header">
          <div class="confirm-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </div>
          <div class="confirm-title">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?</div>
          <div class="confirm-text">–°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞</div>
        </div>
        <div class="confirm-buttons">
          <button class="confirm-btn" onclick="closeConfirmModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="confirm-btn danger" onclick="confirmDeleteMessage()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Edit Message Modal -->
    <div id="editMessageModal" class="modal" onclick="modalBackdropClose(event, 'editMessageModal')">
      <div class="sheet p-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
          <button class="icon-btn" onclick="closeModal('editMessageModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <textarea id="editMessageText" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500 resize-none h-32" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
        <div class="flex gap-2 mt-4">
          <button class="flex-1 py-2.5 bg-white/5 rounded-xl text-slate-400 hover:bg-white/10" onclick="closeModal('editMessageModal')">–û—Ç–º–µ–Ω–∞</button>
          <button class="flex-1 py-2.5 gradient-bg rounded-xl font-semibold hover:opacity-95" onclick="saveEditedMessage()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Image Viewer -->
    <div id="imageViewer" onclick="closeImageViewer()">
      <button class="absolute top-4 right-4 icon-btn" style="background: rgba(255,255,255,.1); border-color: rgba(255,255,255,.18)">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <img id="viewerImage" alt="view" class="max-w-full max-h-full object-contain" />
    </div>

    <!-- Create Menu Modal -->
    <div id="createMenuModal" class="modal" onclick="modalBackdropClose(event, 'createMenuModal')">
      <div class="sheet bottom p-4">
        <h3 class="text-lg font-bold mb-4 text-center">–°–æ–∑–¥–∞—Ç—å</h3>
        <div class="space-y-2">
          <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="showNewPrivateChat()">
            <div class="w-10 h-10 gradient-bg rounded-full grid place-items-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            </div>
            <div class="text-left">
              <div class="font-medium">–õ–∏—á–Ω—ã–π —á–∞—Ç</div>
              <div class="text-xs text-slate-400">–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</div>
            </div>
          </button>

          <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="showSearchGroupsChannels()">
            <div class="w-10 h-10 gradient-bg rounded-full grid place-items-center" style="background: linear-gradient(135deg,#8b5cf6,#ec4899)">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </div>
            <div class="text-left">
              <div class="font-medium">–ù–∞–π—Ç–∏ –≥—Ä—É–ø–ø—ã –∏ –∫–∞–Ω–∞–ª—ã</div>
              <div class="text-xs text-slate-400">–ü–æ–∏—Å–∫ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤</div>
            </div>
          </button>

          <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="showCreateGroup()">
            <div class="w-10 h-10 gradient-green rounded-full grid place-items-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            </div>
            <div class="text-left">
              <div class="font-medium">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</div>
              <div class="text-xs text-slate-400">–î–æ 200 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            </div>
          </button>

          <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="showCreateChannel()">
            <div class="w-10 h-10 gradient-orange rounded-full grid place-items-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
            </div>
            <div class="text-left">
              <div class="font-medium">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</div>
              <div class="text-xs text-slate-400">–¢–æ–ª—å–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å</div>
            </div>
          </button>
        </div>
        <button class="w-full mt-4 py-2 text-slate-400 hover:text-white" onclick="closeModal('createMenuModal')">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>

    <!-- Search Groups/Channels Modal -->
    <div id="searchGroupsChannelsModal" class="modal" onclick="modalBackdropClose(event, 'searchGroupsChannelsModal')">
      <div class="sheet p-4 max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–ù–∞–π—Ç–∏ –≥—Ä—É–ø–ø—ã –∏ –∫–∞–Ω–∞–ª—ã</h3>
          <button class="icon-btn" onclick="closeModal('searchGroupsChannelsModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        
        <div class="flex gap-2 mb-3">
          <button id="searchTabGroups" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-violet-600 text-white" onclick="switchSearchTab('groups')">–ì—Ä—É–ø–ø—ã</button>
          <button id="searchTabChannels" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400" onclick="switchSearchTab('channels')">–ö–∞–Ω–∞–ª—ã</button>
        </div>
        
        <input id="groupChannelSearchInput" oninput="searchGroupsChannels()" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–ü–æ–∏—Å–∫...">
        <div id="groupChannelSearchResults" class="flex-1 overflow-auto scrollbar"></div>
      </div>
    </div>

    <!-- New Private Chat Modal -->
    <div id="newPrivateChatModal" class="modal" onclick="modalBackdropClose(event, 'newPrivateChatModal')">
      <div class="sheet p-4 max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–ù–æ–≤—ã–π —á–∞—Ç</h3>
          <button class="icon-btn" onclick="closeModal('newPrivateChatModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <input id="userSearchInput" oninput="searchUsersForChat()" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
        <div id="userSearchResults" class="flex-1 overflow-auto scrollbar"></div>
      </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal" onclick="modalBackdropClose(event, 'createGroupModal')">
      <div class="sheet p-4 max-h-[86vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</h3>
          <button class="icon-btn" onclick="closeModal('createGroupModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <input id="groupName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
        <input id="groupSearchInput" oninput="searchUsersForGroup()" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...">
        <div id="selectedMembers" class="flex flex-wrap gap-2 mb-3"></div>
        <div id="groupSearchResults" class="flex-1 overflow-auto scrollbar mb-3 min-h-[200px]"></div>
        <button class="w-full gradient-bg py-2.5 rounded-xl font-semibold hover:opacity-95" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
      </div>
    </div>

    <!-- Create Channel Modal -->
    <div id="createChannelModal" class="modal" onclick="modalBackdropClose(event, 'createChannelModal')">
      <div class="sheet p-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª</h3>
          <button class="icon-btn" onclick="closeModal('createChannelModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <input id="channelName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞">
        <textarea id="channelDescription" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500 resize-none h-24" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
        <button class="w-full gradient-bg py-2.5 rounded-xl font-semibold hover:opacity-95" onclick="createChannel()">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
      </div>
    </div>

    <!-- Account Switcher Modal -->
    <div id="accountSwitcherModal" class="modal" onclick="modalBackdropClose(event, 'accountSwitcherModal')">
      <div class="sheet bottom p-4">
        <h3 class="text-lg font-bold mb-4">–ê–∫–∫–∞—É–Ω—Ç—ã</h3>
        <div id="accountSwitcherList" class="space-y-2 max-h-64 overflow-auto scrollbar mb-4"></div>
        <button class="w-full flex items-center justify-center gap-2 p-3 border border-dashed border-white/20 rounded-xl text-slate-400 hover:border-violet-500 hover:text-violet-300" onclick="addNewAccount()">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
        </button>
        <button class="w-full mt-3 py-2 text-slate-400 hover:text-white" onclick="closeModal('accountSwitcherModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal" onclick="modalBackdropClose(event, 'profileModal')">
      <div class="sheet p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">–ü—Ä–æ—Ñ–∏–ª—å</h3>
          <button class="icon-btn" onclick="closeModal('profileModal')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="text-center mb-6">
          <label class="avatar-upload mx-auto block" style="width:96px;height:96px;position:relative;cursor:pointer;">
            <div id="profileAvatar" class="w-24 h-24 gradient-bg rounded-full grid place-items-center text-3xl font-bold" style="position:relative;">
              <span id="profileAvatarLetter"></span>
              <img id="profileAvatarImg" src="" class="hidden" alt="avatar" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:50%;">
            </div>
            <input type="file" id="profileAvatarInput" accept="image/*" onchange="handleProfileAvatarSelect(event)" style="position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;">
            <div class="avatar-upload-overlay">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
          </label>
          <p class="text-xs text-slate-400 mb-2 mt-2">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏</p>
          <div id="profileNameDisplay" class="text-xl font-semibold"></div>
          <div id="profileEmail" class="text-slate-400"></div>
        </div>
        <form class="space-y-4" onsubmit="updateProfile(event)">
          <input id="newProfileName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
          <input id="newProfileStatus" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500" placeholder="–°—Ç–∞—Ç—É—Å">
          <button type="submit" class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
        <button class="w-full mt-3 py-3 bg-red-500/15 text-red-300 rounded-xl font-medium hover:bg-red-500/25" onclick="logout()">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- App Settings Modal -->
    <div id="appSettingsModal" class="modal" onclick="modalBackdropClose(event, 'appSettingsModal')">
      <div class="sheet p-6 max-h-[90vh] overflow-auto scrollbar">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <button class="icon-btn" onclick="closeModal('appSettingsModal')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <div class="space-y-6">
          <!-- –¢–µ–º–∞ -->
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-3">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</label>
            <div class="grid grid-cols-3 gap-2">
              <button type="button" onclick="setTheme('dark')" id="themeDark" class="theme-btn p-3 rounded-xl border-2 border-white/10 hover:border-violet-500 transition-all">
                <div class="w-full h-16 rounded-lg mb-2" style="background: linear-gradient(135deg, #0b1220 0%, #1e293b 100%);"></div>
                <div class="text-xs font-medium">–¢—ë–º–Ω–∞—è</div>
              </button>
              <button type="button" onclick="setTheme('light')" id="themeLight" class="theme-btn p-3 rounded-xl border-2 border-white/10 hover:border-violet-500 transition-all">
                <div class="w-full h-16 rounded-lg mb-2" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);"></div>
                <div class="text-xs font-medium">–°–≤–µ—Ç–ª–∞—è</div>
              </button>
              <button type="button" onclick="setTheme('auto')" id="themeAuto" class="theme-btn p-3 rounded-xl border-2 border-white/10 hover:border-violet-500 transition-all">
                <div class="w-full h-16 rounded-lg mb-2" style="background: linear-gradient(90deg, #0b1220 0%, #0b1220 50%, #f8fafc 50%, #f8fafc 100%);"></div>
                <div class="text-xs font-medium">–ê–≤—Ç–æ</div>
              </button>
            </div>
          </div>

          <!-- –ú–∏–∫—Ä–æ—Ñ–æ–Ω -->
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">–ú–∏–∫—Ä–æ—Ñ–æ–Ω</label>
            <select id="microphoneSelect" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500" onchange="saveMicrophonePreference()">
              <option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
            </select>
            <button type="button" onclick="testMicrophone()" class="mt-2 w-full py-2 bg-white/5 rounded-xl text-sm hover:bg-white/10 transition-all">
              üé§ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
            </button>
          </div>

          <!-- –ö–∞–º–µ—Ä–∞ -->
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">–ö–∞–º–µ—Ä–∞</label>
            <select id="cameraSelect" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500" onchange="saveCameraPreference()">
              <option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
            </select>
            <button type="button" onclick="testCamera()" class="mt-2 w-full py-2 bg-white/5 rounded-xl text-sm hover:bg-white/10 transition-all">
              üìπ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–º–µ—Ä—É
            </button>
          </div>

          <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
            <div class="space-y-2">
              <label class="flex items-center gap-3 p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition-all">
                <input type="checkbox" id="soundNotifications" onchange="saveNotificationSettings()" class="w-5 h-5 rounded accent-violet-600">
                <div class="flex-1">
                  <div class="text-sm font-medium">–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                  <div class="text-xs text-slate-400">–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –∑–≤—É–∫ –ø—Ä–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</div>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition-all">
                <input type="checkbox" id="desktopNotifications" onchange="saveNotificationSettings()" class="w-5 h-5 rounded accent-violet-600">
                <div class="flex-1">
                  <div class="text-sm font-medium">–°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                  <div class="text-xs text-slate-400">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ</div>
                </div>
              </label>
            </div>
          </div>

          <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
          <div class="pt-4 border-t border-white/10">
            <div class="text-center text-sm text-slate-400">
              <div class="mb-2">FlashChat Pro v2.0</div>
              <div class="text-xs">¬© 2025 –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Microphone Test Modal -->
    <div id="micTestModal" class="modal" onclick="modalBackdropClose(event, 'micTestModal')">
      <div class="sheet p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-bold">–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</h3>
          <button class="icon-btn" onclick="closeModal('micTestModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="text-center">
          <div class="w-32 h-32 mx-auto mb-4 rounded-full bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center">
            <svg id="micTestIcon" class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
          </div>
          <div id="micTestLevel" class="h-4 bg-white/10 rounded-full overflow-hidden mb-4">
            <div id="micTestBar" class="h-full bg-gradient-to-r from-green-500 to-violet-500 transition-all duration-100" style="width:0%"></div>
          </div>
          <p id="micTestStatus" class="text-slate-400 mb-4">–ì–æ–≤–æ—Ä–∏—Ç–µ –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω...</p>
          <button onclick="stopMicTest()" class="px-6 py-2 bg-red-500/20 text-red-300 rounded-xl hover:bg-red-500/30">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Camera Test Modal -->
    <div id="cameraTestModal" class="modal" onclick="modalBackdropClose(event, 'cameraTestModal')">
      <div class="sheet p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-bold">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–º–µ—Ä—ã</h3>
          <button class="icon-btn" onclick="closeModal('cameraTestModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="text-center">
          <video id="cameraTestVideo" autoplay playsinline class="w-full max-w-md mx-auto rounded-xl bg-black mb-4" style="max-height:400px;"></video>
          <p class="text-slate-400 mb-4">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∫–∞–º–µ—Ä—ã</p>
          <button onclick="stopCameraTest()" class="px-6 py-2 bg-red-500/20 text-red-300 rounded-xl hover:bg-red-500/30">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Settings Modal (group/channel) -->
    <div id="settingsModal" class="modal" onclick="modalBackdropClose(event, 'settingsModal')">
      <div class="sheet p-6 max-h-[90vh] overflow-auto scrollbar">
        <div class="flex justify-between items-center mb-6">
          <h3 id="settingsTitle" class="text-xl font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <button class="icon-btn" onclick="closeModal('settingsModal')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <div class="space-y-4">
          <!-- Avatar upload -->
          <div class="flex justify-center mb-4">
            <div class="avatar-upload">
              <div id="settingsAvatar" class="chat-avatar chat-avatar-lg gradient-bg cursor-pointer">
                <span id="settingsAvatarLetter"></span>
                <img id="settingsAvatarImg" src="" class="hidden" alt="avatar">
              </div>
              <input type="file" id="settingsAvatarInput" accept="image/*" onchange="handleAvatarSelect(event)">
              <div class="avatar-upload-overlay">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </div>
            </div>
          </div>
          <p class="text-center text-xs text-slate-400 -mt-2 mb-4">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏</p>

          <div>
            <label class="block text-sm text-slate-400 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input id="settingsName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
          </div>

          <div id="settingsDescriptionBlock">
            <label class="block text-sm text-slate-400 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="settingsDescription" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500 resize-none h-24"></textarea>
          </div>

          <div id="settingsMembersBlock">
            <label class="block text-sm text-slate-400 mb-2">–£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="settingsMemberCount">0</span>)</label>
            <div id="settingsMembersList" class="space-y-2 max-h-56 overflow-auto scrollbar"></div>
          </div>

          <button class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="w-full py-3 bg-red-500/15 text-red-300 rounded-xl font-medium hover:bg-red-500/25" onclick="deleteGroupOrChannel()"><span id="deleteButtonText">–£–¥–∞–ª–∏—Ç—å</span></button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ====== CONFIG ======
    const IMGBB_API_KEY = 'f457bea1a8c6cf16c4a03634c8ea3177';

    const DEVELOPER_EMAILS = [
      'stepanu142z@gmail.com',
      'Stepan42z@yandex.ru'
    ];

    function isDeveloper(email){
      if(!email) return false;
      return DEVELOPER_EMAILS.some(e => e.toLowerCase() === String(email).toLowerCase());
    }

    function getDevBadgeHtml(){
      return `<span class="dev-badge"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>DEV</span>`;
    }

    function getNameWithBadge(name, email){
      const safeName = escapeHtml(name || '');
      return isDeveloper(email) ? safeName + ' ' + getDevBadgeHtml() : safeName;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBeLAiCwZjij3d6FZ4OzylJnaxPwlyf1Ag",
      authDomain: "webchat-28b64.firebaseapp.com",
      databaseURL: "https://webchat-28b64-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "webchat-28b64",
      storageBucket: "webchat-28b64.firebasestorage.app",
      messagingSenderId: "307131215178",
      appId: "1:307131215178:web:0e510297256e30959825b3",
      measurementId: "G-JD21B447LF"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    // Storage disabled - using tmpfiles.org/catbox.moe for file uploads
    // const storage = firebase.storage();

    // ====== STATE ======
    let currentUser = null;
    let currentUserData = null;
    let currentChat = null;
    let currentChatType = null;
    let currentChatData = null;
    let typingTimeout = null;
    let unreadCounts = {};
    let selectedGroupMembers = [];
    let currentMessageId = null;
    let currentTab = 'all';
    let allChats = [];
    let allUsers = {};
    let toastChatId = null;
    let pendingFile = null;
    let uploadTask = null;
    let isUploading = false;
    let pendingAvatarFile = null;
    let notificationSound = null;
    let audioContext = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = null;
    let recordingInterval = null;
    let currentPlayingAudio = null;

    // ====== NOTIFICATION SOUND ======
    function initNotificationSound() {
      try {
        // –°–æ–∑–¥–∞—ë–º AudioContext –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–≤—É–∫–∞
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        notificationSound = true;
        console.log('Notification sound initialized');
      } catch(e) {
        console.warn('Web Audio API not supported:', e);
        notificationSound = false;
      }
    }

    function playNotificationSound() {
      if (!audioContext || !notificationSound) return;
      
      try {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º AudioContext –µ—Å–ª–∏ –æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }

        // –°–æ–∑–¥–∞—ë–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–¥–≤–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ç–æ–Ω–∞ –∫–∞–∫ –≤ Telegram)
        const now = audioContext.currentTime;
        
        // –ü–µ—Ä–≤—ã–π —Ç–æ–Ω
        const osc1 = audioContext.createOscillator();
        const gain1 = audioContext.createGain();
        osc1.connect(gain1);
        gain1.connect(audioContext.destination);
        osc1.frequency.value = 880; // –ù–æ—Ç–∞ A5
        osc1.type = 'sine';
        gain1.gain.setValueAtTime(0.3, now);
        gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc1.start(now);
        osc1.stop(now + 0.1);

        // –í—Ç–æ—Ä–æ–π —Ç–æ–Ω (—á—É—Ç—å –≤—ã—à–µ)
        const osc2 = audioContext.createOscillator();
        const gain2 = audioContext.createGain();
        osc2.connect(gain2);
        gain2.connect(audioContext.destination);
        osc2.frequency.value = 1100; // –ù–æ—Ç–∞ C#6
        osc2.type = 'sine';
        gain2.gain.setValueAtTime(0.3, now + 0.12);
        gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
        osc2.start(now + 0.12);
        osc2.stop(now + 0.25);

      } catch(e) {
        console.warn('Error playing notification sound:', e);
      }
    }

    // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function requestNotificationPermission() {
      if (!('Notification' in window)) {
        console.log('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
        return;
      }
      
      if (Notification.permission === 'default') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        showNotificationPrompt();
      }
    }

    function showNotificationPrompt() {
      // –°–æ–∑–¥–∞—ë–º –∫—Ä–∞—Å–∏–≤—ã–π –±–∞–Ω–Ω–µ—Ä –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
      const banner = document.createElement('div');
      banner.id = 'notificationBanner';
      banner.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 1000;
        box-shadow: 0 10px 40px rgba(102,126,234,0.4);
        max-width: 90%;
        animation: slideDown 0.3s ease;
      `;
      banner.innerHTML = `
        <svg width="24" height="24" fill="white" viewBox="0 0 24 24">
          <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/>
        </svg>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;font-size:14px;">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?</div>
          <div style="font-size:12px;opacity:0.9;">–£–∑–Ω–∞–≤–∞–π—Ç–µ –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</div>
        </div>
        <button id="allowNotifBtn" style="background:white;color:#667eea;border:none;padding:8px 16px;border-radius:10px;font-weight:600;font-size:13px;cursor:pointer;">
          –í–∫–ª—é—á–∏—Ç—å
        </button>
        <button id="denyNotifBtn" style="background:transparent;color:white;border:1px solid rgba(255,255,255,0.3);padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">
          –ü–æ–∑–∂–µ
        </button>
      `;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideDown {
          from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
          to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(banner);
      
      document.getElementById('allowNotifBtn').onclick = async () => {
        try {
          const permission = await Notification.requestPermission();
          console.log('Notification permission:', permission);
          if (permission === 'granted') {
            showToast('üîî', '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', '–í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö');
          }
        } catch(e) {
          console.error('Error requesting notification permission:', e);
        }
        banner.remove();
      };
      
      document.getElementById('denyNotifBtn').onclick = () => {
        banner.remove();
        // –ó–∞–ø–æ–º–Ω–∏–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è (–Ω–∞ 24 —á–∞—Å–∞)
        localStorage.setItem('notifPromptDismissed', Date.now().toString());
      };
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        if (document.getElementById('notificationBanner')) {
          banner.remove();
        }
      }, 15000);
    }

    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∞—É–¥–∏–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function unlockAudio() {
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
      // –£–¥–∞–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
      document.removeEventListener('click', unlockAudio);
      document.removeEventListener('touchstart', unlockAudio);
      document.removeEventListener('keydown', unlockAudio);
    }

    document.addEventListener('click', unlockAudio);
    document.addEventListener('touchstart', unlockAudio);
    document.addEventListener('keydown', unlockAudio);

    // ====== EMOJI DATA (large, TG-like categories) ======
    const EMOJI = {
      smileys: "üòÄ üòÉ üòÑ üòÅ üòÜ üòÖ üòÇ ü§£ üòä üòá üôÇ üôÉ üòâ üòå üòç ü•∞ üòò üòó üòô üòö üòã üòõ üòù üòú ü§™ ü§® üßê ü§ì üòé ü•∏ ü§© ü•≥ üòè üòí üòû üòî üòü üòï üôÅ ‚òπÔ∏è üò£ üòñ üò´ üò© ü•∫ üò¢ üò≠ üò§ üò† üò° ü§¨ üò≥ ü•µ ü•∂ üò± üò® üò∞ üò• üòì ü§ó ü§≠ ü§´ ü§î ü§ê üòê üòë üò∂ ü´• üò¨ üôÑ üòØ üò¶ üòß üòÆ üò≤ ü•± üò¥ ü§§ üò™ üòµ ü§Ø ü§† ü•¥ ü§Æ ü§¢ ü§ß ü§í ü§ï ü´† ü´°".split(" "),
      gestures: "üëã ü§ö üñêÔ∏è ‚úã üññ üëå ü§å ü§è ‚úåÔ∏è ü§û ü§ü ü§ò ü§ô ü´µ üëà üëâ üëÜ üñï üëá ‚òùÔ∏è üëç üëé ‚úä üëä ü§õ ü§ú üëè üôå üëê ü§≤ ü§ù üôè ‚úçÔ∏è üíÖ ü§≥ üí™ ü¶æ ü¶ø ü¶µ ü¶∂ üëÇ ü¶ª üëÉ üß† ü´Ä ü´Å üëÄ üëÅÔ∏è üëÖ üëÑ üíã".split(" "),
      animals: "üê∂ üê± üê≠ üêπ üê∞ ü¶ä üêª üêº üêª‚Äç‚ùÑÔ∏è üê® üêØ ü¶Å üêÆ üê∑ üêΩ üê∏ üêµ üôà üôâ üôä üêí üêî üêß üê¶ üê§ üê£ üê• ü¶Ü ü¶Ö ü¶â ü¶á üê∫ üêó üê¥ ü¶Ñ üêù ü™≤ üêõ ü¶ã üêå üêû üêú ü¶ü ü™∞ ü™± üê¢ üêç ü¶é üêô ü¶ë ü¶ê ü¶û ü¶Ä üê° üê† üêü üê¨ üê≥ üêã ü¶à üêä".split(" "),
      food: "üçè üçé üçê üçä üçã üçå üçâ üçá üçì ü´ê üçà üçí üçë ü•≠ üçç ü•• ü•ù üçÖ ü•ë üçÜ ü•î ü•ï üåΩ üå∂Ô∏è ü´ë ü•í ü•¨ ü•¶ üßÑ üßÖ üçÑ ü•ú ü´ò üå∞ üçû ü•ê ü•ñ ü´ì ü•® üßÄ ü•ö üç≥ üßà ü•û üßá ü•ì ü•© üçó üçñ üå≠ üçî üçü üçï ü•™ ü•ô üßÜ üåÆ üåØ ü•ó ü•ò üçù üçú üç≤ üçõ üç£ üç± üçô üçö üçò üç• ü•ü ü•† ü•° üç¢ üç° üçß üç® üç¶ ü•ß üßÅ üç∞ üéÇ üçÆ üç≠ üç¨ üç´ üçø üç© üç™ ‚òï üçµ üßÉ ü•§ üßã üç∫ üçª ü•Ç üç∑ üç∏ üçπ üßâ".split(" "),
      activities: "‚öΩ üèÄ üèà ‚öæ ü•é üéæ üèê üèâ ü•è üé± ü™Ä üèì üè∏ üèí üèë ü•ç üèè ‚õ≥ ü™Å üèπ üé£ ü§ø ü•ä ü•ã üéΩ üõπ üõ∑ ‚õ∏Ô∏è ü•å üéø ‚õ∑Ô∏è üèÇ üèãÔ∏è ü§º ü§∏ ‚õπÔ∏è ü§∫ üèá üßò üèÑ üèä üö¥ üöµ üßó üé™ üé≠ üé® üé¨ üé§ üéß üéº üéπ ü•Å üé∑ üé∫ üé∏ üéª üé≤ ‚ôüÔ∏è üéØ üé≥ üéÆ üïπÔ∏è üé∞ üß©".split(" "),
      travel: "üöó üöï üöô üöå üöé üèéÔ∏è üöì üöë üöí üöê üõª üöö üöõ üöú üèçÔ∏è üõµ üö≤ üõ¥ üöÅ ‚úàÔ∏è üõ©Ô∏è üöÄ üõ∏ üö¢ ‚õµ üö§ üõ•Ô∏è üöÇ üöÉ üöÑ üöÖ üöÜ üöá üöà üöâ üó∫Ô∏è üß≠ üèîÔ∏è ‚õ∞Ô∏è üåã üóª üèïÔ∏è üèñÔ∏è üèúÔ∏è üèùÔ∏è üèüÔ∏è üèõÔ∏è üèóÔ∏è üß± üè† üè° üè¢ üè£ üè• üè¶ üè® üè© üè™ üè´ üè¨ üè≠ üóº üóΩ ‚õ™ üïå üõï ‚õ©Ô∏è üåâ üåå üå†".split(" "),
      objects: "‚åö üì± üíª ‚å®Ô∏è üñ•Ô∏è üñ®Ô∏è üñ±Ô∏è üñ≤Ô∏è üíΩ üíæ üíø üìÄ üì∑ üì∏ üìπ üé• üìΩÔ∏è üì∫ üìª üéôÔ∏è üéöÔ∏è üéõÔ∏è üìû ‚òéÔ∏è üìü üì† üîã üîå üí° üî¶ üïØÔ∏è ü™î üßØ üõ¢Ô∏è üí∏ üíµ üí¥ üí∂ üí∑ üí∞ üí≥ üíé ‚öñÔ∏è üîß üî® ‚öíÔ∏è üõ†Ô∏è ‚õèÔ∏è ü™ì üî© ‚öôÔ∏è üóúÔ∏è üîó ‚õìÔ∏è üß∞ üß≤ üîí üîì üîë üóùÔ∏è üîê üß≥ üì¶ üì´ üì¨ üì≠ üìÆ ‚úâÔ∏è üìß üì® üìù üìÅ üìÇ üóÇÔ∏è üìÖ üìÜ üìä üìà üìâ üìã üìå üìç".split(" "),
      symbols: "‚ù§Ô∏è üß° üíõ üíö üíô üíú üñ§ ü§ç ü§é üíî ‚ù£Ô∏è üíï üíû üíì üíó üíñ üíò üíù üíü ‚òÆÔ∏è ‚úùÔ∏è ‚ò™Ô∏è üïâÔ∏è ‚òØÔ∏è ‚ú°Ô∏è üîØ ‚ôà ‚ôâ ‚ôä ‚ôã ‚ôå ‚ôç ‚ôé ‚ôè ‚ôê ‚ôë ‚ôí ‚ôì ‚õé üîÄ üîÅ üîÇ ‚ñ∂Ô∏è ‚è© ‚è≠Ô∏è ‚èØÔ∏è ‚óÄÔ∏è ‚è™ üîº ‚è´ üîΩ ‚è¨ ‚è∏Ô∏è ‚èπÔ∏è ‚è∫Ô∏è üîÜ üîÖ üì∂ üì≥ üì¥ ‚úñÔ∏è ‚ûï ‚ûñ ‚ûó ‚ôæÔ∏è üí≤ üí± ‚Ñ¢Ô∏è ¬©Ô∏è ¬ÆÔ∏è „Ä∞Ô∏è ‚û∞ ‚ûø ‚úîÔ∏è ‚òëÔ∏è üîò üî¥ üü† üü° üü¢ üîµ üü£ ‚ö´ ‚ö™ üü§ üî∫ üîª üî∏ üîπ üî∂ üî∑ üî≥ üî≤ ‚ñ™Ô∏è ‚ñ´Ô∏è ‚óæ ‚óΩ ‚¨õ ‚¨ú üîî üîï üîä üîá üí¨ üí≠ üóØÔ∏è üî• ‚ú® üéâ üíØ ‚≠ê üåü üí´ ‚ö° üí• üéä üéÅ üèÜ ü•á ü•à ü•â üèÖ üéñÔ∏è üéóÔ∏è".split(" ")
    };

    // ====== UI HELPERS ======
    function $(id){ return document.getElementById(id); }

    function showModal(id){ $(id).classList.add('show'); }
    function closeModal(id){ $(id).classList.remove('show'); }

    function modalBackdropClose(e, id){
      if(e.target && e.target.id === id) closeModal(id);
    }

    function showToast(icon, title, msg, chatId=null){
      toastChatId = chatId;
      $('toastIcon').textContent = icon;
      $('toastTitle').textContent = title;
      $('toastMessage').textContent = msg;
      const t = $('toast');
      t.classList.remove('hidden');
      clearTimeout(t._timer);
      t._timer = setTimeout(()=> t.classList.add('hidden'), 4000);
    }

    function handleToastClick(){
      $('toast').classList.add('hidden');
      if(toastChatId){
        const chat = allChats.find(c => c.id === toastChatId);
        if(chat) openChat(toastChatId, chat.type);
      }
    }

    function escapeHtml(text){
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    function formatTime(ts){
      if(!ts) return '';
      const d = new Date(ts);
      const now = new Date();
      if(d.toDateString() === now.toDateString()){
        return d.toLocaleTimeString('ru-RU',{hour:'2-digit', minute:'2-digit'});
      }
      return d.toLocaleDateString('ru-RU',{day:'numeric', month:'short'});
    }

    function formatLastSeen(ts){
      if(!ts) return '–¥–∞–≤–Ω–æ';
      const diff = Date.now() - ts;
      if(diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
      if(diff < 3600000) return `${Math.floor(diff/60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
      if(diff < 86400000) return `${Math.floor(diff/3600000)} —á –Ω–∞–∑–∞–¥`;
      return new Date(ts).toLocaleDateString('ru-RU');
    }

    // ====== AUTH UI ======
    function showTab(tab){
      $('loginForm').classList.toggle('hidden', tab !== 'login');
      $('registerForm').classList.toggle('hidden', tab !== 'register');
      $('loginTab').classList.toggle('bg-violet-600', tab === 'login');
      $('loginTab').classList.toggle('text-white', tab === 'login');
      $('loginTab').classList.toggle('text-slate-400', tab !== 'login');
      $('registerTab').classList.toggle('bg-violet-600', tab === 'register');
      $('registerTab').classList.toggle('text-white', tab === 'register');
      $('registerTab').classList.toggle('text-slate-400', tab !== 'register');
    }

    function getErrorMessage(code){
      const messages = {
        'auth/email-already-in-use': 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è',
        'auth/invalid-email': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email',
        'auth/weak-password': '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)',
        'auth/user-not-found': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω',
        'auth/wrong-password': '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',
        'auth/invalid-credential': '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å',
        'auth/too-many-requests': '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ',
        'auth/network-request-failed': '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç',
        'auth/operation-not-allowed': '–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞',
        'auth/user-disabled': '–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω',
        'auth/requires-recent-login': '–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥',
        'auth/missing-password': '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å',
        'auth/missing-email': '–í–≤–µ–¥–∏—Ç–µ email'
      };
      return messages[code] || null;
    }

    function showAuthError(msg){
      const el = $('authError');
      el.textContent = msg;
      el.classList.remove('hidden');
      clearTimeout(el._timer);
      el._timer = setTimeout(()=> el.classList.add('hidden'), 4000);
    }

    // Accounts storage
    function loadSavedAccounts(){
      const accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      const container = $('savedAccounts');
      const list = $('accountsList');

      if(accounts.length){
        container.classList.remove('hidden');
        list.innerHTML = accounts.map(acc => {
          const nameWithBadge = isDeveloper(acc.email) ? escapeHtml(acc.name||acc.email) + ' ' + getDevBadgeHtml() : escapeHtml(acc.name||acc.email);
          return `
            <div class="flex items-center gap-3 p-2 rounded-xl bg-white/5 border border-white/10">
              <div class="w-8 h-8 gradient-bg rounded-full grid place-items-center font-bold text-sm">${escapeHtml((acc.name||'?').charAt(0).toUpperCase())}</div>
              <div class="flex-1 min-w-0">
                <div class="font-medium text-sm truncate">${nameWithBadge}</div>
                <div class="text-xs text-slate-400 truncate">${escapeHtml(acc.email)}</div>
              </div>
              <button class="text-xs bg-violet-600 px-2 py-1 rounded-lg" onclick="quickLogin('${escapeHtml(acc.email)}','${escapeHtml(acc.password)}')">–í–æ–π—Ç–∏</button>
              <button class="text-slate-400 hover:text-red-300 p-1" onclick="removeAccount('${escapeHtml(acc.email)}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          `;
        }).join('');
      } else {
        container.classList.add('hidden');
        list.innerHTML = '';
      }
    }

    function saveAccount(email,password,name){
      let accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      accounts = accounts.filter(a => a.email !== email);
      accounts.unshift({email,password,name});
      if(accounts.length > 5) accounts = accounts.slice(0,5);
      localStorage.setItem('flashchat_accounts', JSON.stringify(accounts));
    }

    function removeAccount(email){
      let accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      accounts = accounts.filter(a => a.email !== email);
      localStorage.setItem('flashchat_accounts', JSON.stringify(accounts));
      loadSavedAccounts();
    }

    function quickLogin(email,password){
      $('loginEmail').value = email;
      $('loginPassword').value = password;
      login(new Event('submit'));
    }

    // ====== NAV ======
    function showAuthScreen(){
      $('authScreen').style.display = 'block';
      $('chatScreen').classList.remove('active');
      $('chatScreen').style.display = 'none';
    }

    function showChatScreen(){
      $('authScreen').style.display = 'none';
      $('chatScreen').style.display = '';
      $('chatScreen').classList.add('active');

      // reset panels
      $('sidebar').style.display = 'flex';
      $('chatArea').classList.remove('active');
      $('chatArea').style.display = window.innerWidth <= 768 ? 'none' : 'flex';

      $('emptyChat').style.display = 'flex';
      $('activeChat').classList.remove('active');

      renderChatList();
    }

    function clearAllData(){
      // –û—á–∏—â–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      currentChat = null;
      currentChatType = null;
      currentChatData = null;
      allChats = [];
      allUsers = {};
      unreadCounts = {};
      avatarCache.clear();
      
      // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –≤—Å–µ—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
      database.ref('users').off();
      if(currentUser){
        database.ref(`userChats/${currentUser.uid}`).off();
        database.ref(`messages/${currentChat}`).off();
      }
      
      // –û—á–∏—â–∞–µ–º UI
      showLoadingChats();
      $('messagesContainer').innerHTML = '';
      $('activeChat').classList.remove('active');
      $('emptyChat').style.display = 'flex';
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
      ['createMenuModal','newPrivateChatModal','createGroupModal','createChannelModal','accountSwitcherModal','profileModal','appSettingsModal','settingsModal','editMessageModal','micTestModal','cameraTestModal'].forEach(id => {
        const modal = $(id);
        if(modal) modal.classList.remove('show');
      });
    }

    function showLoadingChats(){
      $('chatList').innerHTML = `
        <div class="p-6 text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center animate-pulse">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
          </div>
          <div class="text-slate-400 font-medium mb-2">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</div>
          <div class="text-sm text-slate-500">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
        </div>
      `;
    }

    function closeChat(){
      const prevChat = currentChat;
      currentChat = null;
      currentChatType = null;
      currentChatData = null;

      // Stop listeners for messages + typing
      if(prevChat){
        database.ref(`messages/${prevChat}`).off();
        database.ref(`typing/${prevChat}`).off();
      }

      $('activeChat').classList.remove('active');
      $('emptyChat').style.display = 'flex';

      if(window.innerWidth <= 768){
        $('chatArea').classList.remove('active');
        $('chatArea').style.display = 'none';
        $('sidebar').style.display = 'flex';
      }
    }

    // ====== FIREBASE auth ======
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    initNotificationSound();
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    requestNotificationPermission();

    auth.onAuthStateChanged(async user => {
      if(user){
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–∞–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const banSnap = await database.ref(`bannedUsers/${user.uid}`).once('value');
        if(banSnap.exists()){
          const banData = banSnap.val();
          showToast('üö´', '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º');
          await auth.signOut();
          return;
        }
        
        // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        clearAllData();
        
        currentUser = user;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —á–∞—Ç–∞ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
        showChatScreen();
        showLoadingChats();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        await loadUserData();
        await loadAllUsers();
        
        updateOnlineStatus(true);
        setupPresenceOnDisconnect();
        loadAllChats();
        setupNotificationListener();
        
        // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—Ä–∞–∂–∞—Ç—å)
        setTimeout(() => {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫–∞–∑–∞–ª—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–Ω–µ–µ
          const dismissed = localStorage.getItem('notifPromptDismissed');
          if (dismissed) {
            const dismissedTime = parseInt(dismissed);
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
            if (Date.now() - dismissedTime < 24 * 60 * 60 * 1000) {
              return;
            }
          }
          
          if ('Notification' in window && Notification.permission === 'default') {
            showNotificationPrompt();
          }
        }, 3000); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
      } else {
        currentUser = null;
        currentUserData = null;
        showAuthScreen();
      }
    });

    async function login(e){
      e.preventDefault();
      const email = $('loginEmail').value.trim();
      const password = $('loginPassword').value;
      const save = $('saveAccount').checked;

      if(!email) return showAuthError('–í–≤–µ–¥–∏—Ç–µ email');
      if(!password) return showAuthError('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');

      try{
        console.log('Logging in:', email);
        await auth.signInWithEmailAndPassword(email, password);
        console.log('Login successful');
        
        if(save){
          const snap = await database.ref(`users/${auth.currentUser.uid}`).once('value');
          const userData = snap.val();
          saveAccount(email, password, userData?.name || email);
          loadSavedAccounts();
        }
      } catch(err){
        console.error('Login error:', err);
        showAuthError(getErrorMessage(err.code) || err.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
      }
    }

    async function register(e){
      e.preventDefault();
      const name = $('registerName').value.trim();
      const email = $('registerEmail').value.trim();
      const password = $('registerPassword').value;
      
      if(!name) return showAuthError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
      if(!email) return showAuthError('–í–≤–µ–¥–∏—Ç–µ email');
      if(!password || password.length < 6) return showAuthError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');

      try{
        console.log('Registering user:', email);
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        console.log('User created:', cred.user.uid);
        
        await database.ref(`users/${cred.user.uid}`).set({
          name,
          nameLower: name.toLowerCase(),
          email,
          status: '–ü—Ä–∏–≤–µ—Ç! –Ø –∏—Å–ø–æ–ª—å–∑—É—é FlashChat',
          online: true,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });
        console.log('User data saved to database');
        
        saveAccount(email, password, name);
        loadSavedAccounts();
        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!');
      } catch(err){
        console.error('Registration error:', err);
        showAuthError(getErrorMessage(err.code) || err.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
      }
    }

    function logout(){
      updateOnlineStatus(false);
      auth.signOut();
      closeModal('profileModal');
    }

    async function loadUserData(){
      const snap = await database.ref(`users/${currentUser.uid}`).once('value');
      currentUserData = snap.val() || {};
    }

    async function loadAllUsers(){
      // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å
      database.ref('users').off('value');
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π
      database.ref('users').on('value', snap => {
        const users = snap.val() || {};
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–∫
        Object.keys(users).forEach(uid => {
          const oldUser = allUsers[uid];
          const newUser = users[uid];
          
          // –ï—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –æ—á–∏—â–∞–µ–º –∫—ç—à
          if(oldUser && newUser && oldUser.avatarUrl !== newUser.avatarUrl){
            if(oldUser.avatarUrl) avatarCache.delete(oldUser.avatarUrl);
            if(newUser.avatarUrl) avatarCache.delete(newUser.avatarUrl);
          }
        });
        
        allUsers = users;
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –µ—Å–ª–∏ –æ–Ω —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        if(allChats.length > 0){
          renderChatList();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –≤ —à–∞–ø–∫–µ —á–∞—Ç–∞ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
          if(currentChat && currentChatType === 'private' && currentChatData){
            const chatData = allChats.find(c => c.id === currentChat);
            if(chatData && chatData.avatarUrl){
              const avatarEl = $('chatAvatar');
              loadAvatar(chatData.avatarUrl).then(loadedUrl => {
                if(loadedUrl){
                  avatarEl.innerHTML = `<img src="${loadedUrl}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                }
              }).catch(err => console.error('Error updating chat avatar:', err));
            }
          }
        }
      });
    }

    function updateOnlineStatus(status){
      if(!currentUser) return;
      database.ref(`users/${currentUser.uid}`).update({
        online: status,
        lastSeen: firebase.database.ServerValue.TIMESTAMP
      });
    }

    function setupPresenceOnDisconnect(){
      database.ref(`users/${currentUser.uid}/online`).onDisconnect().set(false);
      database.ref(`users/${currentUser.uid}/lastSeen`).onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
    }

    // ====== CHAT LIST ======
    function showChatTab(tab){
      currentTab = tab;
      ['all','private','groups','channels'].forEach(t => {
        const el = $('tab' + t.charAt(0).toUpperCase() + t.slice(1));
        el.classList.toggle('bg-violet-600', t === tab);
        el.classList.toggle('text-white', t === tab);
        el.classList.toggle('text-slate-400', t !== tab);
      });
      renderChatList();
    }

    function loadAllChats(){
      // prevent duplicates
      database.ref(`userChats/${currentUser.uid}`).off('value');

      database.ref(`userChats/${currentUser.uid}`).on('value', async snapshot => {
        const chats = snapshot.val() || {};
        const processed = new Set();
        const list = [];

        for(const [chatId, chatData] of Object.entries(chats)){
          if(processed.has(chatId)) continue;
          processed.add(chatId);

          try{
            let chatInfo = { id: chatId, ...chatData, unread:0 };

            // last message
            const msgSnap = await database.ref(`messages/${chatId}`).orderByChild('timestamp').limitToLast(1).once('value');
            const msgs = msgSnap.val();
            if(msgs){
              const lastMsg = Object.values(msgs)[0];
              chatInfo.lastMessage = lastMsg.text || (lastMsg.fileUrl ? 'üìé –§–∞–π–ª' : '');
              chatInfo.lastTime = lastMsg.timestamp;
              chatInfo.lastSenderId = lastMsg.senderId;
            }

            // unread count
            const unreadSnap = await database.ref(`messages/${chatId}`).orderByChild('timestamp').once('value');
            const allMsgs = unreadSnap.val() || {};
            let unread = 0;
            for(const msg of Object.values(allMsgs)){
              if(msg.senderId !== currentUser.uid && (!msg.readBy || !msg.readBy[currentUser.uid])) unread++;
            }
            chatInfo.unread = unread;
            unreadCounts[chatId] = unread;

            if(chatData.type === 'private'){
              const userData = allUsers[chatData.oderId];
              if(userData){
                chatInfo.name = userData.name;
                chatInfo.email = userData.email;
                chatInfo.online = userData.online;
                chatInfo.avatar = (userData.name || '?').charAt(0).toUpperCase();
                chatInfo.avatarUrl = userData.avatarUrl || null;
              }
            } else if(chatData.type === 'group' || chatData.type === 'channel'){
              try {
                const snap = await database.ref(`${chatData.type}s/${chatId}`).once('value');
                const data = snap.val();
                if(data){
                  chatInfo.name = data.name;
                  chatInfo.avatar = (data.name || '?').charAt(0).toUpperCase();
                  chatInfo.avatarUrl = data.avatarUrl || null;
                  chatInfo.members = data.members;
                  chatInfo.owner = data.owner;
                  chatInfo.description = data.description;
                }
              } catch(err) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç —Å –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                chatInfo.name = chatData.name || '–ß–∞—Ç';
                chatInfo.avatar = '?';
              }
            } else {
              // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
              chatInfo.name = chatData.name || '–ß–∞—Ç';
              chatInfo.avatar = '?';
              chatInfo.type = chatData.type || 'unknown';
            }

            if(chatInfo.name) list.push(chatInfo);
          } catch(err){
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤
          }
        }

        list.sort((a,b) => (b.lastTime || 0) - (a.lastTime || 0));
        allChats = list;
        renderChatList();
      });
    }

    function renderChatList(){
      const container = $('chatList');
      let filtered = allChats;
      if(currentTab !== 'all'){
        const typeMap = { private:'private', groups:'group', channels:'channel' };
        filtered = allChats.filter(c => c.type === typeMap[currentTab]);
      }

      if(!filtered.length){
        container.innerHTML = '<div class="p-6 text-center text-slate-500">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';
        return;
      }

      container.innerHTML = filtered.map(chat => {
        const isActive = currentChat === chat.id;
        const statusDot = (chat.type === 'private' && chat.online) ? 'bg-emerald-500' : 'bg-slate-500';
        const typeIcon = chat.type === 'group' ? 'üë•' : chat.type === 'channel' ? 'üì¢' : '';
        const unreadBadge = chat.unread > 0 ? `<div class="min-w-[20px] h-5 bg-sky-500 rounded-full text-xs flex items-center justify-center px-1">${chat.unread}</div>` : '';
        const lastMsgPrefix = chat.lastSenderId === currentUser?.uid ? '–í—ã: ' : '';
        const gradientClass = chat.type === 'group' ? 'gradient-green' : chat.type === 'channel' ? 'gradient-orange' : 'gradient-bg';
        const titleHtml = chat.type === 'private' ? getNameWithBadge(chat.name, chat.email) : escapeHtml(chat.name);

        // Avatar with image support
        let avatarHtml;
        if(chat.avatarUrl){
          avatarHtml = `<div class="chat-avatar ${gradientClass}" data-avatar-url="${escapeHtml(chat.avatarUrl)}" data-chat-id="${chat.id}"><span>${escapeHtml(chat.avatar || '?')}</span></div>`;
        } else {
          avatarHtml = `<div class="chat-avatar ${gradientClass}">${escapeHtml(chat.avatar || '?')}</div>`;
        }

        return `
          <div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-white/5 transition ${isActive ? 'bg-white/5' : ''}" 
               onclick="openChat('${chat.id}','${chat.type}')"
               oncontextmenu="showChatContextMenu(event, '${chat.id}', '${chat.type}'); return false;"
               ontouchstart="startLongPress(event, '${chat.id}', '${chat.type}')"
               ontouchend="cancelLongPress()"
               ontouchmove="cancelLongPress()">
            <div class="relative shrink-0">
              ${avatarHtml}
              ${chat.type === 'private' ? `<div class="absolute bottom-0 right-0 w-3.5 h-3.5 ${statusDot} rounded-full border-2" style="border-color: rgba(15,23,42,.9)"></div>` : ''}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-center gap-2">
                <div class="font-medium truncate flex items-center gap-2">${typeIcon}<span class="truncate">${titleHtml}</span></div>
                <div class="text-xs text-slate-400 shrink-0">${formatTime(chat.lastTime)}</div>
              </div>
              <div class="flex justify-between items-center gap-2">
                <div class="text-sm text-slate-400 truncate">${escapeHtml(lastMsgPrefix + (chat.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'))}</div>
                ${unreadBadge}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
      document.querySelectorAll('[data-avatar-url]').forEach(async (avatarEl) => {
        const avatarUrl = avatarEl.dataset.avatarUrl;
        if(avatarUrl){
          try {
            const loadedUrl = await loadAvatar(avatarUrl);
            if(loadedUrl){
              const span = avatarEl.querySelector('span');
              if(span) span.style.display = 'none';
              avatarEl.innerHTML += `<img src="${loadedUrl}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
            }
          } catch(err) {
            console.error('Error loading avatar:', err);
          }
        }
      });
    }

    // Search
    function searchAll(){
      const query = $('searchInput').value.toLowerCase();
      const container = $('searchResults');
      if(!query){
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }
      const results = allChats.filter(c => (c.name || '').toLowerCase().includes(query));
      if(!results.length){
        container.innerHTML = '<div class="p-3 text-center text-slate-500">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
      } else {
        container.innerHTML = results.map(chat => {
          const gradientClass = chat.type === 'group' ? 'gradient-green' : chat.type === 'channel' ? 'gradient-orange' : 'gradient-bg';
          const title = chat.type === 'private' ? getNameWithBadge(chat.name, chat.email) : escapeHtml(chat.name);
          return `
            <div class="flex items-center gap-3 p-3 hover:bg-white/5 cursor-pointer" onclick="openChat('${chat.id}','${chat.type}'); $('searchInput').value=''; $('searchResults').classList.add('hidden');">
              <div class="w-10 h-10 rounded-full ${gradientClass} grid place-items-center font-bold">${escapeHtml(chat.avatar || '?')}</div>
              <div class="font-medium truncate">${title}</div>
            </div>
          `;
        }).join('');
      }
      container.classList.remove('hidden');
    }

    // ====== LONG PRESS & DELETE CHAT ======
    let longPressTimer = null;
    let longPressChatId = null;
    let longPressChatType = null;

    function startLongPress(event, chatId, chatType){
      longPressChatId = chatId;
      longPressChatType = chatType;
      longPressTimer = setTimeout(() => {
        showChatContextMenu(event, chatId, chatType);
      }, 500); // 500ms –¥–ª—è –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
    }

    function cancelLongPress(){
      if(longPressTimer){
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
      longPressChatId = null;
      longPressChatType = null;
    }

    async function showChatContextMenu(event, chatId, chatType){
      event.preventDefault();
      event.stopPropagation();
      
      // –í–∏–±—Ä–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
      if(navigator.vibrate){
        navigator.vibrate(50);
      }

      const chat = allChats.find(c => c.id === chatId);
      const chatName = chat?.name || '—ç—Ç–æ—Ç —á–∞—Ç';
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º —á–∞—Ç–æ–º –∏ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å dev
      const isPrivateChat = chatType === 'private';
      const isDev = isDeveloper(currentUserData?.email);
      let otherUserId = null;
      let otherUserData = null;
      let isBanned = false;

      if(isPrivateChat && chat?.oderId){
        otherUserId = chat.oderId;
        otherUserData = allUsers[otherUserId];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–∞–Ω–∞
        if(otherUserId){
          const banSnap = await database.ref(`bannedUsers/${otherUserId}`).once('value');
          isBanned = banSnap.exists();
        }
      }

      const modal = document.createElement('div');
      modal.id = 'chatContextMenu';
      modal.className = 'modal show';
      modal.onclick = (e) => { if(e.target.id === 'chatContextMenu') modal.remove(); };

      let banButton = '';
      if(isDev && isPrivateChat && otherUserId){
        if(isBanned){
          banButton = `
            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl text-green-400" onclick="unbanUser('${otherUserId}', '${escapeHtml(chatName)}')">
              <div class="w-10 h-10 rounded-full grid place-items-center bg-green-500/20">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                <div class="text-xs text-slate-400">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø</div>
              </div>
            </button>
          `;
        } else {
          banButton = `
            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl text-orange-400" onclick="banUser('${otherUserId}', '${escapeHtml(chatName)}')">
              <div class="w-10 h-10 rounded-full grid place-items-center bg-orange-500/20">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                <div class="text-xs text-slate-400">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É</div>
              </div>
            </button>
          `;
        }
      }

      modal.innerHTML = `
        <div class="sheet bottom p-4">
          <h3 class="text-lg font-bold mb-2 text-center">${escapeHtml(chatName)}</h3>
          <p class="text-sm text-slate-400 mb-4 text-center">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</p>
          <div class="space-y-2">
            ${banButton}
            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl text-red-400" onclick="confirmDeleteChat('${chatId}', '${chatType}')">
              <div class="w-10 h-10 rounded-full grid place-items-center bg-red-500/20">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç</div>
                <div class="text-xs text-slate-400">–£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤</div>
              </div>
            </button>
          </div>
          <button class="w-full mt-4 py-2 text-slate-400 hover:text-white" onclick="document.getElementById('chatContextMenu')?.remove()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function confirmDeleteChat(chatId, chatType){
      document.getElementById('chatContextMenu')?.remove();

      const chat = allChats.find(c => c.id === chatId);
      const chatName = chat?.name || '—ç—Ç–æ—Ç —á–∞—Ç';

      const modal = document.createElement('div');
      modal.id = 'deleteConfirmModal';
      modal.className = 'modal show';
      modal.onclick = (e) => { if(e.target.id === 'deleteConfirmModal') modal.remove(); };

      modal.innerHTML = `
        <div class="sheet bottom p-4">
          <h3 class="text-lg font-bold mb-2 text-center text-red-400">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç?</h3>
          <p class="text-sm text-slate-400 mb-4 text-center">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å "${escapeHtml(chatName)}"?</p>
          <div class="flex gap-2">
            <button class="flex-1 py-3 rounded-xl bg-white/5 hover:bg-white/10" onclick="document.getElementById('deleteConfirmModal')?.remove()">–û—Ç–º–µ–Ω–∞</button>
            <button class="flex-1 py-3 rounded-xl bg-red-500 hover:bg-red-600 font-medium" onclick="deleteChat('${chatId}', '${chatType}')">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function deleteChat(chatId, chatType){
      document.getElementById('deleteConfirmModal')?.remove();

      try {
        showToast('‚è≥', '–£–¥–∞–ª–µ–Ω–∏–µ', '–£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞...');

        // –£–¥–∞–ª—è–µ–º —á–∞—Ç –∏–∑ userChats —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await database.ref(`userChats/${currentUser.uid}/${chatId}`).remove();

        // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π —á–∞—Ç, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
        if(currentChat === chatId){
          currentChat = null;
          currentChatType = null;
          currentChatData = null;
          $('emptyChat').style.display = 'flex';
          $('activeChat').classList.remove('active');
          
          // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É —á–∞—Ç–æ–≤
          if(window.innerWidth <= 768){
            $('sidebar').style.display = 'flex';
            $('chatArea').style.display = 'none';
          }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        allChats = allChats.filter(c => c.id !== chatId);
        renderChatList();

        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–ß–∞—Ç —É–¥–∞–ª–µ–Ω');
      } catch(err) {
        console.error('Delete chat error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —á–∞—Ç');
      }
    }

    // ====== BAN/UNBAN USERS (DEV ONLY) ======
    async function banUser(userId, userName){
      document.getElementById('chatContextMenu')?.remove();

      const modal = document.createElement('div');
      modal.id = 'banConfirmModal';
      modal.className = 'modal show';
      modal.onclick = (e) => { if(e.target.id === 'banConfirmModal') modal.remove(); };

      modal.innerHTML = `
        <div class="sheet bottom p-4">
          <h3 class="text-lg font-bold mb-2 text-center text-orange-400">–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</h3>
          <p class="text-sm text-slate-400 mb-3 text-center">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${escapeHtml(userName)}" –Ω–µ —Å–º–æ–∂–µ—Ç –≤—Ö–æ–¥–∏—Ç—å –≤ —á–∞—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
          <textarea id="banReason" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500 resize-none" rows="3" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –±–∞–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
          <div class="flex gap-2">
            <button class="flex-1 py-3 rounded-xl bg-white/5 hover:bg-white/10" onclick="document.getElementById('banConfirmModal')?.remove()">–û—Ç–º–µ–Ω–∞</button>
            <button class="flex-1 py-3 rounded-xl bg-orange-500 hover:bg-orange-600 font-medium" onclick="executeBan('${userId}', '${escapeHtml(userName)}')">–ó–∞–±–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function executeBan(userId, userName){
      const reason = document.getElementById('banReason')?.value.trim() || '–ó–∞–±–∞–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º';
      document.getElementById('banConfirmModal')?.remove();

      try {
        showToast('‚è≥', '–ë–∞–Ω', '–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');

        await database.ref(`bannedUsers/${userId}`).set({
          bannedBy: currentUser.uid,
          bannedAt: firebase.database.ServerValue.TIMESTAMP,
          reason: reason
        });

        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', `${userName} –∑–∞–±–∞–Ω–µ–Ω`);
      } catch(err) {
        console.error('Ban user error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
      }
    }

    async function unbanUser(userId, userName){
      document.getElementById('chatContextMenu')?.remove();

      try {
        showToast('‚è≥', '–†–∞–∑–±–∞–Ω', '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');

        await database.ref(`bannedUsers/${userId}`).remove();

        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', `${userName} —Ä–∞–∑–±–∞–Ω–µ–Ω`);
      } catch(err) {
        console.error('Unban user error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
      }
    }

    // ====== OPEN CHAT ======
    async function openChat(chatId, type){
      // Stop previous listeners
      if(currentChat && currentChat !== chatId){
        if(currentChatType === 'saved'){
          database.ref(`savedMessages/${currentUser.uid}`).off();
        } else {
          database.ref(`messages/${currentChat}`).off();
          database.ref(`typing/${currentChat}`).off();
        }
      }

      currentChat = chatId;
      currentChatType = type;

      // Mobile: switch panels
      if(window.innerWidth <= 768){
        $('sidebar').style.display = 'none';
        $('chatArea').style.display = 'flex';
        $('chatArea').classList.add('active');
      } else {
        $('chatArea').style.display = 'flex';
      }

      $('emptyChat').style.display = 'none';
      $('activeChat').classList.add('active');
      closeEmoji();

      if(type === 'private'){
        const chatData = allChats.find(c => c.id === chatId);
        if(chatData){
          currentChatData = chatData;
          const avatarEl = $('chatAvatar');
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
          if(chatData.avatarUrl){
            try {
              const loadedUrl = await loadAvatar(chatData.avatarUrl);
              if(loadedUrl){
                avatarEl.innerHTML = `<img src="${loadedUrl}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                avatarEl.className = 'chat-avatar chat-avatar-sm gradient-bg';
              } else {
                throw new Error('Failed to load avatar');
              }
            } catch(err) {
              console.error('Error loading avatar:', err);
              avatarEl.innerHTML = '';
              avatarEl.textContent = chatData.avatar || '?';
              avatarEl.className = 'chat-avatar chat-avatar-sm gradient-bg';
            }
          } else {
            avatarEl.innerHTML = '';
            avatarEl.textContent = chatData.avatar || '?';
            avatarEl.className = 'chat-avatar chat-avatar-sm gradient-bg';
          }
          
          $('chatName').innerHTML = getNameWithBadge(chatData.name, chatData.email);

          database.ref(`users/${chatData.oderId}`).off('value');
          database.ref(`users/${chatData.oderId}`).on('value', snap => {
            const u = snap.val();
            if(u) $('chatStatus').textContent = u.online ? '–í —Å–µ—Ç–∏' : `–ë—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
          });
        }
        $('chatHeaderActions').innerHTML = '';
      } else {
        const snap = await database.ref(`${type}s/${chatId}`).once('value');
        const data = snap.val();
        currentChatData = data;

        const avatarEl = $('chatAvatar');
        const gradientClass = type === 'group' ? 'gradient-green' : 'gradient-orange';
        
        if(data?.avatarUrl){
          try {
            const loadedUrl = await loadAvatar(data.avatarUrl);
            if(loadedUrl){
              avatarEl.innerHTML = `<img src="${loadedUrl}" alt="avatar" class="w-full h-full object-cover rounded-full">`;
              avatarEl.className = `chat-avatar chat-avatar-sm ${gradientClass} flex-shrink-0`;
            } else {
              throw new Error('Failed to load avatar');
            }
          } catch(err) {
            console.error('Error loading avatar:', err);
            avatarEl.innerHTML = '';
            avatarEl.textContent = (data?.name || '?').charAt(0).toUpperCase();
            avatarEl.className = `chat-avatar chat-avatar-sm ${gradientClass} flex-shrink-0`;
          }
        } else {
          avatarEl.innerHTML = '';
          avatarEl.textContent = (data?.name || '?').charAt(0).toUpperCase();
          avatarEl.className = `chat-avatar chat-avatar-sm ${gradientClass} flex-shrink-0`;
        }
        
        $('chatName').textContent = (type === 'group' ? 'üë• ' : 'üì¢ ') + (data?.name || '');

        const memberCount = Object.keys(data?.members || {}).length;
        $('chatStatus').textContent = type === 'group' ? `${memberCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤` : `${memberCount} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤`;

        const isOwner = data?.owner === currentUser.uid;
        $('chatHeaderActions').innerHTML = isOwner ? `
          <button class="icon-btn" onclick="showSettings('${chatId}','${type}')" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          </button>
        ` : '';
      }

      // Channel restrictions
      const isChannel = type === 'channel';
      const isOwner = currentChatData?.owner === currentUser.uid;
      if(isChannel && !isOwner){
        $('messageInputArea').style.display = 'none';
        $('channelNotice').style.display = 'block';
      } else {
        $('messageInputArea').style.display = 'block';
        $('channelNotice').style.display = 'none';
      }

      loadMessages(chatId);
      loadPinnedMessage();
      setupTypingListener(chatId);
      markAsRead(chatId);
      renderChatList();

      requestAnimationFrame(() => {
        $('messagesContainer').scrollTop = $('messagesContainer').scrollHeight;
      });
    }

    // ====== SAVED MESSAGES (–ò–ó–ë–†–ê–ù–ù–û–ï) ======
    async function openSavedMessages(){
      // Stop previous listeners
      if(currentChat){
        if(currentChatType === 'saved'){
          database.ref(`savedMessages/${currentUser.uid}`).off();
        } else {
          database.ref(`messages/${currentChat}`).off();
          database.ref(`typing/${currentChat}`).off();
        }
      }

      currentChat = 'saved';
      currentChatType = 'saved';
      currentChatData = null;

      // Mobile: switch panels
      if(window.innerWidth <= 768){
        $('sidebar').style.display = 'none';
        $('chatArea').style.display = 'flex';
        $('chatArea').classList.add('active');
      } else {
        $('chatArea').style.display = 'flex';
      }

      $('emptyChat').style.display = 'none';
      $('activeChat').classList.add('active');
      closeEmoji();

      // Set header
      const avatarEl = $('chatAvatar');
      avatarEl.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>';
      avatarEl.className = 'chat-avatar chat-avatar-sm gradient-bg';
      
      $('chatName').textContent = '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
      $('chatStatus').textContent = '–¢–æ–ª—å–∫–æ –≤—ã –≤–∏–¥–∏—Ç–µ —ç—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è';
      $('chatHeaderActions').innerHTML = '';

      // Show input
      $('messageInputArea').style.display = 'block';
      $('channelNotice').style.display = 'none';

      loadSavedMessages();

      requestAnimationFrame(() => {
        $('messagesContainer').scrollTop = $('messagesContainer').scrollHeight;
      });
    }

    function loadSavedMessages(){
      const container = $('messagesContainer');
      container.innerHTML = '';

      // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–ª—É—à–∞—Ç–µ–ª–∏
      const savedRef = database.ref(`savedMessages/${currentUser.uid}`);
      savedRef.off();
      
      // –°–ª—É—à–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
      savedRef.orderByChild('timestamp').on('child_added', snap => {
        const msg = snap.val();
        const msgId = snap.key;
        addMessageToUI(msg, msgId);
      });
      
      // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
      savedRef.on('child_changed', snap => {
        const msg = snap.val();
        const msgId = snap.key;
        console.log('Message changed:', msgId);
        updateMessageUI(msg, msgId);
      });
      
      // –°–ª—É—à–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
      savedRef.on('child_removed', snap => {
        const msgId = snap.key;
        console.log('child_removed event fired for:', msgId);
        const msgEl = document.getElementById(`msg-${msgId}`);
        if(msgEl) {
          msgEl.remove();
          console.log('Message element removed from DOM via listener');
        } else {
          console.log('Message element not found in DOM:', msgId);
        }
      });
      
      console.log('Saved messages listeners attached');
    }

    // ====== MESSAGES ======
    function loadMessages(chatId){
      const container = $('messagesContainer');
      container.innerHTML = '';

      // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–ª—É—à–∞—Ç–µ–ª–∏
      const messagesRef = database.ref(`messages/${chatId}`);
      messagesRef.off();
      
      // –°–ª—É—à–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
      messagesRef.orderByChild('timestamp').on('child_added', snap => {
        const msg = snap.val();
        const msgId = snap.key;
        addMessageToUI(msg, msgId);
      });

      // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
      messagesRef.on('child_changed', snap => {
        updateMessageUI(snap.val(), snap.key);
      });

      // –°–ª—É—à–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
      messagesRef.on('child_removed', snap => {
        const msgId = snap.key;
        console.log('child_removed event fired for message:', msgId);
        const msgEl = document.getElementById(`msg-${msgId}`);
        if(msgEl) {
          msgEl.remove();
          console.log('Message element removed from DOM');
        } else {
          console.log('Message element not found:', msgId);
        }
      });
      
      console.log('Message listeners attached for chat:', chatId);
    }

    function getReadIcon(msg){
      if(msg.readBy && Object.keys(msg.readBy).some(uid => uid !== currentUser.uid)){
        return '<svg class="w-4 h-4 text-sky-300" fill="currentColor" viewBox="0 0 24 24"><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"/></svg>';
      }
      return '<svg class="w-4 h-4 text-slate-300" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>';
    }

    function getReactionsHtml(msgId, msg){
      const reactions = msg.reactions || {};
      const list = Object.entries(reactions).reduce((acc, [emoji, users]) => {
        const count = Object.keys(users||{}).length;
        const hasOwn = !!(users && users[currentUser.uid]);
        if(count > 0) acc.push({emoji, count, hasOwn});
        return acc;
      }, []);

      if(!list.length) return '';

      return `
        <div class="flex flex-wrap gap-1 mt-2">
          ${list.map(r => `
            <button class="px-2 py-0.5 rounded-full text-xs border border-white/10 ${r.hasOwn ? 'bg-violet-600/30' : 'bg-white/5'} hover:bg-white/10" onclick="toggleReaction('${msgId}','${r.emoji}')">
              <span>${r.emoji}</span><span class="ml-1">${r.count}</span>
            </button>
          `).join('')}
        </div>
      `;
    }

    function addMessageToUI(msg, msgId){
      const container = $('messagesContainer');
      const isOwn = msg.senderId === currentUser.uid;

      // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      if(msg.isVoiceMessage || (msg.fileType && msg.fileType.startsWith('audio/'))){
        console.log('=== ADDING VOICE MESSAGE TO UI ===');
        console.log('Message ID:', msgId);
        console.log('Message object:', JSON.stringify(msg, null, 2));
        console.log('File URL:', msg.fileUrl);
        console.log('File URL type:', typeof msg.fileUrl);
        console.log('File Type:', msg.fileType);
        console.log('Duration:', msg.audioDuration);
        console.log('Is Voice Message:', msg.isVoiceMessage);
      }

      let senderLine = '';
      if(!isOwn && currentChatType !== 'private'){
        const sender = allUsers[msg.senderId];
        senderLine = `<div class="sender-line">${getNameWithBadge(sender?.name || 'Unknown', sender?.email)}</div>`;
      }

      let content = '';
      if(msg.fileUrl){
        if(msg.isVoiceMessage || (msg.fileType && msg.fileType.startsWith('audio/'))){
          // –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          const duration = msg.audioDuration || '0:00';
          const safeUrl = escapeHtml(msg.fileUrl);
          
          console.log('Safe URL for HTML:', safeUrl);
          
          content += `
            <div class="voice-message" data-audio-url="${safeUrl}" data-audio-type="${escapeHtml(msg.fileType || 'audio/webm')}" data-msg-id="${msgId}">
              <button class="voice-play-btn" onclick="toggleVoicePlayback('${msgId}', '${safeUrl}', '${escapeHtml(msg.fileType || 'audio/webm')}')">
                <svg class="play-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <svg class="pause-icon" style="display:none" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>
              </button>
              <div class="voice-waveform" id="waveform-${msgId}">
                ${generateWaveform()}
              </div>
              <span class="voice-duration">${escapeHtml(duration)}</span>
            </div>
          `;
        } else if(msg.fileType && msg.fileType.startsWith('image/')){
          content += `
            <div class="message-media mb-2">
              <img loading="lazy" src="${msg.fileUrl}" alt="image" onclick="viewImage('${msg.fileUrl}')" style="cursor:pointer" data-firebase-image="${msgId}" />
            </div>
          `;
        } else if(msg.fileType && msg.fileType.startsWith('video/')){
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –∫—Ä—É–∂–æ–∫ –∏–ª–∏ –æ–±—ã—á–Ω–æ–µ –≤–∏–¥–µ–æ
          if(msg.isVideoMessage || msg.isCircle){
            const videoId = 'circle_' + msgId;
            content += `
              <div class="mb-2" style="max-width:240px;position:relative;display:inline-block;">
                <svg id="${videoId}_svg" style="position:absolute;top:0;left:0;width:240px;height:240px;transform:rotate(-90deg);cursor:pointer;" viewBox="0 0 240 240" onclick="seekCircleVideo(event, '${videoId}')">
                  <circle cx="120" cy="120" r="117" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="6"/>
                  <circle id="${videoId}_progress" cx="120" cy="120" r="117" fill="none" stroke="#8b5cf6" stroke-width="6" stroke-dasharray="735" stroke-dashoffset="735" stroke-linecap="round" style="transition:stroke-dashoffset 0.1s linear;"/>
                </svg>
                <video id="${videoId}" src="${msg.fileUrl}" style="border-radius:50%;width:240px;height:240px;object-fit:cover;display:block;cursor:pointer;border:none;background:transparent;" data-firebase-video="${msgId}" onclick="toggleCircleVideo('${videoId}')"></video>
                <div id="${videoId}_play" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:60px;height:60px;background:rgba(0,0,0,0.5);border-radius:50%;display:flex;align-items:center;justify-content:center;pointer-events:none;">
                  <svg style="width:30px;height:30px;margin-left:4px;" fill="white" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </div>
              </div>
            `;
          } else {
            content += `
              <div class="message-media mb-2">
                <video controls src="${msg.fileUrl}" data-firebase-video="${msgId}"></video>
              </div>
            `;
          }
        } else {
          // –û–±—ã—á–Ω—ã–π —Ñ–∞–π–ª
          const fileUrl = msg.fileUrl;
          const fileName = escapeHtml(msg.fileName || '–§–∞–π–ª');
          
          if(fileUrl.startsWith('firebase-file://')){
            // –§–∞–π–ª –≤ Firebase Database - –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            content += `
              <div class="file-chip mb-2" data-file-id="${msgId}">
                <svg class="w-8 h-8 text-violet-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                <div class="min-w-0 flex-1">
                  <div class="text-sm font-medium truncate">${fileName}</div>
                  <div class="text-xs text-slate-400">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</div>
                </div>
                <button onclick="downloadFirebaseFile('${fileUrl}', '${fileName}')" class="icon-btn" style="width:36px;height:36px;" title="–°–∫–∞—á–∞—Ç—å">
                  <svg style="width:18px;height:18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                </button>
              </div>
            `;
          } else {
            // –û–±—ã—á–Ω—ã–π URL
            content += `
              <a href="${fileUrl}" target="_blank" class="file-chip mb-2">
                <svg class="w-8 h-8 text-violet-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                <div class="min-w-0">
                  <div class="text-sm font-medium truncate">${fileName}</div>
                  <div class="text-xs text-slate-400">–û—Ç–∫—Ä—ã—Ç—å</div>
                </div>
              </a>
            `;
          }
        }
      }

      if(msg.text){
        const captionClass = (msg.fileUrl && msg.fileType && (msg.fileType.startsWith('image/') || msg.fileType.startsWith('video/'))) ? 'msg-text media-caption' : 'msg-text';
        content += `<div class="${captionClass}">${escapeHtml(msg.text)}</div>`;
      }

      const reactionsHtml = getReactionsHtml(msgId, msg);
      const editedHtml = msg.edited ? '<span class="edited-indicator">–∏–∑–º.</span>' : '';

      const row = document.createElement('div');
      row.className = `message-row ${isOwn ? 'out' : 'in'} fade-in`;
      row.id = `msg-${msgId}`;

      row.innerHTML = `
        <div class="msg-wrap">
          ${senderLine}
          <div class="bubble ${isOwn ? 'out' : 'in'}" oncontextmenu="showReactions(event,'${msgId}')" onclick="handleMessageTap(event,'${msgId}')">
            ${content}
            <div class="meta">
              ${editedHtml}
              <span class="time">${formatTime(msg.timestamp)}</span>
              ${isOwn ? getReadIcon(msg) : ''}
            </div>
            ${reactionsHtml}
          </div>
        </div>
      `;

      container.appendChild(row);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º firebase-file:// URLs –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      if(msg.fileUrl && msg.fileUrl.startsWith('firebase-file://') && msg.fileType && msg.fileType.startsWith('image/')){
        const fileId = msg.fileUrl.replace('firebase-file://', '');
        const imgEl = row.querySelector(`[data-firebase-image="${msgId}"]`);
        if(imgEl){
          loadFirebaseFile(fileId).then(base64Data => {
            imgEl.src = base64Data;
          }).catch(err => {
            console.error('Error loading image:', err);
            imgEl.parentElement.innerHTML = '<div style="padding:20px;background:rgba(239,68,68,0.2);border-radius:12px;color:#f87171;text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
          });
        }
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º firebase-file:// URLs –¥–ª—è –≤–∏–¥–µ–æ
      if(msg.fileUrl && msg.fileUrl.startsWith('firebase-file://') && msg.fileType && msg.fileType.startsWith('video/')){
        const fileId = msg.fileUrl.replace('firebase-file://', '');
        const videoEl = row.querySelector(`[data-firebase-video="${msgId}"]`);
        if(videoEl){
          loadFirebaseFile(fileId).then(base64Data => {
            videoEl.src = base64Data;
          }).catch(err => {
            console.error('Error loading video:', err);
            videoEl.parentElement.innerHTML = '<div style="padding:20px;background:rgba(239,68,68,0.2);border-radius:12px;color:#f87171;text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ</div>';
          });
        }
      }
      
      const nearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 120;
      if(nearBottom) container.scrollTop = container.scrollHeight;
    }

    function updateMessageUI(msg, msgId){
      const el = document.getElementById(`msg-${msgId}`);
      if(!el) return;

      const bubble = el.querySelector('.bubble');
      if(!bubble) return;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
      const textEl = bubble.querySelector('.msg-text');
      if(textEl && msg.text !== undefined){
        textEl.textContent = msg.text;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–∏–∑–º–µ–Ω–µ–Ω–æ"
      const meta = bubble.querySelector('.meta');
      if(meta){
        let editedEl = meta.querySelector('.edited-indicator');
        if(msg.edited && !editedEl){
          meta.insertAdjacentHTML('afterbegin', '<span class="edited-indicator">–∏–∑–º.</span>');
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏–∏
      const existing = bubble.querySelector('.flex.flex-wrap');
      const reactionsHtml = getReactionsHtml(msgId, msg);
      if(reactionsHtml){
        if(existing){
          existing.outerHTML = reactionsHtml.trim();
        } else {
          bubble.insertAdjacentHTML('beforeend', reactionsHtml);
        }
      } else {
        if(existing) existing.remove();
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø—Ä–æ—á—Ç–µ–Ω–∏—è
      if(meta && msg.senderId === currentUser.uid){
        const icon = meta.querySelector('svg');
        if(icon) icon.outerHTML = getReadIcon(msg);
        else meta.insertAdjacentHTML('beforeend', getReadIcon(msg));
      }
    }

    // ====== REACTIONS ======
    let lastTap = 0;
    function handleMessageTap(e, msgId){
      const now = Date.now();
      if(now - lastTap < 280){
        showReactions(e, msgId);
      }
      lastTap = now;
    }

    // ====== VIDEO CIRCLE PLAYER ======
    function toggleCircleVideo(videoId){
      const video = document.getElementById(videoId);
      const playIcon = document.getElementById(videoId + '_play');
      const progressCircle = document.getElementById(videoId + '_progress');
      
      if(!video || !playIcon) return;
      
      if(video.paused){
        video.play();
        playIcon.style.display = 'none';
      } else {
        video.pause();
        playIcon.style.display = 'flex';
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
      if(progressCircle){
        const circumference = 735; // 2 * PI * 117
        
        video.ontimeupdate = () => {
          if(video.duration){
            const progress = video.currentTime / video.duration;
            const offset = circumference - (progress * circumference);
            progressCircle.style.strokeDashoffset = offset;
          }
        };
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏
        video.onended = () => {
          playIcon.style.display = 'flex';
          progressCircle.style.strokeDashoffset = circumference;
        };
      } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –ø–∞—É–∑—ã –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –≤–∏–¥–µ–æ
        video.onended = () => {
          playIcon.style.display = 'flex';
        };
      }
    }

    function seekCircleVideo(event, videoId){
      event.stopPropagation();
      
      const video = document.getElementById(videoId);
      const svg = document.getElementById(videoId + '_svg');
      
      if(!video || !svg) return;
      
      // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ SVG
      const rect = svg.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      // –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞
      const clickX = event.clientX - centerX;
      const clickY = event.clientY - centerY;
      let angle = Math.atan2(clickY, clickX) * (180 / Math.PI);
      
      // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —É–≥–æ–ª (SVG –ø–æ–≤–µ—Ä–Ω—É—Ç –Ω–∞ -90 –≥—Ä–∞–¥—É—Å–æ–≤)
      angle = angle + 90;
      if(angle < 0) angle += 360;
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —É–≥–æ–ª –≤ –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      const progress = angle / 360;
      
      // –ü–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
      if(video.duration){
        video.currentTime = progress * video.duration;
        
        // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –±—ã–ª–æ –Ω–∞ –ø–∞—É–∑–µ, –∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ
        if(video.paused){
          video.play();
          const playIcon = document.getElementById(videoId + '_play');
          if(playIcon) playIcon.style.display = 'none';
        }
      }
    }

    let messageToDelete = null;
    let currentMessageText = '';

    async function showMessageContextMenu(e, msgId, isOwn){
      e.preventDefault();
      currentMessageId = msgId;
      const menu = $('messageContextMenu');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
      const editBtn = $('editMessageBtn');
      const deleteBtn = $('deleteMessageBtn');
      editBtn.style.display = isOwn ? 'flex' : 'none';
      deleteBtn.style.display = isOwn ? 'flex' : 'none';
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const pinnedSnap = await database.ref(`pinnedMessages/${currentChat}`).once('value');
      const pinnedData = pinnedSnap.val();
      const isPinned = pinnedData && pinnedData.messageId === msgId;
      
      $('pinMessageText').textContent = isPinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —á–∞—Ç–∞
      const messagePath = currentChatType === 'saved' 
        ? `savedMessages/${currentUser.uid}/${msgId}`
        : `messages/${currentChat}/${msgId}`;
      
      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      database.ref(messagePath).once('value', snap => {
        const msg = snap.val();
        currentMessageText = msg?.text || '';
      });
      
      menu.classList.add('show');

      const rect = e.target.getBoundingClientRect();
      const menuWidth = 200;
      const menuHeight = isOwn ? 260 : 170;
      
      let left = Math.min(rect.left, window.innerWidth - menuWidth - 10);
      left = Math.max(10, left);
      
      let top = rect.top - menuHeight;
      if(top < 10) top = rect.bottom + 10;
      
      menu.style.left = left + 'px';
      menu.style.top = top + 'px';

      setTimeout(() => {
        document.addEventListener('click', hideMessageContextMenu, { once:true });
      }, 0);
    }

    function hideMessageContextMenu(){
      $('messageContextMenu').classList.remove('show');
    }

    async function startEditMessage(){
      hideMessageContextMenu();
      if(!currentMessageId || !currentChat) return;
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —á–∞—Ç–∞
      const messagePath = currentChatType === 'saved' 
        ? `savedMessages/${currentUser.uid}/${currentMessageId}`
        : `messages/${currentChat}/${currentMessageId}`;
      
      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
      const snap = await database.ref(messagePath).once('value');
      const msg = snap.val();
      
      if(!msg || msg.senderId !== currentUser.uid) {
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
      }
      
      $('editMessageText').value = msg.text || '';
      showModal('editMessageModal');
    }

    async function saveEditedMessage(){
      const newText = $('editMessageText').value.trim();
      
      if(!currentMessageId || !currentChat) {
        closeModal('editMessageModal');
        return;
      }
      
      try {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —á–∞—Ç–∞
        const messagePath = currentChatType === 'saved' 
          ? `savedMessages/${currentUser.uid}/${currentMessageId}`
          : `messages/${currentChat}/${currentMessageId}`;
        
        await database.ref(messagePath).update({
          text: newText,
          edited: true,
          editedAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        closeModal('editMessageModal');
        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ');
      } catch(err) {
        console.error('Edit message error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
      }
    }

    async function copyMessage(){
      hideMessageContextMenu();
      if(!currentMessageText) {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —á–∞—Ç–∞
        const messagePath = currentChatType === 'saved' 
          ? `savedMessages/${currentUser.uid}/${currentMessageId}`
          : `messages/${currentChat}/${currentMessageId}`;
        
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        const snap = await database.ref(messagePath).once('value');
        const msg = snap.val();
        currentMessageText = msg?.text || '';
      }
      
      if(!currentMessageText) {
        showCopyToast('–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        return;
      }
      
      try {
        await navigator.clipboard.writeText(currentMessageText);
        showCopyToast('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
      } catch(err) {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        const textarea = document.createElement('textarea');
        textarea.value = currentMessageText;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showCopyToast('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
      }
    }

    // ====== PIN MESSAGE ======
    let currentPinnedMessageId = null;

    async function togglePinMessage(){
      hideMessageContextMenu();
      if(!currentMessageId || !currentChat) return;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –ª–∏ —É–∂–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const pinnedSnap = await database.ref(`pinnedMessages/${currentChat}`).once('value');
      const pinnedData = pinnedSnap.val();
      
      if(pinnedData && pinnedData.messageId === currentMessageId){
        // –û—Ç–∫—Ä–µ–ø–ª—è–µ–º
        await unpinMessage();
      } else {
        // –ó–∞–∫—Ä–µ–ø–ª—è–µ–º
        await pinMessage();
      }
    }

    async function pinMessage(){
      if(!currentMessageId || !currentChat) return;
      
      try {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —á–∞—Ç–∞
        const messagePath = currentChatType === 'saved' 
          ? `savedMessages/${currentUser.uid}/${currentMessageId}`
          : `messages/${currentChat}/${currentMessageId}`;
        
        const snap = await database.ref(messagePath).once('value');
        const msg = snap.val();
        
        if(!msg) return;
        
        await database.ref(`pinnedMessages/${currentChat}`).set({
          messageId: currentMessageId,
          text: msg.text || 'üìé –ú–µ–¥–∏–∞',
          pinnedBy: currentUser.uid,
          pinnedAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        showToast('üìå', '–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ', '–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ');
        loadPinnedMessage();
      } catch(err) {
        console.error('Pin message error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
      }
    }

    async function unpinMessage(){
      if(!currentChat) return;
      
      try {
        await database.ref(`pinnedMessages/${currentChat}`).remove();
        $('pinnedMessage').classList.add('hidden');
        currentPinnedMessageId = null;
        showToast('üìå', '–û—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ', '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ');
      } catch(err) {
        console.error('Unpin message error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
      }
    }

    async function loadPinnedMessage(){
      if(!currentChat) return;
      
      database.ref(`pinnedMessages/${currentChat}`).off('value');
      database.ref(`pinnedMessages/${currentChat}`).on('value', snap => {
        const data = snap.val();
        
        if(data && data.messageId){
          currentPinnedMessageId = data.messageId;
          $('pinnedMessageText').textContent = data.text || '–°–æ–æ–±—â–µ–Ω–∏–µ';
          $('pinnedMessage').classList.remove('hidden');
        } else {
          currentPinnedMessageId = null;
          $('pinnedMessage').classList.add('hidden');
        }
      });
    }

    function scrollToPinnedMessage(){
      if(!currentPinnedMessageId) return;
      
      const msgEl = document.getElementById(`msg-${currentPinnedMessageId}`);
      if(msgEl){
        msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        msgEl.style.backgroundColor = 'rgba(139,92,246,0.2)';
        setTimeout(() => {
          msgEl.style.backgroundColor = '';
        }, 1500);
      }
    }

    function showCopyToast(text){
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π toast –µ—Å–ª–∏ –µ—Å—Ç—å
      const existing = document.querySelector('.copy-toast');
      if(existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = 'copy-toast';
      toast.innerHTML = `
        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        ${text}
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 2000);
    }

    async function deleteMessage(){
      hideMessageContextMenu();
      
      if(!currentMessageId || !currentChat) {
        console.error('Cannot delete: missing currentMessageId or currentChat');
        return;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      const modal = document.createElement('div');
      modal.id = 'deleteConfirmModal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;';
      
      modal.innerHTML = `
        <div style="background:rgba(15,23,42,0.98);border-radius:20px;padding:24px;max-width:320px;width:90%;border:1px solid rgba(148,163,184,0.18);text-align:center;">
          <div style="width:56px;height:56px;border-radius:50%;background:rgba(239,68,68,0.15);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
            <svg style="width:28px;height:28px;color:#f87171;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </div>
          <div style="font-size:17px;font-weight:600;margin-bottom:8px;">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?</div>
          <div style="font-size:14px;color:#9ca3af;margin-bottom:20px;">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å</div>
          <div style="display:flex;gap:8px;">
            <button id="cancelDeleteBtn" style="flex:1;padding:12px;border:none;border-radius:12px;background:rgba(148,163,184,0.1);color:#9ca3af;font-size:15px;font-weight:500;cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
            <button id="confirmDeleteBtn" style="flex:1;padding:12px;border:none;border-radius:12px;background:#ef4444;color:white;font-size:15px;font-weight:500;cursor:pointer;">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã
      modal.querySelector('#cancelDeleteBtn').onclick = () => {
        modal.remove();
      };
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      modal.querySelector('#confirmDeleteBtn').onclick = async () => {
        const msgIdToDelete = currentMessageId;
        const chatIdToDelete = currentChat;
        const chatTypeToDelete = currentChatType;
        
        modal.remove();
        
        try {
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å
          let path;
          if(chatTypeToDelete === 'saved'){
            path = `savedMessages/${currentUser.uid}/${msgIdToDelete}`;
          } else {
            path = `messages/${chatIdToDelete}/${msgIdToDelete}`;
          }
          
          console.log('Deleting message at path:', path);
          
          // –£–¥–∞–ª—è–µ–º –∏–∑ Firebase
          await database.ref(path).remove();
          
          console.log('Message deleted from Firebase');
          
          // –£–¥–∞–ª—è–µ–º –∏–∑ DOM
          const msgElement = document.getElementById(`msg-${msgIdToDelete}`);
          if(msgElement){
            msgElement.remove();
            console.log('Message removed from DOM');
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          const toast = document.createElement('div');
          toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(15,23,42,0.95);color:white;padding:12px 24px;border-radius:12px;font-size:14px;z-index:1000;display:flex;align-items:center;gap:8px;';
          toast.innerHTML = '<svg style="width:20px;height:20px;color:#10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
          
        } catch(error) {
          console.error('Error deleting message:', error);
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
          const errorToast = document.createElement('div');
          errorToast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(239,68,68,0.95);color:white;padding:12px 24px;border-radius:12px;font-size:14px;z-index:1000;';
          errorToast.textContent = '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message;
          document.body.appendChild(errorToast);
          setTimeout(() => errorToast.remove(), 3000);
        }
      };
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      modal.onclick = (e) => {
        if(e.target === modal) modal.remove();
      };
    }

    function closeConfirmModal(){
      const modal = document.getElementById('deleteConfirmModal');
      if(modal) modal.remove();
    }

    async function confirmDeleteMessage(){
      // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      closeConfirmModal();
    }

    // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    function showReactions(e, msgId){
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–≤–æ—ë –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const msgEl = document.getElementById(`msg-${msgId}`);
      const isOwn = msgEl && msgEl.classList.contains('out');
      showMessageContextMenu(e, msgId, isOwn);
    }

    function hideReactions(){
      hideMessageContextMenu();
    }

    function addReaction(emoji){
      if(!currentMessageId || !currentChat) return;
      database.ref(`messages/${currentChat}/${currentMessageId}/reactions/${emoji}/${currentUser.uid}`).set(true);
      hideReactions();
    }

    function toggleReaction(msgId, emoji){
      database.ref(`messages/${currentChat}/${msgId}/reactions/${emoji}/${currentUser.uid}`).once('value', snap => {
        if(snap.exists()) snap.ref.remove();
        else snap.ref.set(true);
      });
    }

    // ====== TYPING ======
    function handleTyping(){
      if(!currentChat) return;
      database.ref(`typing/${currentChat}/${currentUser.uid}`).set(true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        database.ref(`typing/${currentChat}/${currentUser.uid}`).set(false);
      }, 1800);
    }

    function setupTypingListener(chatId){
      database.ref(`typing/${chatId}`).off();
      database.ref(`typing/${chatId}`).on('value', snap => {
        const map = snap.val() || {};
        const typers = Object.entries(map).filter(([uid, val]) => uid !== currentUser.uid && val);
        if(typers.length){
          $('typingText').textContent = currentChatType === 'private' ? '–ø–µ—á–∞—Ç–∞–µ—Ç...' : '–ø–µ—á–∞—Ç–∞—é—Ç...';
          $('typingIndicator').classList.remove('hidden');
        } else {
          $('typingIndicator').classList.add('hidden');
        }
      });
    }

    // ====== READ ======
    function markAsRead(chatId){
      database.ref(`messages/${chatId}`).once('value', snap => {
        const msgs = snap.val() || {};
        for(const [msgId, msg] of Object.entries(msgs)){
          if(msg.senderId !== currentUser.uid){
            database.ref(`messages/${chatId}/${msgId}/readBy/${currentUser.uid}`).set(true);
          }
        }
      });
      
      // –°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
      unreadCounts[chatId] = 0;
      
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ allChats
      const chatIndex = allChats.findIndex(c => c.id === chatId);
      if(chatIndex !== -1){
        allChats[chatIndex].unread = 0;
      }
      
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –±–µ–π–¥–∂
      renderChatList();
    }

    // ====== FILES ======
    function handleFileSelect(event){
      const file = event.target.files?.[0];
      if(!file) return;

      pendingFile = file;
      $('uploadPreview').classList.remove('hidden');

      const previewImage = $('uploadPreviewImage');
      const previewFile = $('uploadPreviewFile');

      if(file.type.startsWith('image/')){
        previewImage.classList.remove('hidden');
        previewFile.classList.add('hidden');
        previewImage.src = URL.createObjectURL(file);
      } else {
        previewImage.classList.add('hidden');
        previewFile.classList.remove('hidden');
        previewFile.style.display = 'flex';
        $('uploadFileName').textContent = file.name;
      }

      $('imageCaption').value = '';
      event.target.value = '';
    }

    function cancelUpload(){
      if(uploadTask){
        try{ uploadTask.cancel(); }catch(e){}
        uploadTask = null;
      }
      isUploading = false;
      pendingFile = null;
      $('uploadPreview').classList.add('hidden');
      $('uploadProgress').classList.add('hidden');
      $('uploadProgressBar').style.width = '0%';
      $('imageCaption').value = '';

      const img = $('uploadPreviewImage');
      if(img && img.src && img.src.startsWith('blob:')){
        try{ URL.revokeObjectURL(img.src); }catch(e){}
      }
    }

    async function uploadImageToImgBB(file){
      return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('key', IMGBB_API_KEY);

        $('uploadProgress').classList.remove('hidden');
        $('uploadProgressBar').style.width = '0%';

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://api.imgbb.com/1/upload');

        xhr.upload.onprogress = (e) => {
          if(e.lengthComputable){
            const p = (e.loaded / e.total) * 100;
            $('uploadProgressBar').style.width = p + '%';
          }
        };

        xhr.onload = () => {
          try{
            const data = JSON.parse(xhr.responseText);
            if(xhr.status === 200 && data.success){
              resolve(data.data.url);
            } else {
              reject(new Error(data?.error?.message || 'imgBB upload failed'));
            }
          } catch(err){
            reject(new Error('Failed to parse imgBB response'));
          }
        };

        xhr.onerror = () => reject(new Error('Network error'));
        xhr.send(formData);
      });
    }

    async function uploadFileToFirebase(file){
      console.log('üì§ Uploading file to Firebase Database:', file.name, file.type);
      
      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (Firebase Database –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç ~10MB –¥–ª—è base64)
        const maxSize = 10 * 1024 * 1024; // 10MB
        if(file.size > maxSize){
          throw new Error(`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${(file.size / 1024 / 1024).toFixed(1)}MB). –ú–∞–∫—Å–∏–º—É–º 10MB –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Firebase Database.`);
        }
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64
        const reader = new FileReader();
        const base64Promise = new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        
        const base64Data = await base64Promise;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase Database
        const fileRef = database.ref('files').push();
        const fileId = fileRef.key;
        
        await fileRef.set({
          data: base64Data,
          mimeType: file.type,
          fileName: file.name,
          uploadedBy: currentUser.uid,
          uploadedAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º firebase-file:// URL
        const url = `firebase-file://${fileId}`;
        console.log('‚úÖ File uploaded to Firebase Database:', url);
        
        return url;
      } catch(err) {
        console.error('‚ùå Upload failed:', err);
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª: ' + err.message);
      }
    }

    async function uploadFile(file){
      // –í—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞–µ–º –≤ Firebase Database
      return await uploadFileToFirebase(file);
    }

    async function sendFileWithCaption(){
      if(!pendingFile || !currentChat) return;
      if(isUploading) return showToast('‚è≥','–ü–æ–¥–æ–∂–¥–∏—Ç–µ','–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...');

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–Ω
      const banSnap = await database.ref(`bannedUsers/${currentUser.uid}`).once('value');
      if(banSnap.exists()){
        showToast('üö´', '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–∞–π–ª—ã');
        await auth.signOut();
        return;
      }

      isUploading = true;
      const caption = $('imageCaption').value.trim();

      let messageData = {
        senderId: currentUser.uid,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        readBy: { [currentUser.uid]: true }
      };
      if(caption) messageData.text = caption;

      try{
        $('uploadProgress').classList.remove('hidden');
        $('uploadProgressBar').style.width = '50%';
        
        const url = await uploadFile(pendingFile);
        
        $('uploadProgressBar').style.width = '100%';
        
        messageData.fileUrl = url;
        messageData.fileName = pendingFile.name;
        messageData.fileType = pendingFile.type;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–ª–∏ –æ–±—ã—á–Ω—ã–π —á–∞—Ç
        if(currentChatType === 'saved'){
          await database.ref(`savedMessages/${currentUser.uid}`).push(messageData);
        } else {
          await database.ref(`messages/${currentChat}`).push(messageData);
          await touchChatUpdatedAt(currentChat);
        }

        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
      } finally {
        isUploading = false;
        $('uploadProgress').classList.add('hidden');
        cancelUpload();
      }
    }

    async function touchChatUpdatedAt(chatId){
      await database.ref(`userChats/${currentUser.uid}/${chatId}/updatedAt`).set(firebase.database.ServerValue.TIMESTAMP);
      if(currentChatType === 'private'){
        const chatData = allChats.find(c => c.id === chatId);
        if(chatData) await database.ref(`userChats/${chatData.oderId}/${chatId}/updatedAt`).set(firebase.database.ServerValue.TIMESTAMP);
      } else if(currentChatData?.members){
        const ids = Object.keys(currentChatData.members);
        await Promise.all(ids.filter(uid => uid !== currentUser.uid).map(uid => database.ref(`userChats/${uid}/${chatId}/updatedAt`).set(firebase.database.ServerValue.TIMESTAMP)));
      }
    }

    // ====== SEND MESSAGE ======
    async function sendMessage(e){
      e.preventDefault();
      if(isUploading) return showToast('‚è≥','–ü–æ–¥–æ–∂–¥–∏—Ç–µ','–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...');
      if(pendingFile) return sendFileWithCaption();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–Ω
      const banSnap = await database.ref(`bannedUsers/${currentUser.uid}`).once('value');
      if(banSnap.exists()){
        showToast('üö´', '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è');
        await auth.signOut();
        return;
      }

      const input = $('messageInput');
      const text = input.value.trim();
      if(!text || !currentChat) return;

      input.value = '';

      if(typingTimeout){
        clearTimeout(typingTimeout);
        if(currentChatType !== 'saved'){
          database.ref(`typing/${currentChat}/${currentUser.uid}`).set(false);
        }
      }

      const messageData = {
        senderId: currentUser.uid,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        readBy: { [currentUser.uid]: true },
        text
      };

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–ª–∏ –æ–±—ã—á–Ω—ã–π —á–∞—Ç
      if(currentChatType === 'saved'){
        await database.ref(`savedMessages/${currentUser.uid}`).push(messageData);
      } else {
        await database.ref(`messages/${currentChat}`).push(messageData);
        await touchChatUpdatedAt(currentChat);
      }
      
      closeEmoji();
    }

    // ====== IMAGE VIEWER ======
    function viewImage(url){
      $('viewerImage').src = url;
      $('imageViewer').classList.add('show');
    }
    function closeImageViewer(){
      $('imageViewer').classList.remove('show');
      $('viewerImage').src = '';
    }

    // ====== FILE PICKER MENU ======
    function openFilePicker(){
      const wrap = document.createElement('div');
      wrap.id = 'filePickerModal';
      wrap.className = 'modal show';
      wrap.onclick = (e) => { if(e.target && e.target.id === 'filePickerModal') wrap.remove(); };

      wrap.innerHTML = `
        <div class="sheet bottom p-4">
          <h3 class="text-lg font-bold mb-4 text-center">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å</h3>
          <div class="space-y-2">
            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="selectFileType('photo')">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#3b82f6,#22d3ee)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–§–æ—Ç–æ –∏–ª–∏ –í–∏–¥–µ–æ</div>
                <div class="text-xs text-slate-400">–§–æ—Ç–æ —á–µ—Ä–µ–∑ imgBB (–¥–æ 32MB)</div>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="selectFileType('camera')">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#22c55e,#34d399)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–ö–∞–º–µ—Ä–∞</div>
                <div class="text-xs text-slate-400">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</div>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="selectFileType('document')">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#fb923c,#fbbf24)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–î–æ–∫—É–º–µ–Ω—Ç</div>
                <div class="text-xs text-slate-400">PDF, Word, Excel</div>
              </div>
            </button>
          </div>
          <button class="w-full mt-4 py-2 text-slate-400 hover:text-white" onclick="document.getElementById('filePickerModal')?.remove()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `;

      document.body.appendChild(wrap);
    }

    function selectFileType(type){
      const input = $('fileInput');
      if(type === 'camera'){
        input.accept = 'image/*';
        input.capture = 'environment';
      } else if(type === 'photo'){
        input.accept = 'image/*,video/*';
        input.removeAttribute('capture');
      } else {
        input.accept = '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar';
        input.removeAttribute('capture');
      }
      input.click();
      document.getElementById('filePickerModal')?.remove();
    }

    // ====== EMOJI PICKER ======
    let currentEmojiCategory = 'smileys';

    function toggleEmoji(){
      const picker = $('emojiPicker');
      const willShow = !picker.classList.contains('show');
      picker.classList.toggle('show');
      if(willShow){
        renderEmojiCategory(currentEmojiCategory);
      }
    }

    function closeEmoji(){
      $('emojiPicker').classList.remove('show');
    }

    function showEmojiCategory(cat){
      currentEmojiCategory = cat;
      ['smileys','gestures','animals','food','activities','travel','objects','symbols'].forEach(k => {
        const btn = $('emojiTab' + k.charAt(0).toUpperCase() + k.slice(1));
        btn.classList.toggle('active', k === cat);
      });
      renderEmojiCategory(cat);
    }

    function renderEmojiCategory(cat){
      const grid = $('emojiGrid');
      const list = EMOJI[cat] || [];
      grid.innerHTML = list.map(e => `<button type="button" class="emoji-btn" onclick="addEmoji('${e.replace(/'/g, "\\'")}')">${e}</button>`).join('');
    }

    function addEmoji(emoji){
      const input = $('messageInput');
      input.value += emoji;
      input.focus();
    }

    // ====== NOTIFICATIONS ======
    function requestNotificationPermission() {
      if ('Notification' in window) {
        if (Notification.permission === 'default') {
          Notification.requestPermission().then(permission => {
            console.log('Notification permission:', permission);
          });
        }
      }
    }

    function setupNotificationListener(){
      database.ref(`userChats/${currentUser.uid}`).off('child_changed');
      database.ref(`userChats/${currentUser.uid}`).on('child_changed', async snap => {
        const chatId = snap.key;
        if(chatId === currentChat && document.visibilityState === 'visible') return;

        const msgSnap = await database.ref(`messages/${chatId}`).orderByChild('timestamp').limitToLast(1).once('value');
        const msgs = msgSnap.val();
        if(!msgs) return;

        const lastMsg = Object.values(msgs)[0];
        if(lastMsg.senderId === currentUser.uid) return;

        const senderName = allUsers[lastMsg.senderId]?.name || '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
        const msgText = lastMsg.text || (lastMsg.fileUrl ? 'üìé –§–∞–π–ª' : '');

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        playNotificationSound();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (toast)
        showToast(senderName.charAt(0).toUpperCase(), senderName, msgText, chatId);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
        if(Notification.permission === 'granted' && document.visibilityState !== 'visible'){
          try {
            const notification = new Notification(senderName, { 
              body: msgText,
              icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23667eea"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>',
              tag: chatId, // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —á–∞—Ç—É
              renotify: true,
              silent: true // –ú—ã –∏–≥—Ä–∞–µ–º —Å–≤–æ–π –∑–≤—É–∫
            });
            
            // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
            notification.onclick = () => {
              window.focus();
              const chat = allChats.find(c => c.id === chatId);
              if(chat) openChat(chatId, chat.type);
              notification.close();
            };
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => notification.close(), 5000);
          } catch(e) {
            console.warn('Notification error:', e);
          }
        }
      });
    }

    // ====== CREATE / USERS ======
    function showCreateMenu(){ showModal('createMenuModal'); }

    function showNewPrivateChat(){
      closeModal('createMenuModal');
      $('userSearchInput').value = '';
      $('userSearchResults').innerHTML = '';
      renderUsersForChat();
      showModal('newPrivateChatModal');
    }

    function renderUsersForChat(){
      const container = $('userSearchResults');
      const users = Object.entries(allUsers).filter(([uid]) => uid !== currentUser.uid);
      const unique = new Map(users);
      const arr = Array.from(unique.entries());

      if(!arr.length){
        container.innerHTML = '<div class="p-4 text-center text-slate-500">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
        return;
      }

      container.innerHTML = arr.map(([uid, user]) => `
        <div class="flex items-center gap-3 p-3 hover:bg-white/5 cursor-pointer rounded-xl" onclick="startPrivateChat('${uid}')" data-uid="${uid}">
          <div class="w-10 h-10 rounded-full gradient-bg grid place-items-center font-bold">${escapeHtml((user?.name || '?').charAt(0).toUpperCase())}</div>
          <div class="min-w-0">
            <div class="font-medium truncate">${getNameWithBadge(user?.name || 'Unknown', user?.email)}</div>
            <div class="text-xs text-slate-400">${user?.online ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}</div>
          </div>
        </div>
      `).join('');
    }

    function searchUsersForChat(){
      const q = $('userSearchInput').value.toLowerCase();
      document.querySelectorAll('#userSearchResults [data-uid]').forEach(item => {
        const name = item.querySelector('.font-medium')?.textContent.toLowerCase() || '';
        item.style.display = name.includes(q) ? '' : 'none';
      });
    }

    async function startPrivateChat(otherUserId){
      closeModal('newPrivateChatModal');
      const chatId = currentUser.uid < otherUserId ? `${currentUser.uid}_${otherUserId}` : `${otherUserId}_${currentUser.uid}`;

      await database.ref(`userChats/${currentUser.uid}/${chatId}`).set({
        type: 'private',
        oderId: otherUserId,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
      await database.ref(`userChats/${otherUserId}/${chatId}`).set({
        type: 'private',
        oderId: currentUser.uid,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });

      setTimeout(() => openChat(chatId, 'private'), 150);
    }

    // ====== SEARCH GROUPS/CHANNELS ======
    let currentSearchTab = 'groups';

    function showSearchGroupsChannels(){
      closeModal('createMenuModal');
      currentSearchTab = 'groups';
      $('groupChannelSearchInput').value = '';
      switchSearchTab('groups');
      showModal('searchGroupsChannelsModal');
      loadAllGroupsChannels();
    }

    function switchSearchTab(tab){
      currentSearchTab = tab;
      $('searchTabGroups').className = tab === 'groups' ? 'flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-violet-600 text-white' : 'flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400';
      $('searchTabChannels').className = tab === 'channels' ? 'flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-violet-600 text-white' : 'flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400';
      searchGroupsChannels();
    }

    async function loadAllGroupsChannels(){
      searchGroupsChannels();
    }

    async function searchGroupsChannels(){
      const query = $('groupChannelSearchInput').value.toLowerCase();
      const container = $('groupChannelSearchResults');
      
      try {
        const type = currentSearchTab === 'groups' ? 'groups' : 'channels';
        const snapshot = await database.ref(type).once('value');
        const data = snapshot.val();
        
        if(!data){
          container.innerHTML = `<div class="p-4 text-center text-slate-500">–ù–µ—Ç ${currentSearchTab === 'groups' ? '–≥—Ä—É–ø–ø' : '–∫–∞–Ω–∞–ª–æ–≤'}</div>`;
          return;
        }

        let results = Object.entries(data).map(([id, item]) => ({id, ...item}));
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
        if(query){
          results = results.filter(item => 
            (item.name || '').toLowerCase().includes(query) ||
            (item.description || '').toLowerCase().includes(query)
          );
        }

        if(!results.length){
          container.innerHTML = '<div class="p-4 text-center text-slate-500">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
          return;
        }

        const gradientClass = currentSearchTab === 'groups' ? 'gradient-green' : 'gradient-orange';
        const icon = currentSearchTab === 'groups' ? 'üë•' : 'üì¢';

        container.innerHTML = results.map(item => {
          const memberCount = Object.keys(item.members || {}).length;
          const isMember = item.members && item.members[currentUser.uid];
          
          return `
            <div class="flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl">
              <div class="w-12 h-12 rounded-full ${gradientClass} grid place-items-center font-bold text-lg shrink-0">
                ${escapeHtml((item.name || '?').charAt(0).toUpperCase())}
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-medium truncate flex items-center gap-2">
                  <span>${icon}</span>
                  <span>${escapeHtml(item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</span>
                </div>
                <div class="text-sm text-slate-400 truncate">${escapeHtml(item.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}</div>
                <div class="text-xs text-slate-500">${memberCount} ${memberCount === 1 ? '—É—á–∞—Å—Ç–Ω–∏–∫' : memberCount < 5 ? '—É—á–∞—Å—Ç–Ω–∏–∫–∞' : '—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'}</div>
              </div>
              ${isMember 
                ? '<button class="px-4 py-2 rounded-lg bg-white/5 text-slate-400 text-sm" disabled>–í—ã —É—á–∞—Å—Ç–Ω–∏–∫</button>'
                : `<button class="px-4 py-2 rounded-lg bg-violet-600 hover:bg-violet-700 text-sm font-medium" onclick="joinGroupChannel('${item.id}', '${currentSearchTab}')">–í—Å—Ç—É–ø–∏—Ç—å</button>`
              }
            </div>
          `;
        }).join('');
        
      } catch(err) {
        console.error('Search error:', err);
        container.innerHTML = '<div class="p-4 text-center text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      }
    }

    async function joinGroupChannel(id, type){
      try {
        showToast('‚è≥', '–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ', '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');

        const snapshot = await database.ref(`${type}/${id}`).once('value');
        const data = snapshot.val();
        
        if(!data){
          showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ì—Ä—É–ø–ø–∞/–∫–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
          return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∏
        await database.ref(`${type}/${id}/members/${currentUser.uid}`).set(true);

        // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await database.ref(`userChats/${currentUser.uid}/${id}`).set({
          type: type === 'groups' ? 'group' : 'channel',
          updatedAt: firebase.database.ServerValue.TIMESTAMP
        });

        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', `–í—ã –≤—Å—Ç—É–ø–∏–ª–∏ –≤ ${type === 'groups' ? '–≥—Ä—É–ø–ø—É' : '–∫–∞–Ω–∞–ª'}`);
        
        closeModal('searchGroupsChannelsModal');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        setTimeout(() => {
          loadAllChats();
        }, 500);
        
      } catch(err) {
        console.error('Join error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—Å—Ç—É–ø–∏—Ç—å');
      }
    }

    function showCreateGroup(){
      closeModal('createMenuModal');
      $('groupName').value = '';
      $('groupSearchInput').value = '';
      selectedGroupMembers = [];
      renderSelectedMembers();
      renderUsersForGroup();
      showModal('createGroupModal');
    }

    function renderUsersForGroup(){
      const container = $('groupSearchResults');
      const users = Object.entries(allUsers).filter(([uid]) => uid !== currentUser.uid);
      const unique = new Map(users);
      const arr = Array.from(unique.entries());

      if(!arr.length){
        container.innerHTML = '<div class="p-4 text-center text-slate-500">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
        return;
      }

      container.innerHTML = arr.map(([uid, user]) => {
        const selected = selectedGroupMembers.includes(uid);
        return `
          <div class="flex items-center gap-3 p-3 hover:bg-white/5 cursor-pointer rounded-xl ${selected ? 'bg-violet-600/15' : ''}" onclick="toggleGroupMember('${uid}')" data-uid="${uid}">
            <div class="w-10 h-10 rounded-full gradient-bg grid place-items-center font-bold">${escapeHtml((user?.name || '?').charAt(0).toUpperCase())}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium truncate">${getNameWithBadge(user?.name || 'Unknown', user?.email)}</div>
            </div>
            ${selected ? '<svg class="w-5 h-5 text-violet-300" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>' : ''}
          </div>
        `;
      }).join('');
    }

    function searchUsersForGroup(){
      const q = $('groupSearchInput').value.toLowerCase();
      document.querySelectorAll('#groupSearchResults [data-uid]').forEach(item => {
        const name = item.querySelector('.font-medium')?.textContent.toLowerCase() || '';
        item.style.display = name.includes(q) ? '' : 'none';
      });
    }

    function toggleGroupMember(uid){
      const i = selectedGroupMembers.indexOf(uid);
      if(i >= 0) selectedGroupMembers.splice(i,1);
      else selectedGroupMembers.push(uid);
      renderSelectedMembers();
      renderUsersForGroup();
    }

    function renderSelectedMembers(){
      const container = $('selectedMembers');
      if(!selectedGroupMembers.length){
        container.innerHTML = '';
        return;
      }
      container.innerHTML = selectedGroupMembers.map(uid => {
        const u = allUsers[uid];
        return `
          <div class="flex items-center gap-1 bg-violet-600/20 border border-white/10 rounded-full px-2 py-1">
            <span class="text-sm">${escapeHtml(u?.name || 'User')}</span>
            <button class="text-slate-300 hover:text-white" onclick="toggleGroupMember('${uid}')">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        `;
      }).join('');
    }

    async function createGroup(){
      const name = $('groupName').value.trim();
      if(!name) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
      if(!selectedGroupMembers.length) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');

      try{
        const groupId = database.ref().child('groups').push().key;
        const members = { [currentUser.uid]: true };
        selectedGroupMembers.forEach(uid => members[uid] = true);

        const updates = {};
        updates[`groups/${groupId}`] = {
          name,
          owner: currentUser.uid,
          members,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        Object.keys(members).forEach(uid => {
          updates[`userChats/${uid}/${groupId}`] = { type:'group', updatedAt: firebase.database.ServerValue.TIMESTAMP };
        });

        await database.ref().update(updates);

        closeModal('createGroupModal');
        selectedGroupMembers = [];
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞');
        setTimeout(() => openChat(groupId,'group'), 150);
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É');
      }
    }

    function showCreateChannel(){
      closeModal('createMenuModal');
      $('channelName').value = '';
      $('channelDescription').value = '';
      showModal('createChannelModal');
    }

    async function createChannel(){
      const name = $('channelName').value.trim();
      const description = $('channelDescription').value.trim();
      if(!name) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞');

      try{
        const channelId = database.ref().child('channels').push().key;
        const updates = {};
        updates[`channels/${channelId}`] = {
          name,
          description,
          owner: currentUser.uid,
          members: { [currentUser.uid]: true },
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        updates[`userChats/${currentUser.uid}/${channelId}`] = { type:'channel', updatedAt: firebase.database.ServerValue.TIMESTAMP };

        await database.ref().update(updates);

        closeModal('createChannelModal');
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω');
        setTimeout(() => openChat(channelId,'channel'), 150);
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª');
      }
    }

    // ====== ACCOUNT SWITCHER ======
    function showAccountSwitcher(){
      const accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      const container = $('accountSwitcherList');

      container.innerHTML = accounts.map(acc => {
        const isCurrent = currentUser?.email === acc.email;
        return `
          <div class="flex items-center gap-3 p-3 rounded-xl border border-white/10 ${isCurrent ? 'bg-violet-600/15' : 'hover:bg-white/5 cursor-pointer'}" ${isCurrent ? '' : `onclick=\"switchAccount('${escapeHtml(acc.email)}','${escapeHtml(acc.password)}')\"`}>
            <div class="w-10 h-10 gradient-bg rounded-full grid place-items-center font-bold">${escapeHtml((acc.name||'?').charAt(0).toUpperCase())}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium truncate">${escapeHtml(acc.name || acc.email)}</div>
              <div class="text-xs text-slate-400 truncate">${escapeHtml(acc.email)}</div>
            </div>
            ${isCurrent ? '<span class="text-xs text-violet-300">–¢–µ–∫—É—â–∏–π</span>' : ''}
          </div>
        `;
      }).join('') || '<div class="p-4 text-center text-slate-500">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>';

      showModal('accountSwitcherModal');
    }

    async function switchAccount(email, password){
      closeModal('accountSwitcherModal');
      
      // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      clearAllData();
      
      // –í—ã—Ö–æ–¥–∏–º –∏ –≤—Ö–æ–¥–∏–º –≤ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
      await auth.signOut();
      await auth.signInWithEmailAndPassword(email, password);
    }

    function addNewAccount(){
      closeModal('accountSwitcherModal');
      
      // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      clearAllData();
      
      auth.signOut();
    }

    // ====== PROFILE ======
    async function showProfile(){
      const snap = await database.ref(`users/${currentUser.uid}`).once('value');
      const user = snap.val() || {};

      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É
      const avatarLetter = $('profileAvatarLetter');
      const avatarImg = $('profileAvatarImg');
      
      if(user.avatarUrl){
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É
        try {
          const loadedUrl = await loadAvatar(user.avatarUrl);
          if(loadedUrl){
            avatarImg.src = loadedUrl;
            avatarImg.classList.remove('hidden');
            avatarLetter.style.display = 'none';
          } else {
            throw new Error('Failed to load avatar');
          }
        } catch(err) {
          console.error('Error loading avatar:', err);
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—É–∫–≤—É –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å
          avatarImg.classList.add('hidden');
          avatarLetter.style.display = '';
          avatarLetter.textContent = (user.name || '?').charAt(0).toUpperCase();
        }
      } else {
        avatarImg.classList.add('hidden');
        avatarLetter.style.display = '';
        avatarLetter.textContent = (user.name || '?').charAt(0).toUpperCase();
      }

      $('profileNameDisplay').innerHTML = getNameWithBadge(user.name || 'User', currentUser.email);
      $('profileEmail').textContent = currentUser.email;
      $('newProfileName').value = user.name || '';
      $('newProfileStatus').value = user.status || '';

      showModal('profileModal');
    }

    async function handleProfileAvatarSelect(e){
      const file = e.target.files[0];
      if(!file) return;

      if(!file.type.startsWith('image/')){
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
      }

      try {
        showToast('‚è≥', '–ó–∞–≥—Ä—É–∑–∫–∞', '–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏...');

        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64
        const reader = new FileReader();
        const base64Promise = new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        const base64Data = await base64Promise;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase Database
        const fileRef = database.ref('files').push();
        const fileId = fileRef.key;

        await fileRef.set({
          data: base64Data,
          mimeType: file.type,
          uploadedBy: currentUser.uid,
          uploadedAt: firebase.database.ServerValue.TIMESTAMP
        });

        const avatarUrl = `firebase-file://${fileId}`;

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        await database.ref(`users/${currentUser.uid}`).update({ avatarUrl });

        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        const avatarImg = $('profileAvatarImg');
        const avatarLetter = $('profileAvatarLetter');
        
        avatarImg.src = base64Data;
        avatarImg.classList.remove('hidden');
        avatarLetter.style.display = 'none';

        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–ê–≤–∞—Ç–∞—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        await loadAllUsers();
        renderChatList();

      } catch(err){
        console.error('Avatar upload error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É');
      }
    }

    async function updateProfile(e){
      e.preventDefault();
      const name = $('newProfileName').value.trim();
      const status = $('newProfileStatus').value.trim();
      if(!name) return;

      await database.ref(`users/${currentUser.uid}`).update({ name, status, nameLower: name.toLowerCase() });
      showToast('‚úì','–£—Å–ø–µ—à–Ω–æ','–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
      closeModal('profileModal');

      let accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      accounts = accounts.map(a => a.email === currentUser.email ? { ...a, name } : a);
      localStorage.setItem('flashchat_accounts', JSON.stringify(accounts));
      loadSavedAccounts();

      await loadAllUsers();
      renderChatList();
    }

    // ====== APP SETTINGS ======
    let testMicStream = null;
    let testCameraStream = null;
    let micTestAnimationFrame = null;

    async function showAppSettings(){
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      await loadMediaDevices();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
      const theme = settings.theme || 'dark';
      document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
      $(`theme${theme.charAt(0).toUpperCase() + theme.slice(1)}`).classList.add('active');
      
      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      $('soundNotifications').checked = settings.soundNotifications !== false;
      $('desktopNotifications').checked = settings.desktopNotifications === true;
      
      showModal('appSettingsModal');
    }

    async function loadMediaDevices(){
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        
        const microphones = devices.filter(d => d.kind === 'audioinput');
        const cameras = devices.filter(d => d.kind === 'videoinput');
        
        const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
        
        // –ú–∏–∫—Ä–æ—Ñ–æ–Ω—ã
        const micSelect = $('microphoneSelect');
        micSelect.innerHTML = '<option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>';
        microphones.forEach(mic => {
          const option = document.createElement('option');
          option.value = mic.deviceId;
          option.textContent = mic.label || `–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${microphones.indexOf(mic) + 1}`;
          if(mic.deviceId === settings.microphoneId){
            option.selected = true;
          }
          micSelect.appendChild(option);
        });
        
        // –ö–∞–º–µ—Ä—ã
        const camSelect = $('cameraSelect');
        camSelect.innerHTML = '<option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>';
        cameras.forEach(cam => {
          const option = document.createElement('option');
          option.value = cam.deviceId;
          option.textContent = cam.label || `–ö–∞–º–µ—Ä–∞ ${cameras.indexOf(cam) + 1}`;
          if(cam.deviceId === settings.cameraId){
            option.selected = true;
          }
          camSelect.appendChild(option);
        });
        
      } catch(err){
        console.error('Error loading devices:', err);
      }
    }

    function setTheme(theme){
      const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
      settings.theme = theme;
      localStorage.setItem('flashchat_settings', JSON.stringify(settings));
      
      document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
      $(`theme${theme.charAt(0).toUpperCase() + theme.slice(1)}`).classList.add('active');
      
      applyTheme(theme);
      showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞');
    }

    function applyTheme(theme){
      if(theme === 'auto'){
        const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        theme = isDark ? 'dark' : 'light';
      }
      
      if(theme === 'light'){
        document.body.classList.add('light-theme');
      } else {
        document.body.classList.remove('light-theme');
      }
    }

    function saveMicrophonePreference(){
      const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
      settings.microphoneId = $('microphoneSelect').value;
      localStorage.setItem('flashchat_settings', JSON.stringify(settings));
      showToast('‚úÖ', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–±—Ä–∞–Ω');
    }

    function saveCameraPreference(){
      const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
      settings.cameraId = $('cameraSelect').value;
      localStorage.setItem('flashchat_settings', JSON.stringify(settings));
      showToast('‚úÖ', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', '–ö–∞–º–µ—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞');
    }

    function saveNotificationSettings(){
      const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
      settings.soundNotifications = $('soundNotifications').checked;
      settings.desktopNotifications = $('desktopNotifications').checked;
      localStorage.setItem('flashchat_settings', JSON.stringify(settings));
      
      if(settings.desktopNotifications && Notification.permission === 'default'){
        Notification.requestPermission();
      }
    }

    async function testMicrophone(){
      try {
        const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
        const constraints = {
          audio: settings.microphoneId ? { deviceId: { exact: settings.microphoneId } } : true
        };
        
        testMicStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        showModal('micTestModal');
        
        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Ä–æ–≤–µ–Ω—å –∑–≤—É–∫–∞
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const microphone = audioContext.createMediaStreamSource(testMicStream);
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        microphone.connect(analyser);
        analyser.fftSize = 256;
        
        const updateLevel = () => {
          analyser.getByteFrequencyData(dataArray);
          const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
          const level = Math.min(100, (average / 128) * 100);
          
          $('micTestBar').style.width = level + '%';
          
          if(level > 50){
            $('micTestStatus').textContent = '–û—Ç–ª–∏—á–Ω–æ! –ú–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç';
            $('micTestIcon').style.transform = 'scale(1.1)';
          } else if(level > 20){
            $('micTestStatus').textContent = '–•–æ—Ä–æ—à–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å';
            $('micTestIcon').style.transform = 'scale(1.05)';
          } else {
            $('micTestStatus').textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω...';
            $('micTestIcon').style.transform = 'scale(1)';
          }
          
          micTestAnimationFrame = requestAnimationFrame(updateLevel);
        };
        
        updateLevel();
        
      } catch(err){
        console.error('Mic test error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
      }
    }

    function stopMicTest(){
      if(testMicStream){
        testMicStream.getTracks().forEach(track => track.stop());
        testMicStream = null;
      }
      if(micTestAnimationFrame){
        cancelAnimationFrame(micTestAnimationFrame);
        micTestAnimationFrame = null;
      }
      closeModal('micTestModal');
    }

    async function testCamera(){
      try {
        const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
        const constraints = {
          video: settings.cameraId ? { deviceId: { exact: settings.cameraId } } : true
        };
        
        testCameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        showModal('cameraTestModal');
        
        $('cameraTestVideo').srcObject = testCameraStream;
        
      } catch(err){
        console.error('Camera test error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
      }
    }

    function stopCameraTest(){
      if(testCameraStream){
        testCameraStream.getTracks().forEach(track => track.stop());
        testCameraStream = null;
      }
      $('cameraTestVideo').srcObject = null;
      closeModal('cameraTestModal');
    }

    // ====== SETTINGS (OWNER) ======
    async function showSettings(chatId, type){
      const snap = await database.ref(`${type}s/${chatId}`).once('value');
      const data = snap.val();
      if(!data || data.owner !== currentUser.uid){
        return showToast('‚ùå','–û—à–∏–±–∫–∞','–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
      }

      $('settingsModal').dataset.chatId = chatId;
      $('settingsModal').dataset.type = type;
      pendingAvatarFile = null;

      $('settingsTitle').textContent = type === 'group' ? '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã' : '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞';
      $('settingsName').value = data.name || '';
      $('settingsDescription').value = data.description || '';
      $('deleteButtonText').textContent = type === 'group' ? '–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É' : '–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª';

      // Avatar
      const avatarLetter = $('settingsAvatarLetter');
      const avatarImg = $('settingsAvatarImg');
      const avatarContainer = $('settingsAvatar');
      
      avatarContainer.className = `chat-avatar chat-avatar-lg ${type === 'group' ? 'gradient-green' : 'gradient-orange'} cursor-pointer`;
      
      if(data.avatarUrl){
        avatarLetter.classList.add('hidden');
        avatarImg.classList.remove('hidden');
        avatarImg.src = data.avatarUrl;
      } else {
        avatarLetter.classList.remove('hidden');
        avatarImg.classList.add('hidden');
        avatarLetter.textContent = (data.name || '?').charAt(0).toUpperCase();
      }

      $('settingsDescriptionBlock').style.display = type === 'channel' ? 'block' : 'none';

      const members = data.members || {};
      $('settingsMemberCount').textContent = Object.keys(members).length;

      const list = $('settingsMembersList');
      list.innerHTML = '';

      for(const uid of Object.keys(members)){
        const u = allUsers[uid];
        if(!u) continue;
        const isOwner = uid === data.owner;
        const isSelf = uid === currentUser.uid;

        list.innerHTML += `
          <div class="flex items-center gap-3 p-2 bg-white/5 border border-white/10 rounded-xl">
            <div class="w-8 h-8 rounded-full gradient-bg grid place-items-center font-bold text-sm">${escapeHtml((u.name || '?').charAt(0).toUpperCase())}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm truncate">${getNameWithBadge(u.name || 'Unknown', u.email)} ${isOwner ? '<span class="text-xs text-violet-300">(–≤–ª–∞–¥–µ–ª–µ—Ü)</span>' : ''}</div>
            </div>
            ${(!isSelf && !isOwner) ? `
              <button class="icon-btn" style="width:36px;height:36px" onclick="removeMember('${chatId}','${type}','${uid}')" title="–£–¥–∞–ª–∏—Ç—å">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            ` : ''}
          </div>
        `;
      }

      showModal('settingsModal');
    }

    function handleAvatarSelect(event){
      const file = event.target.files?.[0];
      if(!file) return;

      if(!file.type.startsWith('image/')){
        showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
      }

      pendingAvatarFile = file;
      
      // Preview
      const reader = new FileReader();
      reader.onload = (e) => {
        $('settingsAvatarLetter').classList.add('hidden');
        $('settingsAvatarImg').classList.remove('hidden');
        $('settingsAvatarImg').src = e.target.result;
      };
      reader.readAsDataURL(file);
      
      event.target.value = '';
    }

    async function uploadAvatarToImgBB(file){
      return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('key', IMGBB_API_KEY);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://api.imgbb.com/1/upload');

        xhr.onload = () => {
          try{
            const data = JSON.parse(xhr.responseText);
            if(xhr.status === 200 && data.success){
              resolve(data.data.url);
            } else {
              reject(new Error(data?.error?.message || 'Upload failed'));
            }
          } catch(err){
            reject(new Error('Failed to parse response'));
          }
        };

        xhr.onerror = () => reject(new Error('Network error'));
        xhr.send(formData);
      });
    }

    async function saveSettings(){
      const chatId = $('settingsModal').dataset.chatId;
      const type = $('settingsModal').dataset.type;
      const name = $('settingsName').value.trim();
      const description = $('settingsDescription').value.trim();
      if(!name) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

      const updates = { name };
      if(type === 'channel') updates.description = description;

      try{
        // Upload avatar if changed
        if(pendingAvatarFile){
          showToast('‚è≥','–ó–∞–≥—Ä—É–∑–∫–∞','–ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É...');
          const avatarUrl = await uploadAvatarToImgBB(pendingAvatarFile);
          updates.avatarUrl = avatarUrl;
          pendingAvatarFile = null;
        }

        await database.ref(`${type}s/${chatId}`).update(updates);
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        closeModal('settingsModal');

        // Refresh current chat header if open
        if(currentChat === chatId){
          openChat(chatId, type);
        }

        await loadAllUsers();
        loadAllChats();
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
      }
    }

    async function removeMember(chatId, type, uid){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) return;
      try{
        await database.ref(`${type}s/${chatId}/members/${uid}`).remove();
        await database.ref(`userChats/${uid}/${chatId}`).remove();
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª–µ–Ω');
        showSettings(chatId, type);
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
      }
    }

    async function deleteGroupOrChannel(){
      const chatId = $('settingsModal').dataset.chatId;
      const type = $('settingsModal').dataset.type;
      const typeName = type === 'group' ? '–≥—Ä—É–ø–ø—É' : '–∫–∞–Ω–∞–ª';
      if(!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${typeName}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;

      try{
        const snap = await database.ref(`${type}s/${chatId}/members`).once('value');
        const members = snap.val() || {};

        const updates = {};
        Object.keys(members).forEach(uid => {
          updates[`userChats/${uid}/${chatId}`] = null;
        });
        updates[`messages/${chatId}`] = null;
        updates[`${type}s/${chatId}`] = null;

        await database.ref().update(updates);

        closeModal('settingsModal');
        closeChat();
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ', type === 'group' ? '–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞' : '–ö–∞–Ω–∞–ª —É–¥–∞–ª–µ–Ω');
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
      }
    }

    // ====== GLOBAL EVENTS ======
    document.addEventListener('visibilitychange', () => {
      if(currentUser) updateOnlineStatus(!document.hidden);
      if(!document.hidden && currentChat) markAsRead(currentChat);
    });

    window.addEventListener('resize', () => {
      if(!$('chatScreen').classList.contains('active')) return;

      if(window.innerWidth <= 768){
        if(currentChat){
          $('sidebar').style.display = 'none';
          $('chatArea').style.display = 'flex';
          $('chatArea').classList.add('active');
        } else {
          $('sidebar').style.display = 'flex';
          $('chatArea').style.display = 'none';
          $('chatArea').classList.remove('active');
        }
      } else {
        $('sidebar').style.display = 'flex';
        $('chatArea').style.display = 'flex';
        $('chatArea').classList.remove('active');
      }
    });

    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){
        ['createMenuModal','newPrivateChatModal','createGroupModal','createChannelModal','accountSwitcherModal','profileModal','appSettingsModal','settingsModal','editMessageModal','micTestModal','cameraTestModal'].forEach(id => closeModal(id));
        closeImageViewer();
        closeConfirmModal();
        hideMessageContextMenu();
        closeEmoji();
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        stopMicTest();
        stopCameraTest();
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ confirmModal –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    $('confirmModal').addEventListener('click', (e) => {
      if(e.target.id === 'confirmModal') closeConfirmModal();
    });

    // Close emoji picker on outside click (Telegram-like)
    document.addEventListener('click', (e) => {
      const picker = $('emojiPicker');
      if(!picker.classList.contains('show')) return;

      const inputArea = $('messageInputArea');
      if(inputArea && inputArea.contains(e.target)) return;

      closeEmoji();
    });

    // ====== VOICE MESSAGES ======
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –∏–∑ Firebase Database
    async function loadFirebaseFile(fileId) {
      try {
        const fileSnapshot = await database.ref(`files/${fileId}`).once('value');
        const fileData = fileSnapshot.val();
        
        if (!fileData || !fileData.data) {
          throw new Error('File not found');
        }
        
        return fileData.data; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º base64 data URL
      } catch(err) {
        console.error('Error loading firebase file:', err);
        throw err;
      }
    }
    
    // –ö—ç—à –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫
    const avatarCache = new Map();
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–∫
    async function loadAvatar(avatarUrl) {
      if(!avatarUrl) return null;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
      if(avatarCache.has(avatarUrl)){
        return avatarCache.get(avatarUrl);
      }
      
      // –ï—Å–ª–∏ —ç—Ç–æ firebase-file:// URL
      if(avatarUrl.startsWith('firebase-file://')){
        try {
          const fileId = avatarUrl.replace('firebase-file://', '');
          const base64Data = await loadFirebaseFile(fileId);
          avatarCache.set(avatarUrl, base64Data);
          return base64Data;
        } catch(err) {
          console.error('Error loading avatar:', err);
          return null;
        }
      }
      
      // –û–±—ã—á–Ω—ã–π URL
      avatarCache.set(avatarUrl, avatarUrl);
      return avatarUrl;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∏–∑ Firebase Database
    async function downloadFirebaseFile(fileUrl, fileName) {
      try {
        showToast('‚è≥', '–ó–∞–≥—Ä—É–∑–∫–∞', '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...');
        
        const fileId = fileUrl.replace('firebase-file://', '');
        const base64Data = await loadFirebaseFile(fileId);
        
        // –°–æ–∑–¥–∞—ë–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const link = document.createElement('a');
        link.href = base64Data;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–§–∞–π–ª —Å–∫–∞—á–∞–Ω');
      } catch(err) {
        console.error('Error downloading file:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª');
      }
    }
    
    function generateWaveform(){
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é –≤–æ–ª–Ω–æ–≤—É—é —Ñ–æ—Ä–º—É (40 –ø–æ–ª–æ—Å–æ–∫)
      const bars = [];
      for(let i = 0; i < 40; i++){
        const height = Math.random() * 20 + 8;
        bars.push(`<div class="voice-bar" style="height:${height}px"></div>`);
      }
      return bars.join('');
    }

    async function toggleVoicePlayback(msgId, audioUrl, mimeType){
      const voiceMsg = document.querySelector(`[data-msg-id="${msgId}"]`);
      if(!voiceMsg) {
        console.error('Voice message element not found:', msgId);
        return;
      }

      const playBtn = voiceMsg.querySelector('.voice-play-btn');
      const playIcon = playBtn.querySelector('.play-icon');
      const pauseIcon = playBtn.querySelector('.pause-icon');
      const waveform = voiceMsg.querySelector('.voice-waveform');
      const bars = waveform.querySelectorAll('.voice-bar');

      // –ï—Å–ª–∏ –∏–≥—Ä–∞–µ—Ç –¥—Ä—É–≥–æ–µ –∞—É–¥–∏–æ - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
      if(currentPlayingAudio && currentPlayingAudio.msgId !== msgId){
        stopCurrentAudio();
      }

      // –ï—Å–ª–∏ —ç—Ç–æ –∞—É–¥–∏–æ —É–∂–µ –∏–≥—Ä–∞–µ—Ç - —Å—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É
      if(currentPlayingAudio && currentPlayingAudio.msgId === msgId){
        currentPlayingAudio.audio.pause();
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        bars.forEach(bar => bar.classList.remove('active'));
        currentPlayingAudio = null;
        return;
      }

      console.log('Playing voice message:', msgId, audioUrl);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL
      if(!audioUrl || audioUrl === 'undefined' || audioUrl === 'null'){
        console.error('Invalid audio URL:', audioUrl);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ–≤–µ—Ä–Ω—ã–π URL –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞');
        return;
      }

      try {
        // –ï—Å–ª–∏ —ç—Ç–æ firebase-file:// URL, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ Firebase Database
        let actualAudioUrl = audioUrl;
        if(audioUrl.startsWith('firebase-file://')){
          const fileId = audioUrl.replace('firebase-file://', '');
          console.log('Loading firebase file:', fileId);
          actualAudioUrl = await loadFirebaseFile(fileId);
        }

        // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç audio
        const audio = document.createElement('audio');
        audio.preload = 'auto';
        audio.volume = 1.0;
        audio.controls = false;
        audio.src = actualAudioUrl;
        
        currentPlayingAudio = { audio, msgId, bars };

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –ø–∞—É–∑—ã
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';

        // –ê–Ω–∏–º–∞—Ü–∏—è –≤–æ–ª–Ω–æ–≤–æ–π —Ñ–æ—Ä–º—ã
        let currentBar = 0;
        const animateWaveform = () => {
          if(!currentPlayingAudio || currentPlayingAudio.msgId !== msgId) return;
          
          bars.forEach((bar, i) => {
            bar.classList.toggle('active', i === currentBar);
          });
          
          currentBar = (currentBar + 1) % bars.length;
          
          if(!audio.paused){
            setTimeout(animateWaveform, 50);
          }
        };

        audio.onplay = () => {
          animateWaveform();
        };

        audio.onended = () => {
          playIcon.style.display = 'block';
          pauseIcon.style.display = 'none';
          bars.forEach(bar => bar.classList.remove('active'));
          currentPlayingAudio = null;
        };

        audio.onerror = (e) => {
          console.error('Audio playback error:', audio.error);
          
          let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞—É–¥–∏–æ';
          if(audio.error){
            switch(audio.error.code){
              case 1: errorMsg = '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞'; break;
              case 2: errorMsg = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'; break;
              case 3: errorMsg = '–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è'; break;
              case 4: errorMsg = '–§–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'; break;
            }
          }
          
          showToast('‚ùå', '–û—à–∏–±–∫–∞', errorMsg);
          
          playIcon.style.display = 'block';
          pauseIcon.style.display = 'none';
          bars.forEach(bar => bar.classList.remove('active'));
          currentPlayingAudio = null;
        };

        // –ü—Ä–æ–±—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
        const playPromise = audio.play();
        
        if(playPromise !== undefined) {
          playPromise.catch(err => {
            console.error('Playback failed:', err);
            
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
            currentPlayingAudio = null;
            
            if(err.name === 'NotAllowedError'){
              showToast('‚ö†Ô∏è', '–í–Ω–∏–º–∞–Ω–∏–µ', '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –µ—â–µ —Ä–∞–∑');
            } else {
              showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞—É–¥–∏–æ');
            }
          });
        }
      } catch(err) {
        console.error('Error in toggleVoicePlayback:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ —Ñ–∞–π–ª');
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
      }
    }

    function stopCurrentAudio(){
      if(!currentPlayingAudio) return;
      
      const { audio, msgId, bars } = currentPlayingAudio;
      audio.pause();
      audio.currentTime = 0;
      
      const voiceMsg = document.querySelector(`[data-msg-id="${msgId}"]`);
      if(voiceMsg){
        const playBtn = voiceMsg.querySelector('.voice-play-btn');
        const playIcon = playBtn.querySelector('.play-icon');
        const pauseIcon = playBtn.querySelector('.pause-icon');
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        bars.forEach(bar => bar.classList.remove('active'));
      }
      
      currentPlayingAudio = null;
    }

    async function startVoiceRecording(e){
      if(e) e.preventDefault();
      if(!currentChat) {
        showToast('‚ö†Ô∏è', '–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
      }
      
      // –ï—Å–ª–∏ —É–∂–µ –∏–¥—ë—Ç –∑–∞–ø–∏—Å—å, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
      if(mediaRecorder && mediaRecorder.state === 'recording') return;
      
      try {
        console.log('Requesting microphone access...');
        
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        const constraints = {
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 48000
          }
        };
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω
        if(settings.microphoneId){
          constraints.audio.deviceId = { exact: settings.microphoneId };
        }
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        console.log('Microphone access granted');
        console.log('Audio tracks:', stream.getAudioTracks().length);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç—Ä–µ–∫ –∞–∫—Ç–∏–≤–µ–Ω
        const audioTrack = stream.getAudioTracks()[0];
        if(audioTrack){
          console.log('Audio track settings:', audioTrack.getSettings());
          console.log('Audio track enabled:', audioTrack.enabled);
          console.log('Audio track muted:', audioTrack.muted);
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π MIME —Ç–∏–ø
        let mimeType = 'audio/webm';
        if(!MediaRecorder.isTypeSupported('audio/webm')){
          if(MediaRecorder.isTypeSupported('audio/mp4')){
            mimeType = 'audio/mp4';
          } else if(MediaRecorder.isTypeSupported('audio/ogg')){
            mimeType = 'audio/ogg';
          } else if(MediaRecorder.isTypeSupported('audio/wav')){
            mimeType = 'audio/wav';
          }
        }
        
        console.log('Using MIME type:', mimeType);
        
        mediaRecorder = new MediaRecorder(stream, { mimeType });
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (e) => {
          console.log('üìä Data available:', e.data.size, 'bytes, type:', e.data.type);
          if(e.data.size > 0){
            audioChunks.push(e.data);
            console.log('‚úÖ Chunk added. Total chunks:', audioChunks.length);
          } else {
            console.warn('‚ö†Ô∏è Empty chunk received');
          }
        };
        
        mediaRecorder.onstop = async () => {
          console.log('üõë Recording stopped');
          console.log('Total chunks:', audioChunks.length);
          
          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏
          stream.getTracks().forEach(track => {
            console.log('Stopping track:', track.kind, track.label);
            track.stop();
          });
          
          if(audioChunks.length === 0){
            console.error('‚ùå No audio data recorded!');
            showToast('‚ö†Ô∏è', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –∞—É–¥–∏–æ');
            return;
          }
          
          // –°–æ–∑–¥–∞–µ–º blob –∏–∑ –≤—Å–µ—Ö chunks
          const audioBlob = new Blob(audioChunks, { type: mimeType });
          console.log('üì¶ Audio blob created:');
          console.log('  - Size:', audioBlob.size, 'bytes');
          console.log('  - Type:', audioBlob.type);
          console.log('  - Chunks used:', audioChunks.length);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä
          if(audioBlob.size < 100){
            console.error('‚ùå Audio blob too small:', audioBlob.size);
            showToast('‚ö†Ô∏è', '–û—à–∏–±–∫–∞', '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ');
            return;
          }
          
          console.log('‚úÖ Audio blob valid, sending...');
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          await sendVoiceMessage(audioBlob, mimeType);
        };
        
        mediaRecorder.onerror = (e) => {
          console.error('MediaRecorder error:', e);
          showToast('‚ùå', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ');
        };
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å —Å timeslice –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        mediaRecorder.start(100); // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 100ms
        console.log('Recording started with timeslice 100ms');
        recordingStartTime = Date.now();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
        $('recordingIndicator').classList.remove('hidden');
        $('voiceBtn').style.background = 'rgba(239,68,68,.25)';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
        updateRecordingTime();
        recordingInterval = setInterval(updateRecordingTime, 1000);
        
      } catch(err) {
        console.error('Voice recording error:', err);
        if(err.name === 'NotAllowedError'){
          showToast('‚ùå', '–û—à–∏–±–∫–∞', '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞');
        } else if(err.name === 'NotFoundError'){
          showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
        } else {
          showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å: ' + err.message);
        }
      }
    }

    function stopVoiceRecording(e){
      if(e) e.preventDefault();
      console.log('Stopping recording...');
      
      if(!mediaRecorder || mediaRecorder.state === 'inactive') {
        console.log('No active recording');
        return;
      }
      
      mediaRecorder.stop();
      clearInterval(recordingInterval);
      
      $('recordingIndicator').classList.add('hidden');
      $('voiceBtn').style.background = '';
    }

    function cancelRecording(){
      console.log('Cancelling recording...');
      
      if(!mediaRecorder) return;
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏
      if(mediaRecorder.state !== 'inactive'){
        // –û—á–∏—â–∞–µ–º chunks –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π, —á—Ç–æ–±—ã onstop –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ
        audioChunks = [];
        mediaRecorder.stop();
        if(mediaRecorder.stream){
          mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
      }
      
      clearInterval(recordingInterval);
      
      $('recordingIndicator').classList.add('hidden');
      $('voiceBtn').style.background = '';
      
      mediaRecorder = null;
      recordingStartTime = null;
    }

    function updateRecordingTime(){
      if(!recordingStartTime) return;
      
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      $('recordingTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    async function sendVoiceMessage(audioBlob, mimeType){
      console.log('üé§ Sending voice message...');
      
      if(!currentChat) {
        console.error('No current chat!');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–Ω
      const banSnap = await database.ref(`bannedUsers/${currentUser.uid}`).once('value');
      if(banSnap.exists()){
        showToast('üö´', '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è');
        await auth.signOut();
        return;
      }
      
      try {
        // –í—ã—á–∏—Å–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        const durationStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        showToast('‚è≥', '–û—Ç–ø—Ä–∞–≤–∫–∞', '–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...');
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º blob –≤ base64
        const reader = new FileReader();
        const base64Promise = new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(audioBlob);
        });
        
        const base64Data = await base64Promise;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –≤ Firebase Database
        const fileRef = database.ref('files').push();
        const fileId = fileRef.key;
        
        await fileRef.set({
          data: base64Data,
          mimeType: mimeType,
          uploadedBy: currentUser.uid,
          uploadedAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        // –°–æ–∑–¥–∞—ë–º firebase-file:// URL
        const audioUrl = `firebase-file://${fileId}`;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        const msgData = {
          senderId: currentUser.uid,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          isVoiceMessage: true,
          fileUrl: audioUrl,
          fileType: mimeType,
          fileName: `–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ`,
          audioDuration: durationStr
        };
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–ª–∏ –æ–±—ã—á–Ω—ã–π —á–∞—Ç
        if(currentChatType === 'saved'){
          await database.ref(`savedMessages/${currentUser.uid}`).push(msgData);
        } else {
          await database.ref(`messages/${currentChat}`).push(msgData);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ)
        if(currentChatType !== 'saved'){
          await database.ref(`userChats/${currentUser.uid}/${currentChat}`).update({
            lastMessage: 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
            lastTime: firebase.database.ServerValue.TIMESTAMP
          });
          
          // –î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —á–∞—Ç–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º –∏ —É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
          if(currentChatType === 'private' && currentChatData?.oderId){
            await database.ref(`userChats/${currentChatData.oderId}/${currentChat}`).update({
              lastMessage: 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
              lastTime: firebase.database.ServerValue.TIMESTAMP
            });
          }
          
          // –î–ª—è –≥—Ä—É–ø–ø –∏ –∫–∞–Ω–∞–ª–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º —É –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
          if((currentChatType === 'group' || currentChatType === 'channel') && currentChatData?.members){
            const updates = {};
            for(const memberId of Object.keys(currentChatData.members)){
              if(memberId !== currentUser.uid){
                updates[`userChats/${memberId}/${currentChat}/lastMessage`] = 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
                updates[`userChats/${memberId}/${currentChat}/lastTime`] = firebase.database.ServerValue.TIMESTAMP;
              }
            }
            if(Object.keys(updates).length > 0){
              await database.ref().update(updates);
            }
          }
        }
        
        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
        
      } catch(err) {
        console.error('Send voice message error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + err.message);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞
    function initVoiceButton(){
      const voiceBtn = $('voiceBtn');
      if(!voiceBtn) return;
      
      let isRecording = false;
      
      // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
      voiceBtn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        if(!isRecording){
          isRecording = true;
          startVoiceRecording(e);
        }
      });
      
      voiceBtn.addEventListener('mouseup', (e) => {
        e.preventDefault();
        if(isRecording){
          isRecording = false;
          stopVoiceRecording(e);
        }
      });
      
      voiceBtn.addEventListener('mouseleave', (e) => {
        if(isRecording){
          isRecording = false;
          stopVoiceRecording(e);
        }
      });
      
      // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      voiceBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if(!isRecording){
          isRecording = true;
          startVoiceRecording(e);
        }
      });
      
      voiceBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        if(isRecording){
          isRecording = false;
          stopVoiceRecording(e);
        }
      });
      
      voiceBtn.addEventListener('touchcancel', (e) => {
        e.preventDefault();
        if(isRecording){
          isRecording = false;
          cancelRecording();
        }
      });
      
      console.log('Voice button initialized');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–ø–∏—Å–∏ –∫—Ä—É–∂–∫–æ–≤ (–≤–∏–¥–µ–æ)
    function initCircleButton(){
      const circleBtn = $('circleBtn');
      if(!circleBtn) return;
      
      let isRecording = false;
      
      // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
      circleBtn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        if(!isRecording){
          isRecording = true;
          startCircleRecording(e);
        }
      });
      
      circleBtn.addEventListener('mouseup', (e) => {
        e.preventDefault();
        if(isRecording){
          isRecording = false;
          stopCircleRecording(e);
        }
      });
      
      circleBtn.addEventListener('mouseleave', (e) => {
        if(isRecording){
          isRecording = false;
          stopCircleRecording(e);
        }
      });
      
      // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      circleBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if(!isRecording){
          isRecording = true;
          startCircleRecording(e);
        }
      });
      
      circleBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        if(isRecording){
          isRecording = false;
          stopCircleRecording(e);
        }
      });
      
      circleBtn.addEventListener('touchcancel', (e) => {
        e.preventDefault();
        if(isRecording){
          isRecording = false;
          cancelCircleRecording();
        }
      });
      
      console.log('Circle button initialized');
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∫—Ä—É–∂–∫–æ–≤
    let circleMediaRecorder;
    let circleChunks = [];
    let circleRecordingStartTime;
    let circleRecordingInterval;

    async function startCircleRecording(e){
      if(e) e.preventDefault();
      if(!currentChat) {
        showToast('‚ö†Ô∏è', '–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫—Ä—É–∂–∫–∞');
        return;
      }
      
      if(circleMediaRecorder && circleMediaRecorder.state === 'recording') return;
      
      try {
        console.log('Requesting camera and microphone access...');
        
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
        
        const constraints = {
          video: { 
            width: { ideal: 720 },
            height: { ideal: 720 },
            facingMode: 'user'
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        };
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∫–∞–º–µ—Ä–∞
        if(settings.cameraId){
          constraints.video.deviceId = { exact: settings.cameraId };
        }
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω
        if(settings.microphoneId){
          constraints.audio.deviceId = { exact: settings.microphoneId };
        }
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        console.log('Camera access granted');
        
        let mimeType = 'video/webm';
        if(!MediaRecorder.isTypeSupported('video/webm')){
          if(MediaRecorder.isTypeSupported('video/mp4')){
            mimeType = 'video/mp4';
          }
        }
        
        console.log('Using MIME type:', mimeType);
        
        circleMediaRecorder = new MediaRecorder(stream, { mimeType });
        circleChunks = [];
        
        circleMediaRecorder.ondataavailable = (e) => {
          if(e.data.size > 0){
            circleChunks.push(e.data);
          }
        };
        
        circleMediaRecorder.onstop = async () => {
          console.log('Circle recording stopped');
          stream.getTracks().forEach(track => track.stop());
          
          if(circleChunks.length === 0){
            showToast('‚ö†Ô∏è', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ');
            return;
          }
          
          const videoBlob = new Blob(circleChunks, { type: mimeType });
          console.log('Video blob size:', videoBlob.size);
          
          if(videoBlob.size < 1000){
            showToast('‚ö†Ô∏è', '–û—à–∏–±–∫–∞', '–ö—Ä—É–∂–æ–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π');
            return;
          }
          
          await sendCircleMessage(videoBlob, mimeType);
        };
        
        circleMediaRecorder.start(100);
        circleRecordingStartTime = Date.now();
        
        $('recordingIndicator').classList.remove('hidden');
        $('circleBtn').style.background = 'rgba(239,68,68,.25)';
        
        updateCircleRecordingTime();
        circleRecordingInterval = setInterval(updateCircleRecordingTime, 1000);
        
      } catch(err) {
        console.error('Circle recording error:', err);
        if(err.name === 'NotAllowedError'){
          showToast('‚ùå', '–û—à–∏–±–∫–∞', '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â—ë–Ω');
        } else if(err.name === 'NotFoundError'){
          showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        } else {
          showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å: ' + err.message);
        }
      }
    }

    function stopCircleRecording(e){
      if(e) e.preventDefault();
      
      if(!circleMediaRecorder || circleMediaRecorder.state === 'inactive') return;
      
      circleMediaRecorder.stop();
      clearInterval(circleRecordingInterval);
      
      $('recordingIndicator').classList.add('hidden');
      $('circleBtn').style.background = '';
    }

    function cancelCircleRecording(){
      if(!circleMediaRecorder) return;
      
      if(circleMediaRecorder.state !== 'inactive'){
        circleChunks = [];
        circleMediaRecorder.stop();
        if(circleMediaRecorder.stream){
          circleMediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
      }
      
      clearInterval(circleRecordingInterval);
      $('recordingIndicator').classList.add('hidden');
      $('circleBtn').style.background = '';
      
      circleMediaRecorder = null;
      circleRecordingStartTime = null;
    }

    function updateCircleRecordingTime(){
      if(!circleRecordingStartTime) return;
      
      const elapsed = Math.floor((Date.now() - circleRecordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      $('recordingTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    async function sendCircleMessage(videoBlob, mimeType){
      console.log('Sending circle message...');
      
      if(!currentChat) return;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–Ω
      const banSnap = await database.ref(`bannedUsers/${currentUser.uid}`).once('value');
      if(banSnap.exists()){
        showToast('üö´', '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è');
        await auth.signOut();
        return;
      }
      
      try {
        const duration = Math.floor((Date.now() - circleRecordingStartTime) / 1000);
        
        showToast('‚è≥', '–û—Ç–ø—Ä–∞–≤–∫–∞', '–ó–∞–≥—Ä—É–∑–∫–∞ –∫—Ä—É–∂–∫–∞...');
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º blob –≤ base64
        const reader = new FileReader();
        const base64Promise = new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(videoBlob);
        });
        
        const base64Data = await base64Promise;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –≤ Firebase Database
        const fileRef = database.ref('files').push();
        const fileId = fileRef.key;
        
        await fileRef.set({
          data: base64Data,
          mimeType: mimeType,
          uploadedBy: currentUser.uid,
          uploadedAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        // –°–æ–∑–¥–∞—ë–º firebase-file:// URL
        const videoUrl = `firebase-file://${fileId}`;
        
        const msgData = {
          senderId: currentUser.uid,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          isVideoMessage: true,
          fileUrl: videoUrl,
          fileType: mimeType,
          fileName: '–ö—Ä—É–∂–æ–∫',
          isCircle: true
        };
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–ª–∏ –æ–±—ã—á–Ω—ã–π —á–∞—Ç
        if(currentChatType === 'saved'){
          await database.ref(`savedMessages/${currentUser.uid}`).push(msgData);
        } else {
          await database.ref(`messages/${currentChat}`).push(msgData);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ)
        if(currentChatType !== 'saved'){
          await database.ref(`userChats/${currentUser.uid}/${currentChat}`).update({
            lastMessage: 'üé• –ö—Ä—É–∂–æ–∫',
            lastTime: firebase.database.ServerValue.TIMESTAMP
          });
          
          if(currentChatType === 'private' && currentChatData?.oderId){
            await database.ref(`userChats/${currentChatData.oderId}/${currentChat}`).update({
              lastMessage: 'üé• –ö—Ä—É–∂–æ–∫',
              lastTime: firebase.database.ServerValue.TIMESTAMP
            });
          }
          
          // –î–ª—è –≥—Ä—É–ø–ø –∏ –∫–∞–Ω–∞–ª–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º —É –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
          if((currentChatType === 'group' || currentChatType === 'channel') && currentChatData?.members){
            const updates = {};
            for(const memberId of Object.keys(currentChatData.members)){
              if(memberId !== currentUser.uid){
                updates[`userChats/${memberId}/${currentChat}/lastMessage`] = 'üé• –ö—Ä—É–∂–æ–∫';
                updates[`userChats/${memberId}/${currentChat}/lastTime`] = firebase.database.ServerValue.TIMESTAMP;
              }
            }
            if(Object.keys(updates).length > 0){
              await database.ref().update(updates);
            }
          }
        }
        
        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–ö—Ä—É–∂–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        
      } catch(err) {
        console.error('Send circle error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—Ä—É–∂–æ–∫');
      }
    }

    // ====== INIT ======
    loadSavedAccounts();
    renderEmojiCategory('smileys');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
    const savedSettings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
    const theme = savedSettings.theme || 'dark';
    applyTheme(theme);
    
    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã –¥–ª—è —Ä–µ–∂–∏–º–∞ "–∞–≤—Ç–æ"
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
      if(settings.theme === 'auto'){
        applyTheme('auto');
      }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    document.addEventListener('DOMContentLoaded', () => {
      initVoiceButton();
      initCircleButton();
    });
    
    // –ï—Å–ª–∏ DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    if(document.readyState === 'complete' || document.readyState === 'interactive'){
      setTimeout(() => {
        initVoiceButton();
        initCircleButton();
      }, 100);
    }
  </script>
</body>
</html>