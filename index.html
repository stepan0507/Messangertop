<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>FlashChat Pro ‚Äî –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#111827;
      --card:rgba(31,41,55,.6);
      --border:rgba(148,163,184,.15);
      --muted:#9ca3af;
      --text:#e5e7eb;
      --purple:#8b5cf6;
      --blue:#60a5fa;
      --message-font-size: 14px;
    }

    *{ box-sizing:border-box; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; margin:0; padding:0; }

    body{
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
      height:100vh;
      height:100svh;
      height:100dvh;
      touch-action: pan-y pinch-zoom;
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏–µ touch –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    button, .icon-btn, .send-btn {
      touch-action: manipulation;
    }

    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º */
    body.compact-mode .message-row{ margin-bottom: 2px; }
    body.compact-mode .bubble{ padding: 6px 10px; }
    body.compact-mode #messagesContainer{ padding: 8px; }

    /* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π */
    body.no-animations *,
    body.no-animations *::before,
    body.no-animations *::after {
      animation-duration: 0s !important;
      transition-duration: 0s !important;
    }

    .gradient-bg{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .gradient-green{ background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .gradient-orange{ background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .glass{ background: rgba(255,255,255,.06); backdrop-filter: blur(14px); }

    /* Custom Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(148, 163, 184, 0.3);
      transition: 0.3s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch input:checked + .toggle-slider {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }

    .toggle-switch input:disabled + .toggle-slider {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Custom Range Slider */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 5px;
      background: rgba(148, 163, 184, 0.2);
      outline: none;
      transition: background 0.3s;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
      transition: all 0.2s;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
      transition: all 0.2s;
    }

    input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
    }

    input[type="range"]::-webkit-slider-runnable-track {
      height: 6px;
      border-radius: 5px;
      background: rgba(148, 163, 184, 0.2);
    }

    input[type="range"]::-moz-range-track {
      height: 6px;
      border-radius: 5px;
      background: rgba(148, 163, 184, 0.2);
    }

    /* Light theme adjustments */
    body.light-theme input[type="range"] {
      background: rgba(148, 163, 184, 0.3);
    }

    body.light-theme input[type="range"]::-webkit-slider-runnable-track {
      background: rgba(148, 163, 184, 0.3);
    }

    body.light-theme input[type="range"]::-moz-range-track {
      background: rgba(148, 163, 184, 0.3);
    }

    body.light-theme .toggle-slider {
      background-color: rgba(148, 163, 184, 0.4);
    }

    /* App shell */
    #appShell{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
      height:100vh;
      height:100svh;
      height:100dvh;
      overflow:hidden;
    }

    #authScreen{ position:absolute; inset:0; overflow:auto; -webkit-overflow-scrolling:touch; }

    #chatScreen{ position:absolute; inset:0; display:none; }
    #chatScreen.active{ display:flex; }

    /* === RESPONSIVE LAYOUT === */
    
    /* Desktop (>1200px) */
    #sidebar{ 
      width:380px; 
      min-width:320px; 
      max-width:420px;
      display:flex; 
      flex-direction:column; 
      height:100%; 
      border-right:1px solid var(--border); 
      background:rgba(15, 23, 42, .55); 
    }
    #chatArea{ 
      flex:1 1 auto; 
      min-width:0; 
      display:flex; 
      flex-direction:column; 
      height:100%; 
      background:rgba(2,6,23,.35); 
    }

    /* Tablet (769px - 1200px) */
    @media (min-width: 769px) and (max-width: 1200px){
      #sidebar{ width:320px; min-width:280px; max-width:350px; }
    }

    /* Mobile (<=768px) */
    @media (max-width: 768px){
      #chatScreen.active{ display:block; }
      #sidebar, #chatArea{ 
        position:absolute; 
        inset:0; 
        width:100%; 
        max-width:none; 
        min-width:0; 
        height:100%; 
        height:100svh; 
        height:100dvh; 
      }
      #sidebar{ display:flex; }
      #chatArea{ display:none; }
      #chatArea.active{ display:flex; }
      
      /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ –≤–≤–æ–¥–∞ */
      #messageForm{ gap: 4px; }
      .icon-btn{ width: 40px; height: 40px; min-width: 40px; min-height: 40px; }
      .send-btn{ width: 40px; height: 40px; min-width: 40px; min-height: 40px; }
      #messageInput{ font-size: 14px; padding: 0 12px; }
    }

    @supports (height: -webkit-fill-available){
      body{ height: -webkit-fill-available; }
      #appShell{ height: -webkit-fill-available; }
    }

    /* Sidebar internals */
    #chatList{ flex:1 1 auto; min-height:0; overflow:auto; -webkit-overflow-scrolling:touch; }
    #searchResults{ max-height: 40vh; overflow:auto; }

    /* Chat area internals */
    #emptyChat{ flex:1 1 auto; display:flex; align-items:center; justify-content:center; padding:24px; }
    #activeChat{ flex:1 1 auto; min-height:0; display:none; flex-direction:column; overflow:hidden; }
    #activeChat.active{ display:flex; }
    .chat-header{ flex:0 0 auto; border-bottom:1px solid var(--border); background:rgba(15, 23, 42, .85); }

    #messagesContainer{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding:16px;
      padding-bottom:20px;
    }

    #typingIndicator{ flex:0 0 auto; position:relative; z-index:5; }
    #uploadPreview{ flex:0 0 auto; }

    /* Input pinned */
    #messageInputArea{
      flex:0 0 auto;
      border-top:1px solid var(--border);
      background:rgba(15, 23, 42, .92);
      padding:10px;
      padding-bottom:max(10px, env(safe-area-inset-bottom));
    }

    #messageForm{ display:flex; align-items:center; gap:8px; flex-wrap:nowrap; }
    #messageInput{
      flex:1 1 auto;
      min-width:0;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(31,41,55,.5);
      color:white;
      padding:0 14px;
      font-size:15px;
      outline:none;
    }
    #messageInput:focus{ border-color: rgba(139,92,246,.9); box-shadow: 0 0 0 3px rgba(139,92,246,.15); }

    .icon-btn{
      width:44px; height:44px;
      display:grid; place-items:center;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(31,41,55,.25);
      color:#cbd5e1;
      flex:0 0 auto;
      cursor:pointer;
      transition: all .15s;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }
    .icon-btn:hover{ background:rgba(31,41,55,.45); color:white; }
    .icon-btn:active{ transform: scale(0.95); background:rgba(31,41,55,.6); }
    
    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
    .video-btn{ color:#06b6d4; border-color:rgba(6,182,212,.3); }
    .video-btn:hover{ background:rgba(6,182,212,.15); color:#22d3ee; }
    .video-btn:active{ background:rgba(6,182,212,.25); }
    .voice-btn{ color:#f97316; border-color:rgba(249,115,22,.3); }
    .voice-btn:hover{ background:rgba(249,115,22,.15); color:#fb923c; }
    .voice-btn:active{ background:rgba(249,115,22,.25); }

    .send-btn{
      width:44px; height:44px;
      display:grid; place-items:center;
      border-radius:14px;
      border:none;
      color:white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 8px 20px rgba(102,126,234,.28);
      flex:0 0 auto;
      cursor:pointer;
      transition: all .15s;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }
    .send-btn:hover{ opacity:.92; }
    .send-btn:active{ transform: scale(0.95); opacity:.85; }
    .send-btn:hover{ opacity:.92; }

    /* Scrollbars */
    .scrollbar::-webkit-scrollbar{ width:6px; height:6px; }
    .scrollbar::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.25); border-radius:999px; }
    .scrollbar::-webkit-scrollbar-track{ background: transparent; }

    /* === MESSAGES - RESPONSIVE (TG-like bubbles) === */
    .message-row{ display:flex; width:100%; margin-bottom:6px; }
    .message-row.out{ justify-content:flex-end; }
    .message-row.in{ justify-content:flex-start; }

    /*
      IMPORTANT:
      –ù–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö (–æ—Å–æ–±–µ–Ω–Ω–æ Safari) "—Ä–∞–Ω–Ω–∏–π –ø–µ—Ä–µ–Ω–æ—Å" —Å–ª—É—á–∞–µ—Ç—Å—è,
      –∫–æ–≥–¥–∞ –æ–±—ë—Ä—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∂–∏–º–∞–µ—Ç—Å—è –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É, –∞ max-width –≤ % —Å—á–∏—Ç–∞–µ—Ç—Å—è
      –æ—Ç —ç—Ç–æ–π –º–∞–ª–µ–Ω—å–∫–æ–π —à–∏—Ä–∏–Ω—ã. –ü–æ—ç—Ç–æ–º—É –æ–±—ë—Ä—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å width:100%.
    */
    .message-row > div{
      width:100%;
      display:flex;
      flex-direction:column;
      min-width:0;
      max-width:100%;
    }
    .message-row.out > div{ align-items:flex-end; }
    .message-row.in > div{ align-items:flex-start; }

    /* Bubble: –Ω–µ –∑–∞–¥–∞—ë–º width:fit-content, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–µ–π —Å —Ä–∞—Å—á—ë—Ç–æ–º —à–∏—Ä–∏–Ω—ã –≤ flex.
       Inline-block —Å–∞–º —Å–æ–∂–º—ë—Ç—Å—è –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É, –∞ max-width –æ–≥—Ä–∞–Ω–∏—á–∏—Ç –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. */
    .bubble{
      display:inline-block;
      max-width: 72%;
      border-radius:18px;
      padding:10px 14px;
      position:relative;
      overflow:hidden;
      text-align:left;
      white-space: normal;
      /* –Ω–µ –ª–æ–º–∞–µ–º —Å–ª–æ–≤–∞ ¬´—Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏¬ª */
      overflow-wrap: normal;
      word-break: normal;
      hyphens: manual;
    }
    .bubble.out{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-top-right-radius:6px; }
    .bubble.in{ background: rgba(31,41,55,.75); border-top-left-radius:6px; border:1px solid rgba(148,163,184,.12); }

    /* Tablet bubbles */
    @media (min-width: 769px) and (max-width: 1200px){
      .bubble{ max-width: 78%; }
    }

    /* Mobile bubbles */
    @media (max-width: 768px){
      .bubble{ max-width: 88%; padding: 8px 12px; }
      #messagesContainer{ padding: 10px; }
    }

    /* Small phones */
    @media (max-width: 400px){
      .bubble{ max-width: 92%; padding: 7px 10px; font-size: 14px; }
      #messagesContainer{ padding: 8px; }
      
      /* –ï—â—ë –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞ */
      #messageForm{ gap: 3px; }
      .icon-btn{ width: 38px; height: 38px; min-width: 38px; min-height: 38px; }
      .icon-btn svg{ width: 20px; height: 20px; }
      .send-btn{ width: 38px; height: 38px; min-width: 38px; min-height: 38px; }
      .send-btn svg{ width: 20px; height: 20px; }
      #messageInput{ font-size: 13px; padding: 0 10px; height: 38px; }
    }

    .msg-wrap{ width:100%; min-width:0; max-width:100%; display:flex; flex-direction:column; }

    .sender-line{ font-size:12px; color: rgba(167,139,250, .95); margin: 0 0 6px 2px; display:flex; align-items:center; gap:6px; }

    /* Prevent time/checks from wrapping and causing bubble width jumps */
    .meta{ display:flex; justify-content:flex-end; align-items:center; gap:6px; margin-top:6px; white-space:nowrap; }
    .meta .time{ font-size:11px; color: rgba(255,255,255,.75); }
    .bubble.in .meta .time{ color: rgba(148,163,184,.85); }

    /* === MEDIA IN MESSAGES - RESPONSIVE === */
    .message-media{
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.45);
      display:inline-block; /* don't stretch the bubble */
      width: fit-content;
      max-width: 100%;
    }
    .message-media img, .message-media video{
      display:block;
      width:auto;
      height:auto;
      max-width:100%;
      max-height:400px;
      object-fit:contain;
      background:black;
      cursor:pointer;
    }

    /* Desktop media */
    @media (min-width: 1201px){
      .message-media img, .message-media video{ max-width: 400px; max-height: 450px; }
    }

    /* Tablet media */
    @media (min-width: 769px) and (max-width: 1200px){
      .message-media img, .message-media video{ max-width: 320px; max-height: 380px; }
    }

    /* Mobile media */
    @media (max-width: 768px){
      .message-media img, .message-media video{ max-width: 280px; max-height: 350px; }
    }

    /* Small phones media */
    @media (max-width: 400px){
      .message-media img, .message-media video{ max-width: 220px; max-height: 280px; }
      .message-media{ border-radius: 10px; }
    }

    .msg-text{
      font-size: 14px;
      line-height: 1.4;
      max-width: 100%;
      min-width: 0;
      /* –æ–±—ã—á–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–∞–∫ –≤ Telegram: –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞ –Ω–µ –ª–æ–º–∞–µ–º */
      white-space: pre-wrap;
      word-break: normal;
      overflow-wrap: break-word; /* –ø–µ—Ä–µ–Ω–æ—Å–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ª–æ–≤–æ/URL —Ä–µ–∞–ª—å–Ω–æ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è */
      hyphens: manual;
    }

    .media-caption{ margin-top: 6px; }
    .bubble .text-sm{ line-height: 1.4; }

    .file-chip{ 
      display:flex; 
      align-items:center; 
      gap:10px; 
      padding:10px; 
      border-radius:14px; 
      background:rgba(15,23,42,.45); 
      border:1px solid rgba(148,163,184,.15);
      max-width: 100%;
      min-width: 0;
    }
    .file-chip *{ min-width:0; }
    .file-chip .min-w-0{ min-width: 0; }

    /* Safety: nothing inside bubble should force bubble to grow wider than max-width */
    .bubble > *{ max-width:100%; }

    @media (max-width: 768px){
      .file-chip{ padding: 8px; gap: 8px; border-radius: 12px; }
      .file-chip svg{ width: 24px; height: 24px; }
    }

    /* Typing indicator */
    .typing-dot{ width:7px; height:7px; background:rgba(148,163,184,.9); border-radius:999px; display:inline-block; animation:typing 1.2s infinite; }
    .typing-dot:nth-child(2){ animation-delay:.15s; }
    .typing-dot:nth-child(3){ animation-delay:.3s; }
    @keyframes typing{ 0%,60%,100%{ transform:translateY(0); opacity:.7 } 30%{ transform:translateY(-4px); opacity:1 } }

    /* Toast */
    #toast{ position:fixed; top:14px; left:14px; right:14px; max-width:520px; margin:0 auto; z-index:80; }

    /* Modals */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:70; background:rgba(0,0,0,.65); backdrop-filter: blur(6px); }
    .modal.show{ display:flex; }
    .sheet{ width:100%; max-width:520px; border-radius:22px; border:1px solid rgba(148,163,184,.18); background:rgba(15,23,42,.95); box-shadow: 0 18px 60px rgba(0,0,0,.45); overflow:hidden; max-height: 90vh; overflow-y: auto; }

    @media (max-width:768px){
      .modal{ padding: 10px; }
      .sheet{ max-width: 100%; border-radius: 20px; max-height: 85vh; }
      .sheet.bottom{ align-self:flex-end; border-bottom-left-radius:0; border-bottom-right-radius:0; }
    }

    /* Emoji picker */
    #emojiPicker{ display:none; margin-top:10px; border-radius:16px; border:1px solid rgba(148,163,184,.15); overflow:hidden; background:rgba(15,23,42,.85); }
    #emojiPicker.show{ display:block; }
    .emoji-tabs{ display:flex; border-bottom:1px solid rgba(148,163,184,.12); overflow-x:auto; }
    .emoji-tab{ flex:1; min-width:40px; padding:10px 0; text-align:center; font-size:18px; color:#cbd5e1; border-bottom:2px solid transparent; background:rgba(2,6,23,.18); }
    .emoji-tab.active{ border-bottom-color: rgba(139,92,246,.9); color:white; }
    .emoji-grid{ padding:10px; max-height:200px; overflow:auto; display:grid; grid-template-columns: repeat(8, 1fr); gap:6px; }
    .emoji-btn{ border-radius:8px; padding:8px; font-size:20px; line-height:1; cursor:pointer; border:none; background:transparent; transition: all 0.15s ease; }
    .emoji-btn:hover{ background:rgba(148,163,184,.12); transform: scale(1.1); }

    @media (max-width: 768px){
      .emoji-grid{ grid-template-columns: repeat(7, 1fr); max-height: 180px; gap: 6px; }
      .emoji-btn{ font-size: 22px; padding: 10px; }
    }

    @media (max-width: 400px){
      .emoji-grid{ grid-template-columns: repeat(6, 1fr); gap: 4px; }
      .emoji-btn{ font-size: 20px; padding: 8px; }
    }

    /* Developer badge */
    .dev-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:.6px;
      color:white;
      background: linear-gradient(135deg,#f093fb 0%, #f5576c 100%);
      border:1px solid rgba(255,255,255,.18);
      vertical-align:middle;
      white-space:nowrap;
    }
    .dev-badge svg{ width:12px; height:12px; }

    /* Message context menu */
    #messageContextMenu{ position:fixed; display:none; z-index:75; border-radius:16px; background:rgba(15,23,42,.95); border:1px solid rgba(148,163,184,.18); box-shadow: 0 14px 40px rgba(0,0,0,.45); min-width: 180px; overflow:hidden; }
    #messageContextMenu.show{ display:block; }
    .context-menu-btn{ width:100%; display:flex; align-items:center; gap:10px; padding:12px 16px; border:none; background:transparent; color:#e5e7eb; cursor:pointer; font-size:14px; transition: background .15s; }
    .context-menu-btn:hover{ background:rgba(148,163,184,.12); }
    .context-menu-btn.text-red-400{ color:#f87171; }
    .context-menu-btn.text-red-400:hover{ background:rgba(248,113,113,.12); }
    .context-menu-divider{ height:1px; background:rgba(148,163,184,.15); margin:4px 0; }

    /* Reaction picker */
    .reaction-btn{ font-size:22px; padding:6px; border-radius:12px; border:none; background:transparent; cursor:pointer; transition: transform .15s; }
    .reaction-btn:hover{ background:rgba(148,163,184,.12); transform:scale(1.15); }

    /* Edited message indicator */
    .edited-indicator{ font-size:11px; color:rgba(148,163,184,.7); font-style:italic; }

    /* Image viewer */
    #imageViewer{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:90; background:rgba(0,0,0,.95); padding:16px; }
    #imageViewer.show{ display:flex; }
    #imageViewer img{ max-width: 95vw; max-height: 90vh; object-fit: contain; }

    /* Avatar upload button */
    .avatar-upload{
      position:relative;
      cursor:pointer;
    }
    .avatar-upload input[type="file"]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }
    .avatar-upload-overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.5);
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      transition: opacity .2s;
    }
    .avatar-upload:hover .avatar-upload-overlay{ opacity:1; }

    /* Chat avatar with image support */
    .chat-avatar{
      width:48px;
      height:48px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      font-size:18px;
      overflow:hidden;
      flex-shrink:0;
    }
    .chat-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .chat-avatar-sm{
      width:40px;
      height:40px;
      font-size:16px;
    }

    .chat-avatar-lg{
      width:80px;
      height:80px;
      font-size:28px;
    }

    @media (max-width: 768px){
      .chat-avatar{ width: 44px; height: 44px; font-size: 16px; }
      .chat-avatar-lg{ width: 64px; height: 64px; font-size: 24px; }
    }

    /* Small helpers */
    .fade-in{ animation: fade .18s ease; }
    @keyframes fade{ from{ opacity:0; transform: translateY(8px);} to{ opacity:1; transform: translateY(0);} }
    
    .truncate-2{ display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* –ó–∞–ø—Ä–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
    body, .bubble, .msg-text, #chatList, #messagesContainer {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* –†–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞ */
    input, textarea {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    /* Confirm Modal */
    #confirmModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      background: rgba(0,0,0,.7);
      backdrop-filter: blur(6px);
      padding: 16px;
    }
    #confirmModal.show { display: flex; }
    .confirm-box {
      width: 100%;
      max-width: 320px;
      border-radius: 20px;
      background: rgba(15,23,42,.98);
      border: 1px solid rgba(148,163,184,.18);
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      overflow: hidden;
      animation: fade .2s ease;
    }
    .confirm-box .confirm-header {
      padding: 20px 20px 12px;
      text-align: center;
    }
    .confirm-box .confirm-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(239,68,68,.15);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
    }
    .confirm-box .confirm-icon svg {
      width: 28px;
      height: 28px;
      color: #f87171;
    }
    .confirm-box .confirm-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .confirm-box .confirm-text {
      font-size: 14px;
      color: #9ca3af;
      line-height: 1.4;
    }
    .confirm-box .confirm-buttons {
      display: flex;
      border-top: 1px solid rgba(148,163,184,.15);
    }
    .confirm-box .confirm-btn {
      flex: 1;
      padding: 14px;
      border: none;
      background: transparent;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background .15s;
    }
    .confirm-box .confirm-btn:first-child {
      color: #9ca3af;
      border-right: 1px solid rgba(148,163,184,.15);
    }
    .confirm-box .confirm-btn:first-child:hover {
      background: rgba(148,163,184,.1);
    }
    .confirm-box .confirm-btn.danger {
      color: #f87171;
    }
    .confirm-box .confirm-btn.danger:hover {
      background: rgba(239,68,68,.15);
    }

    /* Toast –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è */
    .copy-toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(148,163,184,.2);
      border-radius: 12px;
      padding: 10px 20px;
      font-size: 14px;
      color: #e5e7eb;
      z-index: 200;
      animation: fadeInUp .2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translate(-50%, 10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    /* === REPLY PANEL === */
    .reply-panel{ display:flex; align-items:center; gap:12px; padding:12px 16px; background:rgba(139,92,246,.1); border-left:3px solid rgba(139,92,246,.9); margin-bottom:8px; border-radius:8px; }
    .reply-content{ flex:1; display:flex; gap:8px; min-width:0; }
    .reply-line{ width:3px; background:rgba(139,92,246,.9); border-radius:2px; }
    .reply-info{ flex:1; min-width:0; }
    .reply-sender{ font-size:13px; font-weight:600; color:rgba(139,92,246,.9); margin-bottom:2px; }
    .reply-text{ font-size:13px; color:rgba(148,163,184,.9); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .reply-cancel{ padding:4px; border:none; background:transparent; color:rgba(148,163,184,.7); cursor:pointer; border-radius:6px; transition:all .15s; }
    .reply-cancel:hover{ background:rgba(148,163,184,.12); color:#fff; }

    /* === PINNED MESSAGE === */
    .pinned-message{ display:none; padding:12px 16px; background:rgba(139,92,246,.15); border-bottom:1px solid rgba(148,163,184,.12); cursor:pointer; transition:background .15s; }
    .pinned-message.show{ display:flex; }
    .pinned-message:hover{ background:rgba(139,92,246,.2); }
    .pinned-message-content{ flex:1; min-width:0; }
    .pinned-message-title{ font-size:12px; font-weight:600; color:rgba(139,92,246,.9); margin-bottom:4px; }
    .pinned-message-text{ font-size:14px; color:#e5e7eb; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .pinned-close{ padding:4px; border:none; background:transparent; color:rgba(148,163,184,.7); cursor:pointer; border-radius:6px; }
    .pinned-close:hover{ background:rgba(148,163,184,.12); }

    /* === FORWARD MODAL === */
    .chat-item{ display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; cursor:pointer; transition:background .15s; }
    .chat-item:hover{ background:rgba(148,163,184,.08); }

    /* === VOICE MESSAGE === */
    .voice-recording{ display:none; align-items:center; gap:12px; padding:12px 16px; background:rgba(239,68,68,.1); border-radius:12px; margin-bottom:8px; }
    .voice-recording.show{ display:flex; }
    .voice-wave{ flex:1; height:40px; display:flex; align-items:center; gap:2px; }
    .voice-wave-bar{ width:3px; background:rgba(239,68,68,.7); border-radius:2px; transition:height .1s; }
    .voice-time{ font-size:14px; color:rgba(239,68,68,.9); font-weight:600; }
    
    .voice-bar{ animation: voiceWave 1s ease-in-out infinite; }
    .voice-bar:nth-child(1){ animation-delay: 0s; }
    .voice-bar:nth-child(2){ animation-delay: 0.1s; }
    .voice-bar:nth-child(3){ animation-delay: 0.2s; }
    .voice-bar:nth-child(4){ animation-delay: 0.3s; }
    .voice-bar:nth-child(5){ animation-delay: 0.4s; }
    .voice-bar:nth-child(6){ animation-delay: 0.3s; }
    .voice-bar:nth-child(7){ animation-delay: 0.2s; }
    .voice-bar:nth-child(8){ animation-delay: 0.1s; }
    .voice-bar:nth-child(9){ animation-delay: 0s; }
    
    @keyframes voiceWave {
      0%, 100% { height: 20%; }
      50% { height: 100%; }
    }

    /* === VIDEO MESSAGE (–ö–†–£–ñ–û–ö) === */
    .video-message-container{
      width: 240px;
      height: 240px;
      border-radius: 50%;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      border: 2px solid rgba(139,92,246,.3);
    }
    .video-message-container video{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .video-message-play{
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.3);
      opacity: 0;
      transition: opacity .2s;
    }
    .video-message-container:hover .video-message-play{
      opacity: 1;
    }

    @media (max-width: 768px){
      .video-message-container{ width: 200px; height: 200px; }
    }

    /* === AUDIO PLAYER === */
    .audio-player{
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(148,163,184,.08);
      border-radius: 16px;
      max-width: 300px;
    }
    .audio-play-btn{
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: opacity .2s;
    }
    .audio-play-btn:hover{ opacity: .9; }
    .audio-play-btn svg{ width: 20px; height: 20px; color: white; }
    .audio-waveform{
      flex: 1;
      display: flex;
      align-items: center;
      gap: 2px;
      height: 32px;
      min-width: 0;
    }
    .audio-waveform-bar{
      flex: 1;
      background: rgba(139,92,246,.4);
      border-radius: 2px;
      min-width: 2px;
      transition: background .2s;
    }
    .audio-player.playing .audio-waveform-bar{
      background: rgba(139,92,246,.7);
    }
    .audio-time{
      font-size: 12px;
      color: rgba(148,163,184,.9);
      font-weight: 600;
      white-space: nowrap;
    }

    body.light-theme .audio-player{ background: rgba(148,163,184,.2); }
    body.light-theme .audio-time{ color: #64748b; }
    body.light-theme .audio-waveform-bar{ background: rgba(139,92,246,.3); }
    body.light-theme .audio-player.playing .audio-waveform-bar{ background: rgba(139,92,246,.6); }

    /* === POLL === */
    .poll-option{ padding:12px; background:rgba(148,163,184,.08); border-radius:12px; margin-bottom:8px; cursor:pointer; transition:all .15s; position:relative; overflow:hidden; }
    .poll-option:hover{ background:rgba(148,163,184,.12); }
    .poll-option.voted{ cursor:default; }
    .poll-progress{ position:absolute; left:0; top:0; bottom:0; background:rgba(139,92,246,.2); transition:width .3s; }
    .poll-option-content{ position:relative; z-index:1; display:flex; justify-content:space-between; align-items:center; }
    .poll-votes{ font-size:13px; color:rgba(148,163,184,.9); font-weight:600; }

    /* === THEME TOGGLE === */
    .theme-toggle{ padding:8px; border:none; background:transparent; cursor:pointer; border-radius:8px; transition:all .2s; display:grid; place-items:center; }
    .theme-toggle:hover{ background:rgba(148,163,184,.12); }
    .theme-toggle svg{ width:20px; height:20px; color:rgba(148,163,184,.9); }

    /* === LIGHT THEME === */
    body.light-theme{ background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%); }
    body.light-theme #chatScreen{ background:rgba(255,255,255,.95); color:#1e293b; }
    body.light-theme #sidebar{ background:rgba(255,255,255,.9); border-right:1px solid rgba(148,163,184,.2); }
    body.light-theme .chat-header{ background:rgba(255,255,255,.95); border-bottom:1px solid rgba(148,163,184,.2); color:#1e293b; }
    body.light-theme .bubble{ background:rgba(255,255,255,.95); color:#1e293b; border:1px solid rgba(148,163,184,.15); }
    body.light-theme .bubble.out{ background:rgba(139,92,246,.15); color:#1e293b; border:1px solid rgba(139,92,246,.3); }
    body.light-theme .bubble.in{ background:rgba(241,245,249,.95); color:#1e293b; }
    body.light-theme .bubble .reply-in-message{ background:rgba(30,41,59,.85) !important; border-left-color:#8b5cf6 !important; }
    body.light-theme .bubble .reply-in-message .reply-name{ color:#a78bfa !important; }
    body.light-theme .bubble .reply-in-message .reply-msg{ color:rgba(255,255,255,.95) !important; }
    body.light-theme .bubble .reply-in-message svg{ color:#a78bfa !important; }
    body.light-theme .sender-line{ color:#64748b; }
    body.light-theme .meta{ color:#64748b; }
    body.light-theme #messageInput{ background:rgba(241,245,249,.9); color:#1e293b; border:1px solid rgba(148,163,184,.2); }
    body.light-theme #messageInput::placeholder{ color:#94a3b8; }
    body.light-theme .icon-btn{ color:#64748b; }
    body.light-theme .icon-btn:hover{ background:rgba(148,163,184,.12); }
    body.light-theme .video-btn{ color:#0891b2; border-color:rgba(8,145,178,.3); }
    body.light-theme .video-btn:hover{ background:rgba(8,145,178,.15); color:#06b6d4; }
    body.light-theme .voice-btn{ color:#ea580c; border-color:rgba(234,88,12,.3); }
    body.light-theme .voice-btn:hover{ background:rgba(234,88,12,.15); color:#f97316; }
    body.light-theme .chat-item:hover{ background:rgba(148,163,184,.08); }
    body.light-theme .chat-item.active{ background:rgba(139,92,246,.12); }
    body.light-theme #messageContextMenu{ background:rgba(255,255,255,.98); border:1px solid rgba(148,163,184,.2); color:#1e293b; }
    body.light-theme .context-menu-btn{ color:#1e293b; }
    body.light-theme .context-menu-btn:hover{ background:rgba(148,163,184,.12); }
    body.light-theme .reply-panel{ background:rgba(139,92,246,.08); border-left:3px solid rgba(139,92,246,.9); }
    body.light-theme .reply-sender{ color:rgba(139,92,246,.9); }
    body.light-theme .reply-text{ color:#64748b; }
    body.light-theme .pinned-message{ background:rgba(139,92,246,.1); border-bottom:1px solid rgba(148,163,184,.2); }
    body.light-theme .pinned-message-title{ color:rgba(139,92,246,.9); }
    body.light-theme .pinned-message-text{ color:#1e293b; }
    body.light-theme .theme-toggle svg{ color:#64748b; }
    body.light-theme #typingIndicator{ color:#64748b; background:rgba(241,245,249,.8) !important; }
    body.light-theme .typing-dot{ background:#64748b; }
    body.light-theme .chat-item .bg-sky-500{ background:#0ea5e9 !important; color:#fff !important; }
    body.light-theme .poll-option{ background:rgba(148,163,184,.15); }
    body.light-theme .poll-option:hover{ background:rgba(148,163,184,.22); }
    body.light-theme .poll-progress{ background:rgba(139,92,246,.25); }
    body.light-theme .poll-votes{ color:#64748b; }
    body.light-theme .poll-question{ color:#1e293b; }
  </style>
</head>
<body>
  <div id="appShell">

    <!-- AUTH -->
    <div id="authScreen" class="px-4 py-10">
      <div class="mx-auto w-full max-w-md">
        <div class="text-center mb-8">
          <div class="w-20 h-20 gradient-bg rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg">
            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
          </div>
          <h1 class="text-3xl font-bold flex items-center justify-center gap-3">
            FlashChat Pro
            <button class="theme-toggle" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
            </button>
          </h1>
        </div>

        <div id="savedAccounts" class="hidden mb-4">
          <p class="text-sm text-slate-400 mb-2">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:</p>
          <div id="accountsList" class="space-y-2 max-h-40 overflow-auto scrollbar"></div>
        </div>

        <div class="glass rounded-3xl p-6 border" style="border-color: var(--border)">
          <div class="flex mb-6 bg-white/5 rounded-xl p-1">
            <button id="loginTab" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all bg-violet-600 text-white" onclick="showTab('login')">–í—Ö–æ–¥</button>
            <button id="registerTab" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all text-slate-400" onclick="showTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          </div>

          <form id="loginForm" class="space-y-4">
            <input type="email" id="loginEmail" required placeholder="Email" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <input type="password" id="loginPassword" required placeholder="–ü–∞—Ä–æ–ª—å" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <label class="flex items-center gap-2 text-sm text-slate-400">
              <input type="checkbox" id="saveAccount" checked>
              <span>–ó–∞–ø–æ–º–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</span>
            </label>
            <button type="submit" class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95">–í–æ–π—Ç–∏</button>
          </form>

          <form id="registerForm" class="space-y-4 hidden">
            <input type="text" id="registerName" required placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <input type="email" id="registerEmail" required placeholder="Email" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <input type="password" id="registerPassword" required minlength="6" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <button type="submit" class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
          </form>

          <div id="authError" class="mt-4 text-red-300 text-sm text-center hidden"></div>
        </div>
      </div>
    </div>

    <!-- CHAT -->
    <div id="chatScreen">
      <!-- Sidebar -->
      <aside id="sidebar" class="safe-top">
        <div class="p-3 border-b" style="border-color: var(--border)">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-bold">FlashChat</h2>
            <div class="flex gap-1">
              <button class="icon-btn" title="–°–æ–∑–¥–∞—Ç—å" onclick="showCreateMenu()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              </button>
              <button class="icon-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" onclick="showAppSettings()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </button>
              <button class="icon-btn" title="–ê–∫–∫–∞—É–Ω—Ç—ã" onclick="showAccountSwitcher()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </button>
              <button class="icon-btn" title="–ü—Ä–æ—Ñ–∏–ª—å" onclick="showProfile()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              </button>
            </div>
          </div>

          <div class="flex gap-1 mb-3 bg-white/5 rounded-xl p-1">
            <button id="tabAll" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-violet-600" onclick="showChatTab('all')">–í—Å–µ</button>
            <button id="tabPrivate" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400" onclick="showChatTab('private')">–õ–∏—á–Ω—ã–µ</button>
            <button id="tabGroups" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400" onclick="showChatTab('groups')">–ì—Ä—É–ø–ø—ã</button>
            <button id="tabChannels" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400" onclick="showChatTab('channels')">–ö–∞–Ω–∞–ª—ã</button>
          </div>

          <div class="relative">
            <input id="searchInput" oninput="searchAll()" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 pl-10 outline-none focus:border-violet-500 text-sm" placeholder="–ü–æ–∏—Å–∫...">
            <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </div>
        </div>

        <div id="searchResults" class="hidden border-b" style="border-color: var(--border)"></div>
        
        <!-- Saved Messages (–ò–∑–±—Ä–∞–Ω–Ω–æ–µ) -->
        <div id="savedMessagesChat" class="border-b" style="border-color: var(--border)">
          <div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-white/5 transition" onclick="openSavedMessages()">
            <div class="relative shrink-0">
              <div class="chat-avatar" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-medium">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
              <div class="text-sm text-slate-400 truncate">–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
            </div>
          </div>
        </div>
        
        <div id="chatList" class="scrollbar"></div>
      </aside>

      <!-- Chat Area -->
      <main id="chatArea">
        <div id="emptyChat">
          <div class="text-center">
            <div class="w-24 h-24 bg-white/5 rounded-full mx-auto mb-4 grid place-items-center">
              <svg class="w-12 h-12 text-slate-500" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
            </div>
            <h3 class="text-xl font-semibold text-slate-300">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
            <p class="text-slate-500 mt-2">–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
          </div>
        </div>

        <section id="activeChat">
          <div class="chat-header p-3 flex items-center gap-3">
            <button class="icon-btn md:hidden" onclick="closeChat()" title="–ù–∞–∑–∞–¥">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <div id="chatAvatar" class="chat-avatar chat-avatar-sm gradient-bg"></div>
            <div class="flex-1 min-w-0">
              <h3 id="chatName" class="font-semibold truncate"></h3>
              <p id="chatStatus" class="text-xs text-slate-400 truncate"></p>
            </div>
            <div id="chatHeaderActions" class="flex gap-1 flex-shrink-0"></div>
          </div>

          <!-- Pinned Message -->
          <div id="pinnedMessage" class="pinned-message" onclick="scrollToPinnedMessage()">
            <div class="pinned-message-content">
              <div class="pinned-message-title">üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
              <div id="pinnedMessageText" class="pinned-message-text"></div>
            </div>
            <button onclick="event.stopPropagation(); unpinMessage()" class="pinned-close">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>

          <div id="messagesContainer" class="scrollbar"></div>

          <div id="typingIndicator" class="hidden px-4 py-2" style="background:rgba(15,23,42,.5);">
            <div class="flex items-center gap-2 text-slate-400 text-sm">
              <div class="flex gap-1">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
              </div>
              <span id="typingText">–ø–µ—á–∞—Ç–∞–µ—Ç...</span>
            </div>
          </div>

          <!-- Upload preview with caption + send -->
          <div id="uploadPreview" class="hidden px-3 py-3 border-t" style="border-color: var(--border); background: rgba(15,23,42,.9)">
            <div class="flex flex-col gap-2">
              <div class="flex items-start gap-3">
                <img id="uploadPreviewImage" src="" class="w-20 h-20 object-contain rounded-xl hidden" style="background: rgba(2,6,23,.55)" alt="preview">
                <div id="uploadPreviewFile" class="hidden items-center gap-2 p-2 bg-white/5 rounded-xl border border-white/10">
                  <svg class="w-8 h-8 text-violet-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  <span id="uploadFileName" class="text-sm truncate max-w-[180px]"></span>
                </div>
                <div class="flex-1 min-w-0 flex flex-col gap-2">
                  <input id="imageCaption" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none focus:border-violet-500" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å..." />
                  <div id="uploadProgress" class="h-2 bg-white/10 rounded-full overflow-hidden hidden">
                    <div id="uploadProgressBar" class="h-full gradient-bg" style="width:0%"></div>
                  </div>
                </div>
                <button class="icon-btn" onclick="cancelUpload()" title="–û—Ç–º–µ–Ω–∞">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
              <button class="w-full gradient-bg py-2.5 rounded-xl font-semibold hover:opacity-95" onclick="sendFileWithCaption()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
          </div>

          <div id="messageInputArea">
            <form id="messageForm" onsubmit="sendMessage(event)">
              <input type="file" id="fileInput" class="hidden" accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.zip,.rar,.ppt,.pptx,.txt" onchange="handleFileSelect(event)">
              <button type="button" class="icon-btn" onclick="openFilePicker()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
              </button>
              <button type="button" class="icon-btn" onclick="toggleEmoji()" title="–≠–º–æ–¥–∑–∏">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              </button>
              <input id="messageInput" type="text" autocomplete="off" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="handleTyping()">
              <button type="button" class="icon-btn video-btn" onclick="startVideoMessage()" title="–ö—Ä—É–∂–æ–∫">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
              </button>
              <button type="button" class="icon-btn voice-btn" onclick="startVoiceMessage()" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
              </button>
              <button class="send-btn" type="submit" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
              </button>
            </form>

            <div id="emojiPicker">
              <div class="emoji-tabs">
                <button type="button" class="emoji-tab active" id="emojiTabSmileys" onclick="showEmojiCategory('smileys')">üòÄ</button>
                <button type="button" class="emoji-tab" id="emojiTabGestures" onclick="showEmojiCategory('gestures')">üëã</button>
                <button type="button" class="emoji-tab" id="emojiTabAnimals" onclick="showEmojiCategory('animals')">üê±</button>
                <button type="button" class="emoji-tab" id="emojiTabFood" onclick="showEmojiCategory('food')">üçï</button>
                <button type="button" class="emoji-tab" id="emojiTabActivities" onclick="showEmojiCategory('activities')">‚öΩ</button>
                <button type="button" class="emoji-tab" id="emojiTabTravel" onclick="showEmojiCategory('travel')">üöó</button>
                <button type="button" class="emoji-tab" id="emojiTabObjects" onclick="showEmojiCategory('objects')">üí°</button>
                <button type="button" class="emoji-tab" id="emojiTabSymbols" onclick="showEmojiCategory('symbols')">‚ù§Ô∏è</button>
              </div>
              <div id="emojiGrid" class="emoji-grid scrollbar"></div>
            </div>
          </div>

          <div id="channelNotice" class="px-4 py-4 text-center text-slate-400" style="display:none; border-top:1px solid var(--border); background:rgba(15,23,42,.9)">
            <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
            –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –≤ —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª
          </div>
        </section>
      </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden" onclick="handleToastClick()">
      <div class="glass border" style="border-color:var(--border); border-radius:16px; padding:12px 14px; cursor:pointer;">
        <div class="flex items-center gap-3">
          <div id="toastIcon" class="w-10 h-10 rounded-full gradient-bg grid place-items-center font-bold shrink-0"></div>
          <div class="min-w-0">
            <div id="toastTitle" class="font-semibold truncate"></div>
            <div id="toastMessage" class="text-sm text-slate-400 truncate"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Context Menu -->
    <div id="messageContextMenu" class="fade-in">
      <button onclick="replyToMessage()" id="replyMessageBtn" class="context-menu-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
        <span>–û—Ç–≤–µ—Ç–∏—Ç—å</span>
      </button>
      <button onclick="forwardMessage()" id="forwardMessageBtn" class="context-menu-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
        <span>–ü–µ—Ä–µ—Å–ª–∞—Ç—å</span>
      </button>
      <button onclick="pinMessage()" id="pinMessageBtn" class="context-menu-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
        <span>–ó–∞–∫—Ä–µ–ø–∏—Ç—å</span>
      </button>
      <button onclick="saveToFavorites()" id="saveToFavoritesBtn" class="context-menu-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
        <span>–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
      </button>
      <div class="context-menu-divider"></div>
      <button onclick="copyMessage()" id="copyMessageBtn" class="context-menu-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
        <span>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
      </button>
      <button onclick="startEditMessage()" id="editMessageBtn" class="context-menu-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
        <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
      </button>
      <div class="context-menu-divider"></div>
      <button onclick="deleteMessage()" id="deleteMessageBtn" class="context-menu-btn text-red-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        <span>–£–¥–∞–ª–∏—Ç—å</span>
      </button>
      <div class="context-menu-divider"></div>
      <div class="flex gap-1 p-2">
        <button class="reaction-btn" onclick="addReaction('üëç')">üëç</button>
        <button class="reaction-btn" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
        <button class="reaction-btn" onclick="addReaction('üòÇ')">üòÇ</button>
        <button class="reaction-btn" onclick="addReaction('üòÆ')">üòÆ</button>
        <button class="reaction-btn" onclick="addReaction('üò¢')">üò¢</button>
        <button class="reaction-btn" onclick="addReaction('üî•')">üî•</button>
      </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmModal">
      <div class="confirm-box">
        <div class="confirm-header">
          <div class="confirm-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </div>
          <div class="confirm-title">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?</div>
          <div class="confirm-text">–°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞</div>
        </div>
        <div class="confirm-buttons">
          <button class="confirm-btn" onclick="closeConfirmModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="confirm-btn danger" onclick="confirmDeleteMessage()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Edit Message Modal -->
    <div id="editMessageModal" class="modal" onclick="modalBackdropClose(event, 'editMessageModal')">
      <div class="sheet p-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
          <button class="icon-btn" onclick="closeModal('editMessageModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <textarea id="editMessageText" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500 resize-none h-32" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
        <div class="flex gap-2 mt-4">
          <button class="flex-1 py-2.5 bg-white/5 rounded-xl text-slate-400 hover:bg-white/10" onclick="closeModal('editMessageModal')">–û—Ç–º–µ–Ω–∞</button>
          <button class="flex-1 py-2.5 gradient-bg rounded-xl font-semibold hover:opacity-95" onclick="saveEditedMessage()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Image Viewer -->
    <div id="imageViewer" onclick="closeImageViewer()">
      <button class="absolute top-4 right-4 icon-btn" style="background: rgba(255,255,255,.1); border-color: rgba(255,255,255,.18)">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <img id="viewerImage" alt="view" class="max-w-full max-h-full object-contain" />
    </div>

    <!-- Create Menu Modal -->
    <div id="createMenuModal" class="modal" onclick="modalBackdropClose(event, 'createMenuModal')">
      <div class="sheet bottom p-4">
        <h3 class="text-lg font-bold mb-4 text-center">–°–æ–∑–¥–∞—Ç—å</h3>
        <div class="space-y-2">
          <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="showNewPrivateChat()">
            <div class="w-10 h-10 gradient-bg rounded-full grid place-items-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            </div>
            <div class="text-left">
              <div class="font-medium">–õ–∏—á–Ω—ã–π —á–∞—Ç</div>
              <div class="text-xs text-slate-400">–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</div>
            </div>
          </button>

          <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="showCreateGroup()">
            <div class="w-10 h-10 gradient-green rounded-full grid place-items-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            </div>
            <div class="text-left">
              <div class="font-medium">–ì—Ä—É–ø–ø–∞</div>
              <div class="text-xs text-slate-400">–î–æ 200 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            </div>
          </button>

          <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="showCreateChannel()">
            <div class="w-10 h-10 gradient-orange rounded-full grid place-items-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
            </div>
            <div class="text-left">
              <div class="font-medium">–ö–∞–Ω–∞–ª</div>
              <div class="text-xs text-slate-400">–¢–æ–ª—å–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å</div>
            </div>
          </button>
        </div>
        <button class="w-full mt-4 py-2 text-slate-400 hover:text-white" onclick="closeModal('createMenuModal')">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>

    <!-- New Private Chat Modal -->
    <div id="newPrivateChatModal" class="modal" onclick="modalBackdropClose(event, 'newPrivateChatModal')">
      <div class="sheet p-4 max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–ù–æ–≤—ã–π —á–∞—Ç</h3>
          <button class="icon-btn" onclick="closeModal('newPrivateChatModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <input id="userSearchInput" oninput="searchUsersForChat()" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
        <div id="userSearchResults" class="flex-1 overflow-auto scrollbar"></div>
      </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal" onclick="modalBackdropClose(event, 'createGroupModal')">
      <div class="sheet p-4 max-h-[86vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</h3>
          <button class="icon-btn" onclick="closeModal('createGroupModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <input id="groupName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
        <input id="groupSearchInput" oninput="searchUsersForGroup()" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...">
        <div id="selectedMembers" class="flex flex-wrap gap-2 mb-3"></div>
        <div id="groupSearchResults" class="flex-1 overflow-auto scrollbar mb-3 min-h-[200px]"></div>
        <button class="w-full gradient-bg py-2.5 rounded-xl font-semibold hover:opacity-95" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
      </div>
    </div>

    <!-- Create Channel Modal -->
    <div id="createChannelModal" class="modal" onclick="modalBackdropClose(event, 'createChannelModal')">
      <div class="sheet p-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª</h3>
          <button class="icon-btn" onclick="closeModal('createChannelModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <input id="channelName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞">
        <textarea id="channelDescription" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500 resize-none h-24" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
        <button class="w-full gradient-bg py-2.5 rounded-xl font-semibold hover:opacity-95" onclick="createChannel()">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
      </div>
    </div>

    <!-- Create Poll Modal -->
    <div id="createPollModal" class="modal" onclick="modalBackdropClose(event, 'createPollModal')">
      <div class="sheet p-4 max-h-[85vh] overflow-auto scrollbar">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">üìä –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</h3>
          <button class="icon-btn" onclick="closeModal('createPollModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <input id="pollQuestion" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 mb-3 outline-none focus:border-violet-500" placeholder="–í–æ–ø—Ä–æ—Å –æ–ø—Ä–æ—Å–∞">
        <div id="pollOptions" class="space-y-2 mb-3">
          <input class="poll-option-input w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 outline-none focus:border-violet-500" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1">
          <input class="poll-option-input w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 outline-none focus:border-violet-500" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2">
        </div>
        <button class="w-full flex items-center justify-center gap-2 p-2 border border-dashed border-white/20 rounded-xl text-slate-400 hover:border-violet-500 hover:text-violet-300 mb-4" onclick="addPollOption()">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç
        </button>
        <label class="flex items-center gap-2 p-3 bg-white/5 rounded-xl mb-4 cursor-pointer">
          <input type="checkbox" id="pollAnonymous" class="w-4 h-4 accent-violet-600">
          <span class="text-sm">–ê–Ω–æ–Ω–∏–º–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</span>
        </label>
        <button class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95" onclick="sendPoll()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–ø—Ä–æ—Å</button>
      </div>
    </div>

    <!-- Video Message Modal (–ö—Ä—É–∂–æ–∫) -->
    <div id="videoMessageModal" class="modal" onclick="if(event.target.id === 'videoMessageModal') stopVideoMessage()">
      <div class="sheet p-4 max-w-md">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">üé• –ö—Ä—É–∂–æ–∫</h3>
          <button class="icon-btn" onclick="stopVideoMessage()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="relative bg-black rounded-2xl overflow-hidden mb-4" style="aspect-ratio: 1/1;">
          <video id="videoPreview" autoplay muted playsinline class="w-full h-full object-cover"></video>
          <div id="videoRecordingIndicator" class="hidden absolute top-4 left-4 flex items-center gap-2 bg-red-500 px-3 py-1.5 rounded-full">
            <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
            <span id="videoRecordingTime" class="text-white text-sm font-semibold">0:00</span>
          </div>
        </div>
        <div class="flex gap-3">
          <button id="videoRecordBtn" class="flex-1 gradient-bg py-3 rounded-xl font-semibold hover:opacity-95 flex items-center justify-center gap-2" onclick="toggleVideoRecording()">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8"/></svg>
            –ó–∞–ø–∏—Å–∞—Ç—å
          </button>
          <button id="videoSendBtn" class="hidden flex-1 gradient-green py-3 rounded-xl font-semibold hover:opacity-95" onclick="sendVideoMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Voice Message Modal -->
    <div id="voiceMessageModal" class="modal" onclick="if(event.target.id === 'voiceMessageModal') stopVoiceMessageModal()">
      <div class="sheet p-4 max-w-md">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
          <button class="icon-btn" onclick="stopVoiceMessageModal()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="bg-white/5 rounded-2xl p-8 mb-4 flex flex-col items-center justify-center" style="min-height: 200px;">
          <div id="voiceMicIcon" class="w-20 h-20 rounded-full gradient-orange flex items-center justify-center mb-4">
            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
          </div>
          <div id="voiceRecordingTime" class="text-3xl font-bold mb-2">0:00</div>
          <div id="voiceWaveform" class="hidden flex items-center justify-center gap-1 h-12">
            <div class="voice-bar w-1 bg-violet-400 rounded-full" style="height: 20%;"></div>
            <div class="voice-bar w-1 bg-violet-400 rounded-full" style="height: 40%;"></div>
            <div class="voice-bar w-1 bg-violet-400 rounded-full" style="height: 60%;"></div>
            <div class="voice-bar w-1 bg-violet-400 rounded-full" style="height: 80%;"></div>
            <div class="voice-bar w-1 bg-violet-400 rounded-full" style="height: 100%;"></div>
            <div class="voice-bar w-1 bg-violet-400 rounded-full" style="height: 80%;"></div>
            <div class="voice-bar w-1 bg-violet-400 rounded-full" style="height: 60%;"></div>
            <div class="voice-bar w-1 bg-violet-400 rounded-full" style="height: 40%;"></div>
            <div class="voice-bar w-1 bg-violet-400 rounded-full" style="height: 20%;"></div>
          </div>
        </div>
        <div class="flex gap-3">
          <button id="voiceRecordBtn" class="flex-1 gradient-bg py-3 rounded-xl font-semibold hover:opacity-95 flex items-center justify-center gap-2" onclick="toggleVoiceRecording()">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8"/></svg>
            –ó–∞–ø–∏—Å–∞—Ç—å
          </button>
          <button id="voiceSendBtn" class="hidden flex-1 gradient-green py-3 rounded-xl font-semibold hover:opacity-95" onclick="sendVoiceMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Account Switcher Modal -->
    <div id="accountSwitcherModal" class="modal" onclick="modalBackdropClose(event, 'accountSwitcherModal')">
      <div class="sheet bottom p-4">
        <h3 class="text-lg font-bold mb-4">–ê–∫–∫–∞—É–Ω—Ç—ã</h3>
        <div id="accountSwitcherList" class="space-y-2 max-h-64 overflow-auto scrollbar mb-4"></div>
        <button class="w-full flex items-center justify-center gap-2 p-3 border border-dashed border-white/20 rounded-xl text-slate-400 hover:border-violet-500 hover:text-violet-300" onclick="addNewAccount()">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
        </button>
        <button class="w-full mt-3 py-2 text-slate-400 hover:text-white" onclick="closeModal('accountSwitcherModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal" onclick="modalBackdropClose(event, 'profileModal')">
      <div class="sheet p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">–ü—Ä–æ—Ñ–∏–ª—å</h3>
          <button class="icon-btn" onclick="closeModal('profileModal')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="text-center mb-6">
          <div id="profileAvatar" class="w-24 h-24 gradient-bg rounded-full mx-auto mb-4 grid place-items-center text-3xl font-bold"></div>
          <div id="profileNameDisplay" class="text-xl font-semibold"></div>
          <div id="profileEmail" class="text-slate-400"></div>
        </div>
        <form class="space-y-4" onsubmit="updateProfile(event)">
          <input id="newProfileName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
          <input id="newProfileStatus" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500" placeholder="–°—Ç–∞—Ç—É—Å">
          <button type="submit" class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
        <button class="w-full mt-3 py-3 bg-red-500/15 text-red-300 rounded-xl font-medium hover:bg-red-500/25" onclick="logout()">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- App Settings Modal -->
    <div id="appSettingsModal" class="modal" onclick="modalBackdropClose(event, 'appSettingsModal')">
      <div class="sheet p-6 max-h-[90vh] overflow-auto scrollbar">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <button class="icon-btn" onclick="closeModal('appSettingsModal')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <div class="space-y-6">
          <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
          <div>
            <h4 class="text-lg font-semibold mb-3 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
              –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            </h4>
            <div class="space-y-3">
              <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                <div>
                  <div class="font-medium">–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                  <div class="text-sm text-slate-400">–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –∑–≤—É–∫ –ø—Ä–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingNotificationSound" onchange="saveAppSettings()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                <div>
                  <div class="font-medium">Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                  <div class="text-sm text-slate-400">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingPushNotifications" onchange="togglePushNotifications()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                <div>
                  <div class="font-medium">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                  <div class="text-sm text-slate-400">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingMessagePreview" onchange="saveAppSettings()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
            </div>
          </div>

          <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
          <div>
            <h4 class="text-lg font-semibold mb-3 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
              –°–æ–æ–±—â–µ–Ω–∏—è
            </h4>
            <div class="space-y-3">
              <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                <div>
                  <div class="font-medium">Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</div>
                  <div class="text-sm text-slate-400">–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingEnterToSend" onchange="saveAppSettings()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                <div>
                  <div class="font-medium">–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞</div>
                  <div class="text-sm text-slate-400">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingAutoDownload" onchange="saveAppSettings()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                <div>
                  <div class="font-medium">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏</div>
                  <div class="text-sm text-slate-400">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–≥–¥–∞ –≤—ã –ø–µ—á–∞—Ç–∞–µ—Ç–µ</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingTypingIndicator" onchange="saveAppSettings()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                <div>
                  <div class="font-medium">–û—Ç–º–µ—Ç–∫–∏ –æ –ø—Ä–æ—á—Ç–µ–Ω–∏–∏</div>
                  <div class="text-sm text-slate-400">–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–º–µ—Ç–∫–∏ –æ –ø—Ä–æ—á—Ç–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingReadReceipts" onchange="saveAppSettings()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
            </div>
          </div>

          <!-- –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å -->
          <div>
            <h4 class="text-lg font-semibold mb-3 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å
            </h4>
            <div class="space-y-3">
              <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                <div>
                  <div class="font-medium">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å "–í —Å–µ—Ç–∏"</div>
                  <div class="text-sm text-slate-400">–î—Ä—É–≥–∏–µ –≤–∏–¥—è—Ç –∫–æ–≥–¥–∞ –≤—ã –æ–Ω–ª–∞–π–Ω</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingShowOnline" onchange="saveAppSettings()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                <div>
                  <div class="font-medium">–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–∑–∏—Ç–∞</div>
                  <div class="text-sm text-slate-400">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å "–±—ã–ª(–∞) –≤ —Å–µ—Ç–∏"</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingShowLastSeen" onchange="saveAppSettings()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
            </div>
          </div>

          <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
          <div>
            <h4 class="text-lg font-semibold mb-3 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/></svg>
              –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            </h4>
            <div class="space-y-3">
              <div class="p-3 bg-white/5 rounded-xl">
                <div class="flex items-center justify-between mb-3">
                  <div class="font-medium">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</div>
                  <span id="fontSizeValue" class="text-sm font-semibold text-violet-400">14px</span>
                </div>
                <input type="range" id="settingFontSize" min="12" max="18" value="14" step="1" oninput="updateFontSize()">
              </div>
              <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                <div>
                  <div class="font-medium">–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º</div>
                  <div class="text-sm text-slate-400">–£–º–µ–Ω—å—à–∏—Ç—å –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingCompactMode" onchange="toggleCompactMode()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                <div>
                  <div class="font-medium">–ê–Ω–∏–º–∞—Ü–∏–∏</div>
                  <div class="text-sm text-slate-400">–í–∫–ª—é—á–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="settingAnimations" onchange="saveAppSettings()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
            </div>
          </div>

          <!-- –•—Ä–∞–Ω–∏–ª–∏—â–µ -->
          <div>
            <h4 class="text-lg font-semibold mb-3 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
              –•—Ä–∞–Ω–∏–ª–∏—â–µ
            </h4>
            <div class="space-y-3">
              <div class="p-3 bg-white/5 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                  <div class="font-medium">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</div>
                  <span id="storageUsed" class="text-sm text-slate-400">–ü–æ–¥—Å—á–µ—Ç...</span>
                </div>
                <div class="w-full bg-white/10 rounded-full h-2">
                  <div id="storageBar" class="gradient-bg h-2 rounded-full" style="width: 0%"></div>
                </div>
              </div>
              <button class="w-full p-3 bg-red-500/15 text-red-300 rounded-xl font-medium hover:bg-red-500/25 transition" onclick="clearCache()">
                –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
              </button>
            </div>
          </div>

          <!-- –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ -->
          <div>
            <h4 class="text-lg font-semibold mb-3 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
            </h4>
            <div class="p-4 bg-white/5 rounded-xl text-center">
              <div class="w-16 h-16 gradient-bg rounded-2xl mx-auto mb-3 grid place-items-center">
                <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
              </div>
              <div class="text-xl font-bold mb-1">FlashChat Pro</div>
              <div class="text-sm text-slate-400 mb-3">–í–µ—Ä—Å–∏—è 1.0.0</div>
              <div class="text-xs text-slate-500">¬© 2025 FlashChat. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal (group/channel) -->
    <div id="settingsModal" class="modal" onclick="modalBackdropClose(event, 'settingsModal')">
      <div class="sheet p-6 max-h-[90vh] overflow-auto scrollbar">
        <div class="flex justify-between items-center mb-6">
          <h3 id="settingsTitle" class="text-xl font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <button class="icon-btn" onclick="closeModal('settingsModal')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <div class="space-y-4">
          <!-- Avatar upload -->
          <div class="flex justify-center mb-4">
            <div class="avatar-upload">
              <div id="settingsAvatar" class="chat-avatar chat-avatar-lg gradient-bg cursor-pointer">
                <span id="settingsAvatarLetter"></span>
                <img id="settingsAvatarImg" src="" class="hidden" alt="avatar">
              </div>
              <input type="file" id="settingsAvatarInput" accept="image/*" onchange="handleAvatarSelect(event)">
              <div class="avatar-upload-overlay">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </div>
            </div>
          </div>
          <p class="text-center text-xs text-slate-400 -mt-2 mb-4">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏</p>

          <div>
            <label class="block text-sm text-slate-400 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input id="settingsName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
          </div>

          <div id="settingsDescriptionBlock">
            <label class="block text-sm text-slate-400 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="settingsDescription" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500 resize-none h-24"></textarea>
          </div>

          <div id="settingsMembersBlock">
            <label class="block text-sm text-slate-400 mb-2">–£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="settingsMemberCount">0</span>)</label>
            <div id="settingsMembersList" class="space-y-2 max-h-56 overflow-auto scrollbar"></div>
          </div>

          <button class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="w-full py-3 bg-red-500/15 text-red-300 rounded-xl font-medium hover:bg-red-500/25" onclick="deleteGroupOrChannel()"><span id="deleteButtonText">–£–¥–∞–ª–∏—Ç—å</span></button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ====== CONFIG ======
    const IMGBB_API_KEY = 'f457bea1a8c6cf16c4a03634c8ea3177';
    
    // Litterbox.catbox.moe - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ (–¥–æ 1GB, —Ö—Ä–∞–Ω–µ–Ω–∏–µ 1 —á–∞—Å - 3 –¥–Ω—è)
    const LITTERBOX_API_URL = 'https://litterbox.catbox.moe/resources/internals/api.php';

    /* 
    ====== –í–ê–ñ–ù–û: –ü–†–ê–í–ò–õ–ê FIREBASE ======
    
    ‚ö†Ô∏è –°–†–û–ß–ù–û! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –≤ Firebase Console:
    
    1. –û—Ç–∫—Ä–æ–π—Ç–µ Firebase Console: https://console.firebase.google.com
    2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç "webchat-28b64"
    3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Realtime Database -> Rules
    4. –ó–∞–º–µ–Ω–∏—Ç–µ –í–°–ï –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ —ç—Ç–∏:
    
    {
      "rules": {
        "users": {
          ".read": "auth != null",
          ".write": "auth != null"
        },
        "userChats": {
          ".read": "auth != null",
          ".write": "auth != null"
        },
        "chats": {
          ".read": "auth != null",
          ".write": "auth != null"
        },
        "groups": {
          ".read": "auth != null",
          ".write": "auth != null"
        },
        "channels": {
          ".read": "auth != null",
          ".write": "auth != null"
        },
        "messages": {
          ".read": "auth != null",
          ".write": "auth != null",
          ".indexOn": ["timestamp"]
        },
        "files": {
          ".read": "auth != null",
          ".write": "auth != null"
        },
        "savedMessages": {
          ".read": "auth != null",
          ".write": "auth != null",
          ".indexOn": ["savedAt"]
        },
        "typing": {
          ".read": "auth != null",
          ".write": "auth != null"
        },
        "pinnedMessages": {
          ".read": "auth != null",
          ".write": "auth != null"
        }
      }
    }
    
    5. –ù–∞–∂–º–∏—Ç–µ "Publish" (–∫—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö—É)
    6. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 5-10 —Å–µ–∫—É–Ω–¥
    7. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ (F5)
    
    ‚úÖ –≠—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–µ—à–∞—é—Ç –¥–æ—Å—Ç—É–ø –≤—Å–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
    üîí –ü–æ–∑–∂–µ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
    
    –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª–µ–Ω —É–∑–µ–ª "userChats" –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!
    
    */

    const DEVELOPER_EMAILS = [
      'stepanu142z@gmail.com',
      'Stepan42z@yandex.ru'
    ];

    function isDeveloper(email){
      if(!email) return false;
      return DEVELOPER_EMAILS.some(e => e.toLowerCase() === String(email).toLowerCase());
    }

    function getDevBadgeHtml(){
      return `<span class="dev-badge"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>DEV</span>`;
    }

    function getNameWithBadge(name, email){
      const safeName = escapeHtml(name || '');
      return isDeveloper(email) ? safeName + ' ' + getDevBadgeHtml() : safeName;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBeLAiCwZjij3d6FZ4OzylJnaxPwlyf1Ag",
      authDomain: "webchat-28b64.firebaseapp.com",
      databaseURL: "https://webchat-28b64-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "webchat-28b64",
      storageBucket: "webchat-28b64.firebasestorage.app",
      messagingSenderId: "307131215178",
      appId: "1:307131215178:web:0e510297256e30959825b3",
      measurementId: "G-JD21B447LF"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    const storage = firebase.storage();
    
    console.log('Firebase initialized');
    console.log('Auth:', auth);
    console.log('Database:', database);
    
    // ====== CHECK API SUPPORT ======
    function checkMediaSupport() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        console.warn('MediaDevices API not supported');
        return false;
      }
      if (typeof MediaRecorder === 'undefined') {
        console.warn('MediaRecorder API not supported');
        return false;
      }
      return true;
    }
    
    const mediaSupported = checkMediaSupport();

    // ====== STATE ======
    let currentUser = null;
    let currentUserData = null;
    let currentChat = null;
    let currentChatType = null;
    let currentChatData = null;
    let typingTimeout = null;
    let unreadCounts = {};
    let selectedGroupMembers = [];
    let currentMessageId = null;
    let currentTab = 'all';
    let allChats = [];
    let allUsers = {};
    let toastChatId = null;
    let pendingFile = null;
    let uploadTask = null;
    let isUploading = false;
    let pendingAvatarFile = null;
    let notificationSound = null;
    let audioContext = null;

    // ====== NOTIFICATION SOUND ======
    function initNotificationSound() {
      try {
        // –°–æ–∑–¥–∞—ë–º AudioContext –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–≤—É–∫–∞
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        notificationSound = true;
        console.log('Notification sound initialized');
      } catch(e) {
        console.warn('Web Audio API not supported:', e);
        notificationSound = false;
      }
    }

    function playNotificationSound() {
      if (!audioContext || !notificationSound) return;
      
      try {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º AudioContext –µ—Å–ª–∏ –æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }

        // –°–æ–∑–¥–∞—ë–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–¥–≤–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ç–æ–Ω–∞ –∫–∞–∫ –≤ Telegram)
        const now = audioContext.currentTime;
        
        // –ü–µ—Ä–≤—ã–π —Ç–æ–Ω
        const osc1 = audioContext.createOscillator();
        const gain1 = audioContext.createGain();
        osc1.connect(gain1);
        gain1.connect(audioContext.destination);
        osc1.frequency.value = 880; // –ù–æ—Ç–∞ A5
        osc1.type = 'sine';
        gain1.gain.setValueAtTime(0.3, now);
        gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc1.start(now);
        osc1.stop(now + 0.1);

        // –í—Ç–æ—Ä–æ–π —Ç–æ–Ω (—á—É—Ç—å –≤—ã—à–µ)
        const osc2 = audioContext.createOscillator();
        const gain2 = audioContext.createGain();
        osc2.connect(gain2);
        gain2.connect(audioContext.destination);
        osc2.frequency.value = 1100; // –ù–æ—Ç–∞ C#6
        osc2.type = 'sine';
        gain2.gain.setValueAtTime(0.3, now + 0.12);
        gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
        osc2.start(now + 0.12);
        osc2.stop(now + 0.25);

      } catch(e) {
        console.warn('Error playing notification sound:', e);
      }
    }

    // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function requestNotificationPermission() {
      if (!('Notification' in window)) {
        console.log('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
        return;
      }
      
      if (Notification.permission === 'default') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        showNotificationPrompt();
      }
    }

    function showNotificationPrompt() {
      // –°–æ–∑–¥–∞—ë–º –∫—Ä–∞—Å–∏–≤—ã–π –±–∞–Ω–Ω–µ—Ä –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
      const banner = document.createElement('div');
      banner.id = 'notificationBanner';
      banner.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 1000;
        box-shadow: 0 10px 40px rgba(102,126,234,0.4);
        max-width: 90%;
        animation: slideDown 0.3s ease;
      `;
      banner.innerHTML = `
        <svg width="24" height="24" fill="white" viewBox="0 0 24 24">
          <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/>
        </svg>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;font-size:14px;">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?</div>
          <div style="font-size:12px;opacity:0.9;">–£–∑–Ω–∞–≤–∞–π—Ç–µ –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</div>
        </div>
        <button id="allowNotifBtn" style="background:white;color:#667eea;border:none;padding:8px 16px;border-radius:10px;font-weight:600;font-size:13px;cursor:pointer;">
          –í–∫–ª—é—á–∏—Ç—å
        </button>
        <button id="denyNotifBtn" style="background:transparent;color:white;border:1px solid rgba(255,255,255,0.3);padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">
          –ü–æ–∑–∂–µ
        </button>
      `;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideDown {
          from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
          to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(banner);
      
      document.getElementById('allowNotifBtn').onclick = async () => {
        try {
          const permission = await Notification.requestPermission();
          console.log('Notification permission:', permission);
          if (permission === 'granted') {
            showToast('üîî', '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', '–í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö');
          }
        } catch(e) {
          console.error('Error requesting notification permission:', e);
        }
        banner.remove();
      };
      
      document.getElementById('denyNotifBtn').onclick = () => {
        banner.remove();
        // –ó–∞–ø–æ–º–Ω–∏–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è (–Ω–∞ 24 —á–∞—Å–∞)
        localStorage.setItem('notifPromptDismissed', Date.now().toString());
      };
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        if (document.getElementById('notificationBanner')) {
          banner.remove();
        }
      }, 15000);
    }

    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∞—É–¥–∏–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function unlockAudio() {
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
      // –£–¥–∞–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
      document.removeEventListener('click', unlockAudio);
      document.removeEventListener('touchstart', unlockAudio);
      document.removeEventListener('keydown', unlockAudio);
    }

    document.addEventListener('click', unlockAudio);
    document.addEventListener('touchstart', unlockAudio);
    document.addEventListener('keydown', unlockAudio);

    // ====== EMOJI DATA (large, TG-like categories) ======
    const EMOJI = {
      smileys: "üòÄ üòÉ üòÑ üòÅ üòÜ üòÖ üòÇ ü§£ üòä üòá üôÇ üôÉ üòâ üòå üòç ü•∞ üòò üòó üòô üòö üòã üòõ üòù üòú ü§™ ü§® üßê ü§ì üòé ü•∏ ü§© ü•≥ üòè üòí üòû üòî üòü üòï üôÅ ‚òπÔ∏è üò£ üòñ üò´ üò© ü•∫ üò¢ üò≠ üò§ üò† üò° ü§¨ üò≥ ü•µ ü•∂ üò± üò® üò∞ üò• üòì ü§ó ü§≠ ü§´ ü§î ü§ê üòê üòë üò∂ ü´• üò¨ üôÑ üòØ üò¶ üòß üòÆ üò≤ ü•± üò¥ ü§§ üò™ üòµ ü§Ø ü§† ü•¥ ü§Æ ü§¢ ü§ß ü§í ü§ï ü´† ü´°".split(" "),
      gestures: "üëã ü§ö üñêÔ∏è ‚úã üññ üëå ü§å ü§è ‚úåÔ∏è ü§û ü§ü ü§ò ü§ô ü´µ üëà üëâ üëÜ üñï üëá ‚òùÔ∏è üëç üëé ‚úä üëä ü§õ ü§ú üëè üôå üëê ü§≤ ü§ù üôè ‚úçÔ∏è üíÖ ü§≥ üí™ ü¶æ ü¶ø ü¶µ ü¶∂ üëÇ ü¶ª üëÉ üß† ü´Ä ü´Å üëÄ üëÅÔ∏è üëÖ üëÑ üíã".split(" "),
      animals: "üê∂ üê± üê≠ üêπ üê∞ ü¶ä üêª üêº üêª‚Äç‚ùÑÔ∏è üê® üêØ ü¶Å üêÆ üê∑ üêΩ üê∏ üêµ üôà üôâ üôä üêí üêî üêß üê¶ üê§ üê£ üê• ü¶Ü ü¶Ö ü¶â ü¶á üê∫ üêó üê¥ ü¶Ñ üêù ü™≤ üêõ ü¶ã üêå üêû üêú ü¶ü ü™∞ ü™± üê¢ üêç ü¶é üêô ü¶ë ü¶ê ü¶û ü¶Ä üê° üê† üêü üê¨ üê≥ üêã ü¶à üêä".split(" "),
      food: "üçè üçé üçê üçä üçã üçå üçâ üçá üçì ü´ê üçà üçí üçë ü•≠ üçç ü•• ü•ù üçÖ ü•ë üçÜ ü•î ü•ï üåΩ üå∂Ô∏è ü´ë ü•í ü•¨ ü•¶ üßÑ üßÖ üçÑ ü•ú ü´ò üå∞ üçû ü•ê ü•ñ ü´ì ü•® üßÄ ü•ö üç≥ üßà ü•û üßá ü•ì ü•© üçó üçñ üå≠ üçî üçü üçï ü•™ ü•ô üßÜ üåÆ üåØ ü•ó ü•ò üçù üçú üç≤ üçõ üç£ üç± üçô üçö üçò üç• ü•ü ü•† ü•° üç¢ üç° üçß üç® üç¶ ü•ß üßÅ üç∞ üéÇ üçÆ üç≠ üç¨ üç´ üçø üç© üç™ ‚òï üçµ üßÉ ü•§ üßã üç∫ üçª ü•Ç üç∑ üç∏ üçπ üßâ".split(" "),
      activities: "‚öΩ üèÄ üèà ‚öæ ü•é üéæ üèê üèâ ü•è üé± ü™Ä üèì üè∏ üèí üèë ü•ç üèè ‚õ≥ ü™Å üèπ üé£ ü§ø ü•ä ü•ã üéΩ üõπ üõ∑ ‚õ∏Ô∏è ü•å üéø ‚õ∑Ô∏è üèÇ üèãÔ∏è ü§º ü§∏ ‚õπÔ∏è ü§∫ üèá üßò üèÑ üèä üö¥ üöµ üßó üé™ üé≠ üé® üé¨ üé§ üéß üéº üéπ ü•Å üé∑ üé∫ üé∏ üéª üé≤ ‚ôüÔ∏è üéØ üé≥ üéÆ üïπÔ∏è üé∞ üß©".split(" "),
      travel: "üöó üöï üöô üöå üöé üèéÔ∏è üöì üöë üöí üöê üõª üöö üöõ üöú üèçÔ∏è üõµ üö≤ üõ¥ üöÅ ‚úàÔ∏è üõ©Ô∏è üöÄ üõ∏ üö¢ ‚õµ üö§ üõ•Ô∏è üöÇ üöÉ üöÑ üöÖ üöÜ üöá üöà üöâ üó∫Ô∏è üß≠ üèîÔ∏è ‚õ∞Ô∏è üåã üóª üèïÔ∏è üèñÔ∏è üèúÔ∏è üèùÔ∏è üèüÔ∏è üèõÔ∏è üèóÔ∏è üß± üè† üè° üè¢ üè£ üè• üè¶ üè® üè© üè™ üè´ üè¨ üè≠ üóº üóΩ ‚õ™ üïå üõï ‚õ©Ô∏è üåâ üåå üå†".split(" "),
      objects: "‚åö üì± üíª ‚å®Ô∏è üñ•Ô∏è üñ®Ô∏è üñ±Ô∏è üñ≤Ô∏è üíΩ üíæ üíø üìÄ üì∑ üì∏ üìπ üé• üìΩÔ∏è üì∫ üìª üéôÔ∏è üéöÔ∏è üéõÔ∏è üìû ‚òéÔ∏è üìü üì† üîã üîå üí° üî¶ üïØÔ∏è ü™î üßØ üõ¢Ô∏è üí∏ üíµ üí¥ üí∂ üí∑ üí∞ üí≥ üíé ‚öñÔ∏è üîß üî® ‚öíÔ∏è üõ†Ô∏è ‚õèÔ∏è ü™ì üî© ‚öôÔ∏è üóúÔ∏è üîó ‚õìÔ∏è üß∞ üß≤ üîí üîì üîë üóùÔ∏è üîê üß≥ üì¶ üì´ üì¨ üì≠ üìÆ ‚úâÔ∏è üìß üì® üìù üìÅ üìÇ üóÇÔ∏è üìÖ üìÜ üìä üìà üìâ üìã üìå üìç".split(" "),
      symbols: "‚ù§Ô∏è üß° üíõ üíö üíô üíú üñ§ ü§ç ü§é üíî ‚ù£Ô∏è üíï üíû üíì üíó üíñ üíò üíù üíü ‚òÆÔ∏è ‚úùÔ∏è ‚ò™Ô∏è üïâÔ∏è ‚òØÔ∏è ‚ú°Ô∏è üîØ ‚ôà ‚ôâ ‚ôä ‚ôã ‚ôå ‚ôç ‚ôé ‚ôè ‚ôê ‚ôë ‚ôí ‚ôì ‚õé üîÄ üîÅ üîÇ ‚ñ∂Ô∏è ‚è© ‚è≠Ô∏è ‚èØÔ∏è ‚óÄÔ∏è ‚è™ üîº ‚è´ üîΩ ‚è¨ ‚è∏Ô∏è ‚èπÔ∏è ‚è∫Ô∏è üîÜ üîÖ üì∂ üì≥ üì¥ ‚úñÔ∏è ‚ûï ‚ûñ ‚ûó ‚ôæÔ∏è üí≤ üí± ‚Ñ¢Ô∏è ¬©Ô∏è ¬ÆÔ∏è „Ä∞Ô∏è ‚û∞ ‚ûø ‚úîÔ∏è ‚òëÔ∏è üîò üî¥ üü† üü° üü¢ üîµ üü£ ‚ö´ ‚ö™ üü§ üî∫ üîª üî∏ üîπ üî∂ üî∑ üî≥ üî≤ ‚ñ™Ô∏è ‚ñ´Ô∏è ‚óæ ‚óΩ ‚¨õ ‚¨ú üîî üîï üîä üîá üí¨ üí≠ üóØÔ∏è üî• ‚ú® üéâ üíØ ‚≠ê üåü üí´ ‚ö° üí• üéä üéÅ üèÜ ü•á ü•à ü•â üèÖ üéñÔ∏è üéóÔ∏è".split(" ")
    };

    // ====== UI HELPERS ======
    function $(id){ return document.getElementById(id); }

    function showModal(id){ $(id).classList.add('show'); }
    function closeModal(id){ $(id).classList.remove('show'); }

    function modalBackdropClose(e, id){
      if(e.target && e.target.id === id) closeModal(id);
    }

    function showToast(icon, title, msg, chatId=null){
      toastChatId = chatId;
      $('toastIcon').textContent = icon;
      $('toastTitle').textContent = title;
      $('toastMessage').textContent = msg;
      const t = $('toast');
      t.classList.remove('hidden');
      clearTimeout(t._timer);
      t._timer = setTimeout(()=> t.classList.add('hidden'), 4000);
    }

    function handleToastClick(){
      $('toast').classList.add('hidden');
      if(toastChatId){
        const chat = allChats.find(c => c.id === toastChatId);
        if(chat) openChat(toastChatId, chat.type);
      }
    }

    function escapeHtml(text){
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    function formatTime(ts){
      if(!ts) return '';
      const d = new Date(ts);
      const now = new Date();
      if(d.toDateString() === now.toDateString()){
        return d.toLocaleTimeString('ru-RU',{hour:'2-digit', minute:'2-digit'});
      }
      return d.toLocaleDateString('ru-RU',{day:'numeric', month:'short'});
    }

    function formatLastSeen(ts){
      if(!ts) return '–¥–∞–≤–Ω–æ';
      const diff = Date.now() - ts;
      if(diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
      if(diff < 3600000) return `${Math.floor(diff/60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
      if(diff < 86400000) return `${Math.floor(diff/3600000)} —á –Ω–∞–∑–∞–¥`;
      return new Date(ts).toLocaleDateString('ru-RU');
    }

    // ====== AUTH UI ======
    function showTab(tab){
      $('loginForm').classList.toggle('hidden', tab !== 'login');
      $('registerForm').classList.toggle('hidden', tab !== 'register');
      $('loginTab').classList.toggle('bg-violet-600', tab === 'login');
      $('loginTab').classList.toggle('text-white', tab === 'login');
      $('loginTab').classList.toggle('text-slate-400', tab !== 'login');
      $('registerTab').classList.toggle('bg-violet-600', tab === 'register');
      $('registerTab').classList.toggle('text-white', tab === 'register');
      $('registerTab').classList.toggle('text-slate-400', tab !== 'register');
    }

    function getErrorMessage(code){
      const messages = {
        'auth/email-already-in-use': 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è',
        'auth/invalid-email': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email',
        'auth/weak-password': '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)',
        'auth/user-not-found': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω',
        'auth/wrong-password': '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',
        'auth/invalid-credential': '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å',
        'auth/too-many-requests': '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ',
        'auth/network-request-failed': '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç',
        'auth/operation-not-allowed': '–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞',
        'auth/user-disabled': '–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω',
        'auth/requires-recent-login': '–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥',
        'auth/missing-password': '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å',
        'auth/missing-email': '–í–≤–µ–¥–∏—Ç–µ email'
      };
      return messages[code] || null;
    }

    function showAuthError(msg){
      const el = $('authError');
      el.textContent = msg;
      el.classList.remove('hidden');
      clearTimeout(el._timer);
      el._timer = setTimeout(()=> el.classList.add('hidden'), 4000);
    }

    // Accounts storage
    function loadSavedAccounts(){
      const accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      const container = $('savedAccounts');
      const list = $('accountsList');

      if(accounts.length){
        container.classList.remove('hidden');
        list.innerHTML = accounts.map(acc => `
          <div class="flex items-center gap-3 p-2 rounded-xl bg-white/5 border border-white/10">
            <div class="w-8 h-8 gradient-bg rounded-full grid place-items-center font-bold text-sm">${escapeHtml((acc.name||'?').charAt(0).toUpperCase())}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm truncate">${escapeHtml(acc.name||acc.email)}</div>
              <div class="text-xs text-slate-400 truncate">${escapeHtml(acc.email)}</div>
            </div>
            <button class="text-xs bg-violet-600 px-2 py-1 rounded-lg" onclick="quickLogin('${escapeHtml(acc.email)}','${escapeHtml(acc.password)}')">–í–æ–π—Ç–∏</button>
            <button class="text-slate-400 hover:text-red-300 p-1" onclick="removeAccount('${escapeHtml(acc.email)}')">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        `).join('');
      } else {
        container.classList.add('hidden');
        list.innerHTML = '';
      }
    }

    function saveAccount(email,password,name){
      let accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      accounts = accounts.filter(a => a.email !== email);
      accounts.unshift({email,password,name});
      if(accounts.length > 5) accounts = accounts.slice(0,5);
      localStorage.setItem('flashchat_accounts', JSON.stringify(accounts));
    }

    function removeAccount(email){
      let accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      accounts = accounts.filter(a => a.email !== email);
      localStorage.setItem('flashchat_accounts', JSON.stringify(accounts));
      loadSavedAccounts();
    }

    function quickLogin(email,password){
      $('loginEmail').value = email;
      $('loginPassword').value = password;
      login(new Event('submit'));
    }

    // ====== NAV ======
    function showAuthScreen(){
      $('authScreen').style.display = 'block';
      $('chatScreen').classList.remove('active');
      $('chatScreen').style.display = 'none';
    }

    function showChatScreen(){
      $('authScreen').style.display = 'none';
      $('chatScreen').style.display = '';
      $('chatScreen').classList.add('active');

      // reset panels
      $('sidebar').style.display = 'flex';
      $('chatArea').classList.remove('active');
      $('chatArea').style.display = window.innerWidth <= 768 ? 'none' : 'flex';

      $('emptyChat').style.display = 'flex';
      $('activeChat').classList.remove('active');

      renderChatList();
    }

    function closeChat(){
      const prevChat = currentChat;
      currentChat = null;
      currentChatType = null;
      currentChatData = null;

      // Stop listeners for messages + typing
      if(prevChat){
        database.ref(`messages/${prevChat}`).off();
        database.ref(`typing/${prevChat}`).off();
      }

      $('activeChat').classList.remove('active');
      $('emptyChat').style.display = 'flex';

      if(window.innerWidth <= 768){
        $('chatArea').classList.remove('active');
        $('chatArea').style.display = 'none';
        $('sidebar').style.display = 'flex';
      }
    }

    // ====== FIREBASE auth ======
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    initNotificationSound();
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    requestNotificationPermission();

    auth.onAuthStateChanged(async user => {
      console.log('Auth state changed:', user ? user.email : 'logged out');
      
      if(user){
        currentUser = user;
        console.log('Loading user data...');
        
        try {
          await loadUserData();
          console.log('User data loaded');
          
          await loadAllUsers();
          console.log('All users loaded');
          
          showChatScreen();
          console.log('Chat screen shown');
          
          updateOnlineStatus(true);
          setupPresenceOnDisconnect();
          
          loadAllChats();
          console.log('Loading chats...');
          
          setupNotificationListener();
          
          // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—Ä–∞–∂–∞—Ç—å)
          setTimeout(() => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫–∞–∑–∞–ª—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–Ω–µ–µ
            const dismissed = localStorage.getItem('notifPromptDismissed');
            if (dismissed) {
              const dismissedTime = parseInt(dismissed);
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
              if (Date.now() - dismissedTime < 24 * 60 * 60 * 1000) {
                return;
              }
            }
            
            if ('Notification' in window && Notification.permission === 'default') {
              showNotificationPrompt();
            }
          }, 3000); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
        } catch (err) {
          console.error('Error during initialization:', err);
          showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firebase Rules.');
        }
      } else {
        currentUser = null;
        currentUserData = null;
        showAuthScreen();
      }
    });

    async function login(e){
      console.log('Login function called');
      e.preventDefault();
      console.log('Event prevented');
      
      const email = $('loginEmail').value.trim();
      const password = $('loginPassword').value;
      const save = $('saveAccount').checked;
      
      console.log('Login data:', { email, passwordLength: password.length, save });

      if(!email) {
        console.log('No email provided');
        return showAuthError('–í–≤–µ–¥–∏—Ç–µ email');
      }
      if(!password) {
        console.log('No password provided');
        return showAuthError('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
      }

      try{
        console.log('Attempting to sign in with Firebase...');
        await auth.signInWithEmailAndPassword(email, password);
        console.log('Login successful!');
        
        if(save){
          console.log('Saving account...');
          const snap = await database.ref(`users/${auth.currentUser.uid}`).once('value');
          const userData = snap.val();
          saveAccount(email, password, userData?.name || email);
          loadSavedAccounts();
        }
      } catch(err){
        console.error('Login error:', err);
        console.error('Error code:', err.code);
        console.error('Error message:', err.message);
        showAuthError(getErrorMessage(err.code) || err.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
      }
    }

    async function register(e){
      e.preventDefault();
      const name = $('registerName').value.trim();
      const email = $('registerEmail').value.trim();
      const password = $('registerPassword').value;
      
      if(!name) return showAuthError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
      if(!email) return showAuthError('–í–≤–µ–¥–∏—Ç–µ email');
      if(!password || password.length < 6) return showAuthError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');

      try{
        console.log('Registering user:', email);
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        console.log('User created:', cred.user.uid);
        
        await database.ref(`users/${cred.user.uid}`).set({
          name,
          nameLower: name.toLowerCase(),
          email,
          status: '–ü—Ä–∏–≤–µ—Ç! –Ø –∏—Å–ø–æ–ª—å–∑—É—é FlashChat',
          online: true,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });
        console.log('User data saved to database');
        
        saveAccount(email, password, name);
        loadSavedAccounts();
        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!');
      } catch(err){
        console.error('Registration error:', err);
        showAuthError(getErrorMessage(err.code) || err.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
      }
    }

    function logout(){
      if(currentUser){
        // –û—Ç–∫–ª—é—á–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        database.ref('.info/connected').off();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º offline —Å—Ç–∞—Ç—É—Å
        database.ref(`users/${currentUser.uid}`).update({
          online: false,
          lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
      }
      
      auth.signOut();
      closeModal('profileModal');
    }

    async function loadUserData(){
      const snap = await database.ref(`users/${currentUser.uid}`).once('value');
      currentUserData = snap.val() || {};
    }

    async function loadAllUsers(){
      try {
        console.log('Fetching users from database...');
        const snap = await database.ref('users').once('value');
        allUsers = snap.val() || {};
        console.log('Users loaded:', Object.keys(allUsers).length);
      } catch (err) {
        console.error('Error loading users:', err);
        throw err;
      }
    }

    function updateOnlineStatus(status){
      if(!currentUser) return;
      database.ref(`users/${currentUser.uid}`).update({
        online: status,
        lastSeen: firebase.database.ServerValue.TIMESTAMP
      });
    }

    function setupPresenceOnDisconnect(){
      if(!currentUser) return;
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—É—Ç—å .info/connected –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      const connectedRef = database.ref('.info/connected');
      const userStatusRef = database.ref(`users/${currentUser.uid}`);
      
      connectedRef.on('value', (snapshot) => {
        if (snapshot.val() === false) {
          return;
        }
        
        // –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å offline
        userStatusRef.onDisconnect().update({
          online: false,
          lastSeen: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          // –ö–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å online
          userStatusRef.update({
            online: true,
            lastSeen: firebase.database.ServerValue.TIMESTAMP
          });
        });
      });
    }

    // ====== CHAT LIST ======
    function showChatTab(tab){
      currentTab = tab;
      ['all','private','groups','channels'].forEach(t => {
        const el = $('tab' + t.charAt(0).toUpperCase() + t.slice(1));
        el.classList.toggle('bg-violet-600', t === tab);
        el.classList.toggle('text-white', t === tab);
        el.classList.toggle('text-slate-400', t !== tab);
      });
      renderChatList();
    }

    function loadAllChats(){
      console.log('loadAllChats called for user:', currentUser.uid);
      
      // prevent duplicates
      database.ref(`userChats/${currentUser.uid}`).off('value');

      database.ref(`userChats/${currentUser.uid}`).on('value', async snapshot => {
        console.log('userChats snapshot received');
        const chats = snapshot.val() || {};
        console.log('Raw chats data:', chats);
        console.log('Number of chats:', Object.keys(chats).length);
        
        const processed = new Set();
        const list = [];

        for(const [chatId, chatData] of Object.entries(chats)){
          console.log('Processing chat:', chatId, chatData);
          
          if(processed.has(chatId)) continue;
          processed.add(chatId);

          try{
            let chatInfo = { id: chatId, ...chatData, unread:0 };

            // last message
            const msgSnap = await database.ref(`messages/${chatId}`).orderByChild('timestamp').limitToLast(1).once('value');
            const msgs = msgSnap.val();
            if(msgs){
              const lastMsg = Object.values(msgs)[0];
              chatInfo.lastMessage = lastMsg.text || (lastMsg.fileUrl ? 'üìé –§–∞–π–ª' : '');
              chatInfo.lastTime = lastMsg.timestamp;
              chatInfo.lastSenderId = lastMsg.senderId;
            }

            // unread count
            const unreadSnap = await database.ref(`messages/${chatId}`).orderByChild('timestamp').once('value');
            const allMsgs = unreadSnap.val() || {};
            let unread = 0;
            for(const msg of Object.values(allMsgs)){
              if(msg.senderId !== currentUser.uid && (!msg.readBy || !msg.readBy[currentUser.uid])) unread++;
            }
            chatInfo.unread = unread;
            unreadCounts[chatId] = unread;

            if(chatData.type === 'private'){
              const userData = allUsers[chatData.oderId];
              console.log('Private chat with user:', chatData.oderId, userData);
              if(userData){
                chatInfo.name = userData.name;
                chatInfo.email = userData.email;
                chatInfo.online = userData.online;
                chatInfo.avatar = (userData.name || '?').charAt(0).toUpperCase();
              }
            } else if(chatData.type === 'group' || chatData.type === 'channel') {
              const snap = await database.ref(`${chatData.type}s/${chatId}`).once('value');
              const data = snap.val();
              console.log('Group/Channel data:', data);
              if(data){
                chatInfo.name = data.name;
                chatInfo.avatar = (data.name || '?').charAt(0).toUpperCase();
                chatInfo.avatarUrl = data.avatarUrl || null;
                chatInfo.members = data.members;
                chatInfo.owner = data.owner;
                chatInfo.description = data.description;
              }
            } else {
              console.warn('Unknown chat type:', chatData.type, 'for chat:', chatId);
              continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —á–∞—Ç —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–º —Ç–∏–ø–æ–º
            }

            if(chatInfo.name) {
              console.log('Adding chat to list:', chatInfo);
              list.push(chatInfo);
            } else {
              console.log('Chat has no name, skipping:', chatInfo);
            }
          } catch(err){
            console.error('load chat err', err);
          }
        }

        console.log('Total chats loaded:', list.length);
        list.sort((a,b) => (b.lastTime || 0) - (a.lastTime || 0));
        allChats = list;
        console.log('Calling renderChatList with', allChats.length, 'chats');
        renderChatList();
      });
    }

    function renderChatList(){
      const container = $('chatList');
      let filtered = allChats;
      if(currentTab !== 'all'){
        const typeMap = { private:'private', groups:'group', channels:'channel' };
        filtered = allChats.filter(c => c.type === typeMap[currentTab]);
      }

      if(!filtered.length){
        container.innerHTML = '<div class="p-6 text-center text-slate-500">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';
        return;
      }

      container.innerHTML = filtered.map(chat => {
        const isActive = currentChat === chat.id;
        const statusDot = (chat.type === 'private' && chat.online) ? 'bg-emerald-500' : 'bg-slate-500';
        const typeIcon = chat.type === 'group' ? 'üë•' : chat.type === 'channel' ? 'üì¢' : '';
        const unreadBadge = chat.unread > 0 ? `<div class="min-w-[20px] h-5 rounded-full text-xs flex items-center justify-center px-1 font-semibold" style="background:#0ea5e9; color:#fff;">${chat.unread}</div>` : '';
        const lastMsgPrefix = chat.lastSenderId === currentUser?.uid ? '–í—ã: ' : '';
        const gradientClass = chat.type === 'group' ? 'gradient-green' : chat.type === 'channel' ? 'gradient-orange' : 'gradient-bg';
        const titleHtml = chat.type === 'private' ? getNameWithBadge(chat.name, chat.email) : escapeHtml(chat.name);

        // Avatar with image support
        let avatarHtml;
        if(chat.avatarUrl){
          avatarHtml = `<div class="chat-avatar ${gradientClass}"><img src="${chat.avatarUrl}" alt="avatar"></div>`;
        } else {
          avatarHtml = `<div class="chat-avatar ${gradientClass}">${escapeHtml(chat.avatar || '?')}</div>`;
        }

        return `
          <div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-white/5 transition ${isActive ? 'bg-white/5' : ''}" onclick="openChat('${chat.id}','${chat.type}')">
            <div class="relative shrink-0">
              ${avatarHtml}
              ${chat.type === 'private' ? `<div class="absolute bottom-0 right-0 w-3.5 h-3.5 ${statusDot} rounded-full border-2" style="border-color: rgba(15,23,42,.9)"></div>` : ''}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-center gap-2">
                <div class="font-medium truncate flex items-center gap-2">${typeIcon}<span class="truncate">${titleHtml}</span></div>
                <div class="text-xs text-slate-400 shrink-0">${formatTime(chat.lastTime)}</div>
              </div>
              <div class="flex justify-between items-center gap-2">
                <div class="text-sm text-slate-400 truncate">${escapeHtml(lastMsgPrefix + (chat.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'))}</div>
                ${unreadBadge}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Search
    function searchAll(){
      const query = $('searchInput').value.toLowerCase();
      const container = $('searchResults');
      if(!query){
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }
      const results = allChats.filter(c => (c.name || '').toLowerCase().includes(query));
      if(!results.length){
        container.innerHTML = '<div class="p-3 text-center text-slate-500">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
      } else {
        container.innerHTML = results.map(chat => {
          const gradientClass = chat.type === 'group' ? 'gradient-green' : chat.type === 'channel' ? 'gradient-orange' : 'gradient-bg';
          const title = chat.type === 'private' ? getNameWithBadge(chat.name, chat.email) : escapeHtml(chat.name);
          return `
            <div class="flex items-center gap-3 p-3 hover:bg-white/5 cursor-pointer" onclick="openChat('${chat.id}','${chat.type}'); $('searchInput').value=''; $('searchResults').classList.add('hidden');">
              <div class="w-10 h-10 rounded-full ${gradientClass} grid place-items-center font-bold">${escapeHtml(chat.avatar || '?')}</div>
              <div class="font-medium truncate">${title}</div>
            </div>
          `;
        }).join('');
      }
      container.classList.remove('hidden');
    }

    // ====== OPEN CHAT ======
    async function openChat(chatId, type){
      // Stop previous listeners
      if(currentChat && currentChat !== chatId){
        database.ref(`messages/${currentChat}`).off();
        database.ref(`typing/${currentChat}`).off();
      }

      currentChat = chatId;
      currentChatType = type;

      // Mobile: switch panels
      if(window.innerWidth <= 768){
        $('sidebar').style.display = 'none';
        $('chatArea').style.display = 'flex';
        $('chatArea').classList.add('active');
      } else {
        $('chatArea').style.display = 'flex';
      }

      $('emptyChat').style.display = 'none';
      $('activeChat').classList.add('active');
      closeEmoji();

      if(type === 'private'){
        const chatData = allChats.find(c => c.id === chatId);
        if(chatData){
          currentChatData = chatData;
          const avatarEl = $('chatAvatar');
          avatarEl.innerHTML = '';
          avatarEl.textContent = chatData.avatar || '?';
          avatarEl.className = 'chat-avatar chat-avatar-sm gradient-bg';
          $('chatName').innerHTML = getNameWithBadge(chatData.name, chatData.email);

          database.ref(`users/${chatData.oderId}`).off('value');
          database.ref(`users/${chatData.oderId}`).on('value', snap => {
            const u = snap.val();
            if(u) $('chatStatus').textContent = u.online ? '–í —Å–µ—Ç–∏' : `–ë—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
          });
        }
        $('chatHeaderActions').innerHTML = '';
      } else {
        const snap = await database.ref(`${type}s/${chatId}`).once('value');
        const data = snap.val();
        currentChatData = data;

        const avatarEl = $('chatAvatar');
        const gradientClass = type === 'group' ? 'gradient-green' : 'gradient-orange';
        
        if(data?.avatarUrl){
          avatarEl.innerHTML = `<img src="${data.avatarUrl}" alt="avatar" class="w-full h-full object-cover rounded-full">`;
          avatarEl.className = `chat-avatar chat-avatar-sm ${gradientClass} flex-shrink-0`;
        } else {
          avatarEl.innerHTML = '';
          avatarEl.textContent = (data?.name || '?').charAt(0).toUpperCase();
          avatarEl.className = `chat-avatar chat-avatar-sm ${gradientClass} flex-shrink-0`;
        }
        
        $('chatName').textContent = (type === 'group' ? 'üë• ' : 'üì¢ ') + (data?.name || '');

        const memberCount = Object.keys(data?.members || {}).length;
        $('chatStatus').textContent = type === 'group' ? `${memberCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤` : `${memberCount} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤`;

        const isOwner = data?.owner === currentUser.uid;
        $('chatHeaderActions').innerHTML = isOwner ? `
          <button class="icon-btn" onclick="showSettings('${chatId}','${type}')" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          </button>
        ` : '';
      }

      // Channel restrictions
      const isChannel = type === 'channel';
      const isOwner = currentChatData?.owner === currentUser.uid;
      if(isChannel && !isOwner){
        $('messageInputArea').style.display = 'none';
        $('channelNotice').style.display = 'block';
      } else {
        $('messageInputArea').style.display = 'block';
        $('channelNotice').style.display = 'none';
      }

      loadMessages(chatId);
      setupTypingListener(chatId);
      markAsRead(chatId);
      renderChatList();
      loadPinnedMessage(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

      requestAnimationFrame(() => {
        $('messagesContainer').scrollTop = $('messagesContainer').scrollHeight;
      });
    }

    // ====== MESSAGES ======
    function loadMessages(chatId){
      const container = $('messagesContainer');
      container.innerHTML = '';

      database.ref(`messages/${chatId}`).orderByChild('timestamp').off();
      database.ref(`messages/${chatId}`).orderByChild('timestamp').on('child_added', snap => {
        const msg = snap.val();
        const msgId = snap.key;
        addMessageToUI(msg, msgId);
      });

      database.ref(`messages/${chatId}`).on('child_changed', snap => {
        updateMessageUI(snap.val(), snap.key);
      });

      // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
      database.ref(`messages/${chatId}`).on('child_removed', snap => {
        const msgId = snap.key;
        const msgEl = document.getElementById(`msg-${msgId}`);
        if(msgEl) msgEl.remove();
      });
    }

    function getReadIcon(msg){
      if(msg.readBy && Object.keys(msg.readBy).some(uid => uid !== currentUser.uid)){
        return '<svg class="w-4 h-4 text-sky-300" fill="currentColor" viewBox="0 0 24 24"><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"/></svg>';
      }
      return '<svg class="w-4 h-4 text-slate-300" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>';
    }

    function getReactionsHtml(msgId, msg){
      const reactions = msg.reactions || {};
      const list = Object.entries(reactions).reduce((acc, [emoji, users]) => {
        const count = Object.keys(users||{}).length;
        const hasOwn = !!(users && users[currentUser.uid]);
        if(count > 0) acc.push({emoji, count, hasOwn});
        return acc;
      }, []);

      if(!list.length) return '';

      return `
        <div class="flex flex-wrap gap-1 mt-2">
          ${list.map(r => `
            <button class="px-2 py-0.5 rounded-full text-xs border border-white/10 ${r.hasOwn ? 'bg-violet-600/30' : 'bg-white/5'} hover:bg-white/10" onclick="toggleReaction('${msgId}','${r.emoji}')">
              <span>${r.emoji}</span><span class="ml-1">${r.count}</span>
            </button>
          `).join('')}
        </div>
      `;
    }

    function addMessageToUI(msg, msgId){
      const container = $('messagesContainer');
      const isOwn = msg.senderId === currentUser.uid;

      let senderLine = '';
      if(!isOwn && currentChatType !== 'private'){
        const sender = allUsers[msg.senderId];
        senderLine = `<div class="sender-line">${getNameWithBadge(sender?.name || 'Unknown', sender?.email)}</div>`;
      }

      let content = '';
      
      // –î–æ–±–∞–≤–ª—è–µ–º reply –µ—Å–ª–∏ –µ—Å—Ç—å - —Ç–µ–º–Ω–æ–µ –º–∏–Ω–∏-–æ–∫–æ—à–∫–æ
      if(msg.replyTo){
        const replySender = allUsers[msg.replyTo.senderId]?.name || 'Unknown';
        content += `
          <div class="reply-in-message" style="margin-bottom:10px; padding:10px 12px; background:rgba(0,0,0,.4); border-left:4px solid #8b5cf6; border-radius:8px; backdrop-filter:blur(10px);">
            <div class="reply-name" style="font-size:12px; font-weight:700; color:#a78bfa; margin-bottom:4px; display:flex; align-items:center; gap:4px;">
              <svg style="width:14px; height:14px; flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
              ${escapeHtml(replySender)}
            </div>
            <div class="reply-msg" style="font-size:13px; color:rgba(255,255,255,.9); line-height:1.5; padding-left:18px;">${escapeHtml(msg.replyTo.text).substring(0, 100)}${msg.replyTo.text.length > 100 ? '...' : ''}</div>
          </div>
        `;
      }

      // –î–æ–±–∞–≤–ª—è–µ–º forwarded –µ—Å–ª–∏ –µ—Å—Ç—å
      if(msg.forwarded){
        const forwardFrom = allUsers[msg.forwarded.from]?.name || 'Unknown';
        content += `
          <div style="font-size:11px; color:rgba(148,163,184,.8); margin-bottom:6px; font-style:italic; font-weight:500; display:flex; align-items:center; gap:4px;">
            <svg style="width:12px; height:12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
            –ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç ${escapeHtml(forwardFrom)}
          </div>
        `;
      }

      if(msg.fileUrl){
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å–ª–∏ —ç—Ç–æ –∫—Ä—É–∂–æ–∫ (–≤–∏–¥–µ–æ-—Å–æ–æ–±—â–µ–Ω–∏–µ)
        if(msg.isVideoMessage){
          const fileId = msg.fileUrl.replace('firebase-file://', '');
          content += `
            <div class="video-message-container mb-2" onclick="playVideoMessage('${msgId}')">
              <video id="video-${msgId}" data-file-id="${fileId}" loop muted></video>
              <div class="video-message-play">
                <svg style="width:64px; height:64px; color:white;" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
              </div>
            </div>
          `;
          loadFirebaseFile(fileId, msgId);
        }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å–ª–∏ —ç—Ç–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        else if(msg.isVoiceMessage){
          const fileId = msg.fileUrl.replace('firebase-file://', '');
          const duration = msg.duration || 0;
          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          const durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          content += `
            <div class="audio-player mb-2" id="audio-player-${msgId}">
              <button class="audio-play-btn" onclick="toggleAudioPlayback('${msgId}', '${fileId}')">
                <svg class="play-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
                <svg class="pause-icon hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75A.75.75 0 007.25 3h-1.5zM12.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75h-1.5z"/></svg>
              </button>
              <div class="audio-waveform">
                ${Array(20).fill(0).map((_, i) => {
                  const height = Math.random() * 60 + 20;
                  return `<div class="audio-waveform-bar" style="height:${height}%"></div>`;
                }).join('')}
              </div>
              <div class="audio-time">${durationText}</div>
              <audio id="audio-${msgId}" data-file-id="${fileId}" style="display:none;"></audio>
            </div>
          `;
          loadFirebaseFile(fileId, msgId);
        }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å–ª–∏ —ç—Ç–æ —Ñ–∞–π–ª –∏–∑ Firebase Database
        else if(msg.fileUrl.startsWith('firebase-file://')){
          const fileId = msg.fileUrl.replace('firebase-file://', '');
          
          if(msg.fileType && msg.fileType.startsWith('image/')){
            content += `
              <div class="message-media mb-2">
                <img loading="lazy" data-file-id="${fileId}" alt="image" style="cursor:pointer" onclick="viewFirebaseFile('${fileId}')" />
              </div>
            `;
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            loadFirebaseFile(fileId, msgId);
          } else if(msg.fileType && msg.fileType.startsWith('video/')){
            content += `
              <div class="message-media mb-2">
                <video controls data-file-id="${fileId}"></video>
              </div>
            `;
            loadFirebaseFile(fileId, msgId);
          } else {
            content += `
              <div class="file-chip mb-2" onclick="downloadFirebaseFile('${fileId}', '${escapeHtml(msg.fileName || 'file')}')" style="cursor:pointer">
                <svg class="w-8 h-8 text-violet-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                <div class="min-w-0">
                  <div class="text-sm font-medium truncate">${escapeHtml(msg.fileName || '–§–∞–π–ª')}</div>
                  <div class="text-xs text-slate-400">–°–∫–∞—á–∞—Ç—å</div>
                </div>
              </div>
            `;
          }
        } else {
          // –û–±—ã—á–Ω—ã–µ URL (imgBB –∏ —Ç.–¥.)
          if(msg.fileType && msg.fileType.startsWith('image/')){
            content += `
              <div class="message-media mb-2">
                <img loading="lazy" src="${msg.fileUrl}" alt="image" onclick="viewImage('${msg.fileUrl}')" style="cursor:pointer" />
              </div>
            `;
          } else if(msg.fileType && msg.fileType.startsWith('video/')){
            content += `
              <div class="message-media mb-2">
                <video controls src="${msg.fileUrl}"></video>
              </div>
            `;
          } else {
            content += `
              <a href="${msg.fileUrl}" target="_blank" class="file-chip mb-2">
                <svg class="w-8 h-8 text-violet-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                <div class="min-w-0">
                  <div class="text-sm font-medium truncate">${escapeHtml(msg.fileName || '–§–∞–π–ª')}</div>
                  <div class="text-xs text-slate-400">–û—Ç–∫—Ä—ã—Ç—å</div>
                </div>
              </a>
            `;
          }
        }
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ä–æ—Å –µ—Å–ª–∏ –µ—Å—Ç—å
      if(msg.poll){
        const poll = msg.poll;
        const hasVoted = poll.options.some(opt => opt.voters && opt.voters[currentUser.uid]);
        
        content += `
          <div class="poll-container" style="margin-bottom:8px;">
            <div class="poll-question" style="font-size:15px; font-weight:600; margin-bottom:12px; line-height:1.4;">
              ${escapeHtml(poll.question)}
            </div>
        `;
        
        poll.options.forEach((option, index) => {
          const percentage = poll.totalVotes > 0 ? Math.round((option.votes / poll.totalVotes) * 100) : 0;
          const isVoted = option.voters && option.voters[currentUser.uid];
          const votedClass = hasVoted ? 'voted' : '';
          const votedStyle = isVoted ? 'border: 2px solid rgba(139,92,246,.9);' : '';
          
          content += `
            <div class="poll-option ${votedClass}" onclick="${hasVoted ? '' : `votePoll('${msgId}', ${index})`}" style="${votedStyle}">
              <div class="poll-progress" style="width:${percentage}%;"></div>
              <div class="poll-option-content">
                <div style="display:flex; align-items:center; gap:8px;">
                  ${isVoted ? '<svg style="width:16px; height:16px; color:#8b5cf6; flex-shrink:0;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' : ''}
                  <span style="font-size:14px;">${escapeHtml(option.text)}</span>
                </div>
                <div class="poll-votes">${percentage}%</div>
              </div>
            </div>
          `;
        });
        
        const votersText = poll.totalVotes === 1 ? '–≥–æ–ª–æ—Å' : poll.totalVotes < 5 ? '–≥–æ–ª–æ—Å–∞' : '–≥–æ–ª–æ—Å–æ–≤';
        content += `
            <div style="font-size:12px; color:rgba(148,163,184,.7); margin-top:8px; text-align:center;">
              ${poll.totalVotes} ${votersText}${poll.anonymous ? ' ‚Ä¢ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –æ–ø—Ä–æ—Å' : ''}
            </div>
          </div>
        `;
      }

      if(msg.text){
        const captionClass = (msg.fileUrl && msg.fileType && (msg.fileType.startsWith('image/') || msg.fileType.startsWith('video/'))) ? 'msg-text media-caption' : 'msg-text';
        content += `<div class="${captionClass}">${escapeHtml(msg.text)}</div>`;
      }

      const reactionsHtml = getReactionsHtml(msgId, msg);
      const editedHtml = msg.edited ? '<span class="edited-indicator">–∏–∑–º.</span>' : '';

      const row = document.createElement('div');
      row.className = `message-row ${isOwn ? 'out' : 'in'} fade-in`;
      row.id = `msg-${msgId}`;

      row.innerHTML = `
        <div class="msg-wrap">
          ${senderLine}
          <div class="bubble ${isOwn ? 'out' : 'in'}" oncontextmenu="showReactions(event,'${msgId}')" onclick="handleMessageTap(event,'${msgId}')">
            ${content}
            <div class="meta">
              ${editedHtml}
              <span class="time">${formatTime(msg.timestamp)}</span>
              ${isOwn ? getReadIcon(msg) : ''}
            </div>
            ${reactionsHtml}
          </div>
        </div>
      `;

      container.appendChild(row);
      const nearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 120;
      if(nearBottom) container.scrollTop = container.scrollHeight;
    }

    function updateMessageUI(msg, msgId){
      const el = document.getElementById(`msg-${msgId}`);
      if(!el) return;

      const bubble = el.querySelector('.bubble');
      if(!bubble) return;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
      const textEl = bubble.querySelector('.msg-text');
      if(textEl && msg.text !== undefined){
        textEl.textContent = msg.text;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–∏–∑–º–µ–Ω–µ–Ω–æ"
      const meta = bubble.querySelector('.meta');
      if(meta){
        let editedEl = meta.querySelector('.edited-indicator');
        if(msg.edited && !editedEl){
          meta.insertAdjacentHTML('afterbegin', '<span class="edited-indicator">–∏–∑–º.</span>');
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ä–æ—Å –µ—Å–ª–∏ –µ—Å—Ç—å
      if(msg.poll){
        const pollContainer = bubble.querySelector('.poll-container');
        if(pollContainer){
          const poll = msg.poll;
          const hasVoted = poll.options.some(opt => opt.voters && opt.voters[currentUser.uid]);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –æ–ø—Ä–æ—Å–∞
          const pollOptions = pollContainer.querySelectorAll('.poll-option');
          poll.options.forEach((option, index) => {
            if(pollOptions[index]){
              const percentage = poll.totalVotes > 0 ? Math.round((option.votes / poll.totalVotes) * 100) : 0;
              const isVoted = option.voters && option.voters[currentUser.uid];
              const progressBar = pollOptions[index].querySelector('.poll-progress');
              const votesEl = pollOptions[index].querySelector('.poll-votes');
              
              if(progressBar) progressBar.style.width = percentage + '%';
              if(votesEl) votesEl.textContent = percentage + '%';
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∏ —Å—Ç–∏–ª—å
              if(hasVoted){
                pollOptions[index].classList.add('voted');
                pollOptions[index].onclick = null;
              }
              if(isVoted){
                pollOptions[index].style.border = '2px solid rgba(139,92,246,.9)';
              }
            }
          });
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤
          const totalVotesEl = pollContainer.querySelector('div[style*="text-align:center"]');
          if(totalVotesEl){
            const votersText = poll.totalVotes === 1 ? '–≥–æ–ª–æ—Å' : poll.totalVotes < 5 ? '–≥–æ–ª–æ—Å–∞' : '–≥–æ–ª–æ—Å–æ–≤';
            totalVotesEl.textContent = `${poll.totalVotes} ${votersText}${poll.anonymous ? ' ‚Ä¢ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –æ–ø—Ä–æ—Å' : ''}`;
          }
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏–∏
      const existing = bubble.querySelector('.flex.flex-wrap');
      const reactionsHtml = getReactionsHtml(msgId, msg);
      if(reactionsHtml){
        if(existing){
          existing.outerHTML = reactionsHtml.trim();
        } else {
          bubble.insertAdjacentHTML('beforeend', reactionsHtml);
        }
      } else {
        if(existing) existing.remove();
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø—Ä–æ—á—Ç–µ–Ω–∏—è
      if(meta && msg.senderId === currentUser.uid){
        const icon = meta.querySelector('svg');
        if(icon) icon.outerHTML = getReadIcon(msg);
        else meta.insertAdjacentHTML('beforeend', getReadIcon(msg));
      }
    }

    // ====== REACTIONS ======
    let lastTap = 0;
    function handleMessageTap(e, msgId){
      const now = Date.now();
      if(now - lastTap < 280){
        showReactions(e, msgId);
      }
      lastTap = now;
    }

    let messageToDelete = null;
    let currentMessageText = '';

    function showMessageContextMenu(e, msgId, isOwn){
      e.preventDefault();
      currentMessageId = msgId;
      const menu = $('messageContextMenu');
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —á–∞—Ç–æ–≤
      $('replyMessageBtn').style.display = 'flex';
      $('forwardMessageBtn').style.display = 'flex';
      $('pinMessageBtn').style.display = 'flex';
      $('saveToFavoritesBtn').style.display = 'flex';
      $('copyMessageBtn').style.display = 'flex';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
      const editBtn = $('editMessageBtn');
      const deleteBtn = $('deleteMessageBtn');
      editBtn.style.display = isOwn ? 'flex' : 'none';
      deleteBtn.style.display = isOwn ? 'flex' : 'none';
      
      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      database.ref(`messages/${currentChat}/${msgId}`).once('value', snap => {
        const msg = snap.val();
        currentMessageText = msg?.text || '';
      });
      
      menu.classList.add('show');

      const rect = e.target.getBoundingClientRect();
      const menuWidth = 200;
      const menuHeight = isOwn ? 280 : 180;
      
      let left = Math.min(rect.left, window.innerWidth - menuWidth - 10);
      left = Math.max(10, left);
      
      let top = rect.top - menuHeight;
      if(top < 10) top = rect.bottom + 10;
      
      menu.style.left = left + 'px';
      menu.style.top = top + 'px';

      setTimeout(() => {
        document.addEventListener('click', hideMessageContextMenu, { once:true });
      }, 0);
    }

    function hideMessageContextMenu(){
      $('messageContextMenu').classList.remove('show');
    }

    async function startEditMessage(){
      hideMessageContextMenu();
      if(!currentMessageId || !currentChat) return;
      
      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
      const snap = await database.ref(`messages/${currentChat}/${currentMessageId}`).once('value');
      const msg = snap.val();
      
      if(!msg || msg.senderId !== currentUser.uid) {
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
      }
      
      $('editMessageText').value = msg.text || '';
      showModal('editMessageModal');
    }

    async function saveEditedMessage(){
      const newText = $('editMessageText').value.trim();
      
      if(!currentMessageId || !currentChat) {
        closeModal('editMessageModal');
        return;
      }
      
      try {
        await database.ref(`messages/${currentChat}/${currentMessageId}`).update({
          text: newText,
          edited: true,
          editedAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        closeModal('editMessageModal');
        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ');
      } catch(err) {
        console.error('Edit message error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
      }
    }

    async function copyMessage(){
      hideMessageContextMenu();
      if(!currentMessageText) {
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        const snap = await database.ref(`messages/${currentChat}/${currentMessageId}`).once('value');
        const msg = snap.val();
        currentMessageText = msg?.text || '';
      }
      
      if(!currentMessageText) {
        showCopyToast('–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        return;
      }
      
      try {
        await navigator.clipboard.writeText(currentMessageText);
        showCopyToast('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
      } catch(err) {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        const textarea = document.createElement('textarea');
        textarea.value = currentMessageText;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showCopyToast('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
      }
    }

    function showCopyToast(text){
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π toast –µ—Å–ª–∏ –µ—Å—Ç—å
      const existing = document.querySelector('.copy-toast');
      if(existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = 'copy-toast';
      toast.innerHTML = `
        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        ${text}
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 2000);
    }

    async function deleteMessage(){
      hideMessageContextMenu();
      if(!currentMessageId || !currentChat) {
        console.warn('Cannot delete: no message or chat selected', {currentMessageId, currentChat});
        return;
      }
      
      console.log('Delete message requested:', currentMessageId, 'in chat:', currentChat);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const snap = await database.ref(`messages/${currentChat}/${currentMessageId}`).once('value');
      const msg = snap.val();
      
      if(!msg) {
        console.warn('Message not found in database:', currentMessageId);
        return;
      }
      
      console.log('Message data:', msg);
      
      // –ü–æ–∑–≤–æ–ª—è–µ–º —É–¥–∞–ª—è—Ç—å —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –µ—Å–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü —á–∞—Ç–∞
      const isOwn = msg.senderId === currentUser.uid;
      const isOwner = currentChatData?.owner === currentUser.uid;
      
      console.log('Permission check:', {isOwn, isOwner, senderId: msg.senderId, currentUserId: currentUser.uid});
      
      if(!isOwn && !isOwner) {
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
      messageToDelete = currentMessageId;
      
      console.log('Showing confirm modal for message:', messageToDelete);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      $('confirmModal').classList.add('show');
    }

    function closeConfirmModal(){
      $('confirmModal').classList.remove('show');
      messageToDelete = null;
    }

    async function confirmDeleteMessage(){
      closeConfirmModal();
      
      if(!messageToDelete || !currentChat) return;
      
      try {
        await database.ref(`messages/${currentChat}/${messageToDelete}`).remove();
        
        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
        const msgEl = document.getElementById(`msg-${messageToDelete}`);
        if(msgEl) msgEl.remove();
        
        showCopyToast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
      } catch(err) {
        console.error('Delete message error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
      }
      
      messageToDelete = null;
    }

    // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    function showReactions(e, msgId){
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–≤–æ—ë –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const msgEl = document.getElementById(`msg-${msgId}`);
      const isOwn = msgEl && msgEl.classList.contains('out');
      showMessageContextMenu(e, msgId, isOwn);
    }

    function hideReactions(){
      hideMessageContextMenu();
    }

    function addReaction(emoji){
      if(!currentMessageId || !currentChat) return;
      database.ref(`messages/${currentChat}/${currentMessageId}/reactions/${emoji}/${currentUser.uid}`).set(true);
      hideReactions();
    }

    function toggleReaction(msgId, emoji){
      database.ref(`messages/${currentChat}/${msgId}/reactions/${emoji}/${currentUser.uid}`).once('value', snap => {
        if(snap.exists()) snap.ref.remove();
        else snap.ref.set(true);
      });
    }

    // ====== TYPING ======
    function handleTyping(){
      if(!currentChat) return;
      database.ref(`typing/${currentChat}/${currentUser.uid}`).set(true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        database.ref(`typing/${currentChat}/${currentUser.uid}`).set(false);
      }, 1800);
    }

    function setupTypingListener(chatId){
      database.ref(`typing/${chatId}`).off();
      database.ref(`typing/${chatId}`).on('value', snap => {
        const map = snap.val() || {};
        const typers = Object.entries(map).filter(([uid, val]) => uid !== currentUser.uid && val);
        if(typers.length){
          $('typingText').textContent = currentChatType === 'private' ? '–ø–µ—á–∞—Ç–∞–µ—Ç...' : '–ø–µ—á–∞—Ç–∞—é—Ç...';
          $('typingIndicator').classList.remove('hidden');
        } else {
          $('typingIndicator').classList.add('hidden');
        }
      });
    }

    // ====== READ ======
    function markAsRead(chatId){
      database.ref(`messages/${chatId}`).once('value', snap => {
        const msgs = snap.val() || {};
        for(const [msgId, msg] of Object.entries(msgs)){
          if(msg.senderId !== currentUser.uid){
            database.ref(`messages/${chatId}/${msgId}/readBy/${currentUser.uid}`).set(true);
          }
        }
      });
      
      // –°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
      unreadCounts[chatId] = 0;
      
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ allChats
      const chatIndex = allChats.findIndex(c => c.id === chatId);
      if(chatIndex !== -1){
        allChats[chatIndex].unread = 0;
      }
      
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –±–µ–π–¥–∂
      renderChatList();
    }

    // ====== FILES ======
    function handleFileSelect(event){
      const file = event.target.files?.[0];
      if(!file) return;

      const maxSize = 10 * 1024 * 1024; // 10MB –¥–ª—è Firebase Database
      if(file.size > maxSize){
        showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞', '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10MB)');
        event.target.value = '';
        return;
      }

      pendingFile = file;
      $('uploadPreview').classList.remove('hidden');

      const previewImage = $('uploadPreviewImage');
      const previewFile = $('uploadPreviewFile');

      if(file.type.startsWith('image/')){
        previewImage.classList.remove('hidden');
        previewFile.classList.add('hidden');
        previewImage.src = URL.createObjectURL(file);
      } else {
        previewImage.classList.add('hidden');
        previewFile.classList.remove('hidden');
        previewFile.style.display = 'flex';
        $('uploadFileName').textContent = file.name;
      }

      event.target.value = '';
    }

    function cancelUpload(){
      if(uploadTask){
        try{ uploadTask.cancel(); }catch(e){}
        uploadTask = null;
      }
      isUploading = false;
      pendingFile = null;
      $('uploadPreview').classList.add('hidden');
      $('uploadProgress').classList.add('hidden');
      $('uploadProgressBar').style.width = '0%';
      $('imageCaption').value = '';

      const img = $('uploadPreviewImage');
      if(img && img.src && img.src.startsWith('blob:')){
        try{ URL.revokeObjectURL(img.src); }catch(e){}
      }
    }

    async function uploadImageToImgBB(file){
      return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('key', IMGBB_API_KEY);

        $('uploadProgress').classList.remove('hidden');
        $('uploadProgressBar').style.width = '0%';

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://api.imgbb.com/1/upload');

        xhr.upload.onprogress = (e) => {
          if(e.lengthComputable){
            const p = (e.loaded / e.total) * 100;
            $('uploadProgressBar').style.width = p + '%';
          }
        };

        xhr.onload = () => {
          try{
            const data = JSON.parse(xhr.responseText);
            if(xhr.status === 200 && data.success){
              resolve(data.data.url);
            } else {
              reject(new Error(data?.error?.message || 'imgBB upload failed'));
            }
          } catch(err){
            reject(new Error('Failed to parse imgBB response'));
          }
        };

        xhr.onerror = () => reject(new Error('Network error'));
        xhr.send(formData);
      });
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –≤ base64 –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase Database
    async function uploadFileAsBase64(file){
      return new Promise((resolve, reject) => {
        $('uploadProgress').classList.remove('hidden');
        $('uploadProgressBar').style.width = '0%';

        const reader = new FileReader();
        
        reader.onprogress = (e) => {
          if(e.lengthComputable){
            const p = (e.loaded / e.total) * 50; // 50% –Ω–∞ —á—Ç–µ–Ω–∏–µ
            $('uploadProgressBar').style.width = p + '%';
          }
        };

        reader.onload = async () => {
          try {
            $('uploadProgressBar').style.width = '60%';
            
            const base64 = reader.result;
            const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase Database
            const fileData = {
              data: base64,
              name: file.name,
              type: file.type,
              size: file.size,
              uploadedBy: currentUser.uid,
              uploadedAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            $('uploadProgressBar').style.width = '80%';
            
            await database.ref(`files/${fileId}`).set(fileData);
            
            $('uploadProgressBar').style.width = '100%';
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π URL —Å ID —Ñ–∞–π–ª–∞
            resolve(`firebase-file://${fileId}`);
          } catch(err) {
            reject(err);
          }
        };

        reader.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'));
        reader.readAsDataURL(file);
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ Firebase Storage
    async function uploadFileToFirebase(file){
      return new Promise((resolve, reject) => {
        const fileName = `${Date.now()}_${String(file.name).replace(/[^a-zA-Z0-9._-]/g, '_')}`;
        const filePath = `uploads/${currentUser.uid}/${fileName}`;
        const ref = storage.ref(filePath);

        const metadata = {
          contentType: file.type,
          customMetadata: { uploadedBy: currentUser.uid, originalName: file.name }
        };

        $('uploadProgress').classList.remove('hidden');
        $('uploadProgressBar').style.width = '0%';

        uploadTask = ref.put(file, metadata);
        uploadTask.on('state_changed',
          s => {
            const p = (s.bytesTransferred / s.totalBytes) * 100;
            $('uploadProgressBar').style.width = p + '%';
          },
          err => reject(err),
          async () => {
            try{
              const url = await uploadTask.snapshot.ref.getDownloadURL();
              resolve(url);
            } catch(e){ reject(e); }
          }
        );
      });
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
    async function uploadFile(file){
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (10MB –¥–ª—è base64 –≤ Firebase Database)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if(file.size > maxSize){
        throw new Error('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 10MB)');
      }

      // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ 10MB –∑–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ imgBB
      if(file.type.startsWith('image/')){
        try {
          return await uploadImageToImgBB(file);
        } catch(err) {
          console.warn('imgBB failed, using Firebase Database:', err);
          // –ï—Å–ª–∏ imgBB –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase Database
          return await uploadFileAsBase64(file);
        }
      }
      
      // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase Database –∫–∞–∫ base64
      return await uploadFileAsBase64(file);
    }

    async function sendFileWithCaption(){
      if(!pendingFile || !currentChat) return;
      if(isUploading) return showToast('‚è≥','–ü–æ–¥–æ–∂–¥–∏—Ç–µ','–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...');

      isUploading = true;
      const caption = $('imageCaption').value.trim();

      let messageData = {
        senderId: currentUser.uid,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        readBy: { [currentUser.uid]: true }
      };
      if(caption) messageData.text = caption;

      try{
        showToast('‚è≥','–ó–∞–≥—Ä—É–∑–∫–∞','–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª...');
        const url = await uploadFile(pendingFile);
        
        messageData.fileUrl = url;
        messageData.fileName = pendingFile.name;
        messageData.fileType = pendingFile.type;

        await database.ref(`messages/${currentChat}`).push(messageData);
        await touchChatUpdatedAt(currentChat);

        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      } catch(err){
        console.error('Upload error:', err);
        const errorMsg = err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª';
        showToast('‚ùå','–û—à–∏–±–∫–∞', errorMsg);
      } finally {
        isUploading = false;
        cancelUpload();
      }
    }

    async function touchChatUpdatedAt(chatId){
      await database.ref(`userChats/${currentUser.uid}/${chatId}/updatedAt`).set(firebase.database.ServerValue.TIMESTAMP);
      if(currentChatType === 'private'){
        const chatData = allChats.find(c => c.id === chatId);
        if(chatData) await database.ref(`userChats/${chatData.oderId}/${chatId}/updatedAt`).set(firebase.database.ServerValue.TIMESTAMP);
      } else if(currentChatData?.members){
        const ids = Object.keys(currentChatData.members);
        await Promise.all(ids.filter(uid => uid !== currentUser.uid).map(uid => database.ref(`userChats/${uid}/${chatId}/updatedAt`).set(firebase.database.ServerValue.TIMESTAMP)));
      }
    }

    // ====== SEND MESSAGE ======
    async function sendMessage(e){
      e.preventDefault();
      if(isUploading) return showToast('‚è≥','–ü–æ–¥–æ–∂–¥–∏—Ç–µ','–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...');
      if(pendingFile) return sendFileWithCaption();

      const input = $('messageInput');
      const text = input.value.trim();
      if(!text || !currentChat) return;

      input.value = '';

      if(typingTimeout){
        clearTimeout(typingTimeout);
        database.ref(`typing/${currentChat}/${currentUser.uid}`).set(false);
      }

      const messageData = {
        senderId: currentUser.uid,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        readBy: { [currentUser.uid]: true },
        text
      };

      await database.ref(`messages/${currentChat}`).push(messageData);
      await touchChatUpdatedAt(currentChat);
      closeEmoji();
    }

    // ====== IMAGE VIEWER ======
    function viewImage(url){
      $('viewerImage').src = url;
      $('imageViewer').classList.add('show');
    }
    function closeImageViewer(){
      $('imageViewer').classList.remove('show');
      $('viewerImage').src = '';
    }

    // ====== FIREBASE FILE FUNCTIONS ======
    async function loadFirebaseFile(fileId, msgId){
      try {
        const snap = await database.ref(`files/${fileId}`).once('value');
        const fileData = snap.val();
        
        if(fileData && fileData.data){
          // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å data-file-id
          const elements = document.querySelectorAll(`[data-file-id="${fileId}"]`);
          elements.forEach(el => {
            if(el.tagName === 'IMG'){
              el.src = fileData.data;
            } else if(el.tagName === 'VIDEO'){
              el.src = fileData.data;
            } else if(el.tagName === 'AUDIO'){
              el.src = fileData.data;
            }
          });
        }
      } catch(err){
        console.error('Error loading file:', err);
      }
    }

    async function viewFirebaseFile(fileId){
      try {
        const snap = await database.ref(`files/${fileId}`).once('value');
        const fileData = snap.val();
        
        if(fileData && fileData.data){
          viewImage(fileData.data);
        }
      } catch(err){
        console.error('Error viewing file:', err);
        showToast('‚ùå','–û—à–∏–±–∫–∞','–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
      }
    }

    async function downloadFirebaseFile(fileId, fileName){
      try {
        const snap = await database.ref(`files/${fileId}`).once('value');
        const fileData = snap.val();
        
        if(fileData && fileData.data){
          // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
          const link = document.createElement('a');
          link.href = fileData.data;
          link.download = fileName;
          link.click();
        }
      } catch(err){
        console.error('Error downloading file:', err);
        showToast('‚ùå','–û—à–∏–±–∫–∞','–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª');
      }
    }

    // ====== PLAYBACK FUNCTIONS ======
    function playVideoMessage(msgId) {
      const video = document.getElementById(`video-${msgId}`);
      if (!video) return;
      
      if (video.paused) {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –≤–∏–¥–µ–æ
        document.querySelectorAll('video').forEach(v => {
          if (v.id !== `video-${msgId}`) v.pause();
        });
        video.play();
        video.muted = false;
      } else {
        video.pause();
      }
    }

    let currentAudio = null;
    let currentAudioId = null;

    async function toggleAudioPlayback(msgId, fileId) {
      const audioEl = document.getElementById(`audio-${msgId}`);
      const playerEl = document.getElementById(`audio-player-${msgId}`);
      const playBtn = playerEl.querySelector('.audio-play-btn');
      const playIcon = playBtn.querySelector('.play-icon');
      const pauseIcon = playBtn.querySelector('.pause-icon');
      
      if (!audioEl) return;
      
      // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–æ–µ –∞—É–¥–∏–æ, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
      if (!audioEl.src) {
        try {
          const snap = await database.ref(`files/${fileId}`).once('value');
          const fileData = snap.val();
          if (fileData && fileData.data) {
            audioEl.src = fileData.data;
          }
        } catch (err) {
          console.error('Error loading audio:', err);
          showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ');
          return;
        }
      }
      
      // –ï—Å–ª–∏ –∏–≥—Ä–∞–µ—Ç –¥—Ä—É–≥–æ–µ –∞—É–¥–∏–æ, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
      if (currentAudio && currentAudioId !== msgId) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        const prevPlayer = document.getElementById(`audio-player-${currentAudioId}`);
        if (prevPlayer) {
          prevPlayer.classList.remove('playing');
          const prevPlayBtn = prevPlayer.querySelector('.audio-play-btn');
          prevPlayBtn.querySelector('.play-icon').classList.remove('hidden');
          prevPlayBtn.querySelector('.pause-icon').classList.add('hidden');
        }
      }
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
      if (audioEl.paused) {
        audioEl.play();
        playerEl.classList.add('playing');
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
        currentAudio = audioEl;
        currentAudioId = msgId;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
        audioEl.ontimeupdate = () => {
          const timeEl = playerEl.querySelector('.audio-time');
          const remaining = Math.ceil(audioEl.duration - audioEl.currentTime);
          const minutes = Math.floor(remaining / 60);
          const seconds = remaining % 60;
          timeEl.textContent = `-${minutes}:${seconds.toString().padStart(2, '0')}`;
        };
        
        // –ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å
        audioEl.onended = () => {
          playerEl.classList.remove('playing');
          playIcon.classList.remove('hidden');
          pauseIcon.classList.add('hidden');
          audioEl.currentTime = 0;
          const timeEl = playerEl.querySelector('.audio-time');
          const duration = Math.ceil(audioEl.duration);
          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          timeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        };
      } else {
        audioEl.pause();
        playerEl.classList.remove('playing');
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
      }
    }

    // ====== FILE PICKER MENU ======
    function openFilePicker(){
      const wrap = document.createElement('div');
      wrap.id = 'filePickerModal';
      wrap.className = 'modal show';
      wrap.onclick = (e) => { if(e.target && e.target.id === 'filePickerModal') wrap.remove(); };

      wrap.innerHTML = `
        <div class="sheet bottom p-4">
          <h3 class="text-lg font-bold mb-4 text-center">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å</h3>
          <div class="space-y-2">
            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="selectFileType('photo')">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#3b82f6,#22d3ee)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–§–æ—Ç–æ –∏–ª–∏ –í–∏–¥–µ–æ</div>
                <div class="text-xs text-slate-400">–§–æ—Ç–æ —á–µ—Ä–µ–∑ imgBB, —Ñ–∞–π–ª—ã –≤ Firebase (–¥–æ 10MB)</div>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="selectFileType('camera')">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#22c55e,#34d399)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–ö–∞–º–µ—Ä–∞</div>
                <div class="text-xs text-slate-400">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</div>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="selectFileType('document')">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#fb923c,#fbbf24)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–î–æ–∫—É–º–µ–Ω—Ç</div>
                <div class="text-xs text-slate-400">PDF, Word, Excel</div>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="startVideoMessage()">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#06b6d4,#3b82f6)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–ö—Ä—É–∂–æ–∫</div>
                <div class="text-xs text-slate-400">–í–∏–¥–µ–æ-—Å–æ–æ–±—â–µ–Ω–∏–µ</div>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="startVoiceMessage()">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#ef4444,#f97316)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–ì–æ–ª–æ—Å–æ–≤–æ–µ</div>
                <div class="text-xs text-slate-400">–ó–∞–ø–∏—Å–∞—Ç—å –∞—É–¥–∏–æ</div>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="showCreatePoll()">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#a855f7,#ec4899)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–û–ø—Ä–æ—Å</div>
                <div class="text-xs text-slate-400">–°–æ–∑–¥–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</div>
              </div>
            </button>
          </div>
          <button class="w-full mt-4 py-2 text-slate-400 hover:text-white" onclick="document.getElementById('filePickerModal')?.remove()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `;

      document.body.appendChild(wrap);
    }

    function selectFileType(type){
      const input = $('fileInput');
      if(type === 'camera'){
        input.accept = 'image/*';
        input.capture = 'environment';
      } else if(type === 'photo'){
        input.accept = 'image/*,video/*';
        input.removeAttribute('capture');
      } else {
        input.accept = '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar';
        input.removeAttribute('capture');
      }
      input.click();
      document.getElementById('filePickerModal')?.remove();
    }

    // ====== POLLS ======
    function showCreatePoll() {
      document.getElementById('filePickerModal')?.remove();
      $('pollQuestion').value = '';
      const optionsContainer = $('pollOptions');
      optionsContainer.innerHTML = `
        <input class="poll-option-input w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 outline-none focus:border-violet-500" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1">
        <input class="poll-option-input w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 outline-none focus:border-violet-500" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2">
      `;
      $('pollAnonymous').checked = false;
      showModal('createPollModal');
    }

    function addPollOption() {
      const optionsContainer = $('pollOptions');
      const currentOptions = optionsContainer.querySelectorAll('.poll-option-input');
      if (currentOptions.length >= 10) {
        showToast('‚ö†Ô∏è', '–õ–∏–º–∏—Ç', '–ú–∞–∫—Å–∏–º—É–º 10 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤');
        return;
      }
      const newOption = document.createElement('input');
      newOption.className = 'poll-option-input w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 outline-none focus:border-violet-500';
      newOption.placeholder = `–í–∞—Ä–∏–∞–Ω—Ç ${currentOptions.length + 1}`;
      optionsContainer.appendChild(newOption);
    }

    async function sendPoll() {
      const question = $('pollQuestion').value.trim();
      const optionInputs = document.querySelectorAll('.poll-option-input');
      const options = Array.from(optionInputs)
        .map(input => input.value.trim())
        .filter(val => val.length > 0);
      const anonymous = $('pollAnonymous').checked;

      if (!question) {
        showToast('‚ö†Ô∏è', '–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –æ–ø—Ä–æ—Å–∞');
        return;
      }

      if (options.length < 2) {
        showToast('‚ö†Ô∏è', '–û—à–∏–±–∫–∞', '–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞');
        return;
      }

      if (!currentChat) return;

      try {
        const pollData = {
          senderId: currentUser.uid,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          readBy: { [currentUser.uid]: true },
          poll: {
            question,
            options: options.map(opt => ({ text: opt, votes: 0, voters: {} })),
            anonymous,
            totalVotes: 0
          }
        };

        await database.ref(`messages/${currentChat}`).push(pollData);
        await touchChatUpdatedAt(currentChat);

        closeModal('createPollModal');
        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–û–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      } catch (err) {
        console.error('Send poll error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–ø—Ä–æ—Å');
      }
    }

    async function votePoll(msgId, optionIndex) {
      if (!currentChat) return;

      try {
        const snap = await database.ref(`messages/${currentChat}/${msgId}`).once('value');
        const msg = snap.val();
        if (!msg || !msg.poll) return;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let hasVoted = false;
        let previousVote = -1;
        msg.poll.options.forEach((opt, idx) => {
          if (opt.voters && opt.voters[currentUser.uid]) {
            hasVoted = true;
            previousVote = idx;
          }
        });

        // –ï—Å–ª–∏ —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª –∑–∞ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        if (previousVote === optionIndex) return;

        // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥–æ–ª–æ—Å
        if (hasVoted) {
          await database.ref(`messages/${currentChat}/${msgId}/poll/options/${previousVote}/voters/${currentUser.uid}`).remove();
          await database.ref(`messages/${currentChat}/${msgId}/poll/options/${previousVote}/votes`).transaction(votes => (votes || 1) - 1);
        } else {
          // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤
          await database.ref(`messages/${currentChat}/${msgId}/poll/totalVotes`).transaction(total => (total || 0) + 1);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –≥–æ–ª–æ—Å
        await database.ref(`messages/${currentChat}/${msgId}/poll/options/${optionIndex}/voters/${currentUser.uid}`).set(true);
        await database.ref(`messages/${currentChat}/${msgId}/poll/options/${optionIndex}/votes`).transaction(votes => (votes || 0) + 1);

        showToast('‚úÖ', '–ì–æ—Ç–æ–≤–æ', '–í–∞—à –≥–æ–ª–æ—Å —É—á—Ç–µ–Ω');
      } catch (err) {
        console.error('Vote poll error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å');
      }
    }

    // ====== VIDEO MESSAGE (–ö–†–£–ñ–û–ö) ======
    let videoStream = null;
    let videoRecorder = null;
    let videoChunks = [];
    let videoRecordingInterval = null;
    let videoRecordingStartTime = 0;

    async function startVideoMessage() {
      document.getElementById('filePickerModal')?.remove();
      
      console.log('Starting video message...');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É API
      if (!mediaSupported) {
        console.error('Media API not supported');
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ');
        return;
      }
      
      console.log('Opening modal...');
      // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      showModal('videoMessageModal');
      
      try {
        console.log('Requesting camera access...');
        // –ó–∞—Ç–µ–º –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 640 },
            height: { ideal: 640 },
            facingMode: 'user'
          }, 
          audio: true 
        });
        
        console.log('Camera access granted, setting up preview...');
        const videoPreview = $('videoPreview');
        if (videoPreview) {
          videoPreview.srcObject = videoStream;
          await videoPreview.play();
          console.log('Video preview started');
        } else {
          console.error('Video preview element not found');
        }
      } catch (err) {
        console.error('Video access error:', err);
        closeModal('videoMessageModal');
        
        let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ';
        let errorDetails = '';
        
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
          errorMsg = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â—ë–Ω';
          errorDetails = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–∏–∫–æ–Ω–∫–∞ –∑–∞–º–∫–∞ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ)\n2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã (Windows: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Üí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å ‚Üí –ö–∞–º–µ—Ä–∞)\n3. –ê–Ω—Ç–∏–≤–∏—Ä—É—Å –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–∞–º–µ—Ä—É';
        } else if (err.name === 'NotFoundError') {
          errorMsg = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
          errorDetails = '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–∞–º–µ—Ä—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥—Ä–∞–π–≤–µ—Ä—ã';
        } else if (err.name === 'NotReadableError') {
          errorMsg = '–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
          errorDetails = '–ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É (Zoom, Skype –∏ —Ç.–¥.)';
        } else if (err.name === 'OverconstrainedError') {
          errorMsg = '–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã';
          errorDetails = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞–º–µ—Ä—É';
        }
        
        alert(`${errorMsg}\n\n${errorDetails}`);
        showToast('‚ùå', '–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã', errorMsg);
      }
    }

    function toggleVideoRecording() {
      if (!videoRecorder || videoRecorder.state === 'inactive') {
        startVideoRecording();
      } else {
        stopVideoRecording();
      }
    }

    function startVideoRecording() {
      if (!videoStream) {
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
        return;
      }
      
      videoChunks = [];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ñ–æ—Ä–º–∞—Ç–æ–≤
      let mimeType = 'video/webm';
      if (!MediaRecorder.isTypeSupported('video/webm')) {
        if (MediaRecorder.isTypeSupported('video/mp4')) {
          mimeType = 'video/mp4';
        } else {
          mimeType = '';
        }
      }
      
      try {
        videoRecorder = mimeType 
          ? new MediaRecorder(videoStream, { mimeType }) 
          : new MediaRecorder(videoStream);
        
        videoRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) videoChunks.push(e.data);
        };
        
        videoRecorder.onstop = () => {
          const blob = new Blob(videoChunks, { type: mimeType || 'video/webm' });
          videoChunks = [];
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
          $('videoRecordBtn').classList.add('hidden');
          $('videoSendBtn').classList.remove('hidden');
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º blob –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
          window.pendingVideoBlob = blob;
        };
        
        videoRecorder.start();
        videoRecordingStartTime = Date.now();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
        $('videoRecordingIndicator').classList.remove('hidden');
        $('videoRecordBtn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><rect x="6" y="6" width="8" height="8" rx="1"/></svg> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
      } catch (err) {
        console.error('Start recording error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å');
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
      videoRecordingInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - videoRecordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        $('videoRecordingTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥
        if (elapsed >= 60) {
          stopVideoRecording();
        }
      }, 1000);
    }

    function stopVideoRecording() {
      if (videoRecorder && videoRecorder.state === 'recording') {
        videoRecorder.stop();
        clearInterval(videoRecordingInterval);
      }
    }

    async function sendVideoMessage() {
      if (!window.pendingVideoBlob || !currentChat) return;
      
      try {
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º blob –≤ base64
        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64data = reader.result;
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase Database
          const fileId = database.ref().push().key;
          await database.ref(`files/${fileId}`).set({
            data: base64data,
            type: 'video/webm',
            uploadedBy: currentUser.uid,
            uploadedAt: firebase.database.ServerValue.TIMESTAMP
          });
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          const msgData = {
            senderId: currentUser.uid,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            readBy: { [currentUser.uid]: true },
            fileUrl: `firebase-file://${fileId}`,
            fileType: 'video/webm',
            fileName: 'video-message.webm',
            isVideoMessage: true
          };
          
          await database.ref(`messages/${currentChat}`).push(msgData);
          await touchChatUpdatedAt(currentChat);
          
          stopVideoMessage();
          showToast('‚úÖ', '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', '–ö—Ä—É–∂–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        };
        
        reader.readAsDataURL(window.pendingVideoBlob);
      } catch (err) {
        console.error('Send video message error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—Ä—É–∂–æ–∫');
      }
    }

    function stopVideoMessage() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      if (videoRecordingInterval) {
        clearInterval(videoRecordingInterval);
        videoRecordingInterval = null;
      }
      videoRecorder = null;
      videoChunks = [];
      window.pendingVideoBlob = null;
      
      $('videoRecordingIndicator').classList.add('hidden');
      $('videoRecordingTime').textContent = '0:00';
      $('videoRecordBtn').classList.remove('hidden');
      $('videoRecordBtn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8"/></svg> –ó–∞–ø–∏—Å–∞—Ç—å';
      $('videoSendBtn').classList.add('hidden');
      
      closeModal('videoMessageModal');
    }

    // ====== VOICE MESSAGE ======
    let audioStream = null;
    let audioRecorder = null;
    let audioChunks = [];
    let audioRecordingInterval = null;
    let audioRecordingStartTime = 0;

    async function startVoiceMessage() {
      document.getElementById('filePickerModal')?.remove();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É API
      if (!mediaSupported) {
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ');
        return;
      }
      
      // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      showModal('voiceMessageModal');
      
      try {
        // –ó–∞—Ç–µ–º –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (err) {
        console.error('Audio access error:', err);
        closeModal('voiceMessageModal');
        
        let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
        let errorDetails = '';
        
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
          errorMsg = '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω';
          errorDetails = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–∏–∫–æ–Ω–∫–∞ –∑–∞–º–∫–∞ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ)\n2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã (Windows: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Üí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω)\n3. –ê–Ω—Ç–∏–≤–∏—Ä—É—Å –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω';
        } else if (err.name === 'NotFoundError') {
          errorMsg = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
          errorDetails = '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥—Ä–∞–π–≤–µ—Ä—ã';
        } else if (err.name === 'NotReadableError') {
          errorMsg = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
          errorDetails = '–ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω (Zoom, Skype –∏ —Ç.–¥.)';
        } else if (err.name === 'OverconstrainedError') {
          errorMsg = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã';
          errorDetails = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –º–∏–∫—Ä–æ—Ñ–æ–Ω';
        }
        
        alert(`${errorMsg}\n\n${errorDetails}`);
        showToast('‚ùå', '–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞', errorMsg);
      }
    }

    function toggleVoiceRecording() {
      if (!audioRecorder || audioRecorder.state === 'inactive') {
        startVoiceRecording();
      } else {
        stopVoiceRecording();
      }
    }

    function startVoiceRecording() {
      if (!audioStream) {
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        return;
      }
      
      audioChunks = [];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ñ–æ—Ä–º–∞—Ç–æ–≤
      let mimeType = 'audio/webm';
      if (!MediaRecorder.isTypeSupported('audio/webm')) {
        if (MediaRecorder.isTypeSupported('audio/mp4')) {
          mimeType = 'audio/mp4';
        } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
          mimeType = 'audio/ogg';
        } else {
          mimeType = '';
        }
      }
      
      try {
        audioRecorder = mimeType 
          ? new MediaRecorder(audioStream, { mimeType }) 
          : new MediaRecorder(audioStream);
        
        audioRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) audioChunks.push(e.data);
        };
        
        audioRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: mimeType || 'audio/webm' });
          audioChunks = [];
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
          $('voiceRecordBtn').classList.add('hidden');
          $('voiceSendBtn').classList.remove('hidden');
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º blob –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
          window.pendingAudioBlob = blob;
        };
      } catch (err) {
        console.error('Start recording error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å');
        return;
      }
      
      audioRecorder.start();
      audioRecordingStartTime = Date.now();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ª–Ω—ã
      $('voiceWaveform').classList.remove('hidden');
      $('voiceMicIcon').style.opacity = '0.5';
      $('voiceRecordBtn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><rect x="6" y="6" width="8" height="8" rx="1"/></svg> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
      audioRecordingInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - audioRecordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        $('voiceRecordingTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç
        if (elapsed >= 300) {
          stopVoiceRecording();
        }
      }, 1000);
    }

    function stopVoiceRecording() {
      if (audioRecorder && audioRecorder.state === 'recording') {
        audioRecorder.stop();
        clearInterval(audioRecordingInterval);
        $('voiceWaveform').classList.add('hidden');
        $('voiceMicIcon').style.opacity = '1';
      }
    }

    async function sendVoiceMessage() {
      if (!window.pendingAudioBlob || !currentChat) return;
      
      try {
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º blob –≤ base64
        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64data = reader.result;
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase Database
          const fileId = database.ref().push().key;
          await database.ref(`files/${fileId}`).set({
            data: base64data,
            type: 'audio/webm',
            uploadedBy: currentUser.uid,
            uploadedAt: firebase.database.ServerValue.TIMESTAMP
          });
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          const msgData = {
            senderId: currentUser.uid,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            readBy: { [currentUser.uid]: true },
            fileUrl: `firebase-file://${fileId}`,
            fileType: 'audio/webm',
            fileName: 'voice-message.webm',
            isVoiceMessage: true,
            duration: Math.floor((Date.now() - audioRecordingStartTime) / 1000)
          };
          
          await database.ref(`messages/${currentChat}`).push(msgData);
          await touchChatUpdatedAt(currentChat);
          
          stopVoiceMessageModal();
          showToast('‚úÖ', '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
        };
        
        reader.readAsDataURL(window.pendingAudioBlob);
      } catch (err) {
        console.error('Send voice message error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ');
      }
    }

    function stopVoiceMessageModal() {
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
      }
      if (audioRecordingInterval) {
        clearInterval(audioRecordingInterval);
        audioRecordingInterval = null;
      }
      audioRecorder = null;
      audioChunks = [];
      window.pendingAudioBlob = null;
      
      $('voiceRecordingTime').textContent = '0:00';
      $('voiceWaveform').classList.add('hidden');
      $('voiceMicIcon').style.opacity = '1';
      $('voiceRecordBtn').classList.remove('hidden');
      $('voiceRecordBtn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8"/></svg> –ó–∞–ø–∏—Å–∞—Ç—å';
      $('voiceSendBtn').classList.add('hidden');
      
      closeModal('voiceMessageModal');
    }

    // ====== EMOJI PICKER ======
    let currentEmojiCategory = 'smileys';

    function toggleEmoji(){
      const picker = $('emojiPicker');
      const willShow = !picker.classList.contains('show');
      picker.classList.toggle('show');
      if(willShow){
        renderEmojiCategory(currentEmojiCategory);
      }
    }

    function closeEmoji(){
      $('emojiPicker').classList.remove('show');
    }

    function showEmojiCategory(cat){
      currentEmojiCategory = cat;
      ['smileys','gestures','animals','food','activities','travel','objects','symbols'].forEach(k => {
        const btn = $('emojiTab' + k.charAt(0).toUpperCase() + k.slice(1));
        btn.classList.toggle('active', k === cat);
      });
      renderEmojiCategory(cat);
    }

    function renderEmojiCategory(cat){
      const grid = $('emojiGrid');
      const list = EMOJI[cat] || [];
      grid.innerHTML = list.map(e => `<button type="button" class="emoji-btn" onclick="addEmoji('${e.replace(/'/g, "\\'")}')">${e}</button>`).join('');
    }

    function addEmoji(emoji){
      const input = $('messageInput');
      const currentValue = input.value;
      const cursorPos = input.selectionStart;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª –ø–µ—Ä–µ–¥ —ç–º–æ–¥–∑–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      const needSpaceBefore = currentValue.length > 0 && 
                             cursorPos > 0 && 
                             currentValue[cursorPos - 1] !== ' ';
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª –ø–æ—Å–ª–µ —ç–º–æ–¥–∑–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ  
      const needSpaceAfter = cursorPos < currentValue.length && 
                            currentValue[cursorPos] !== ' ';
      
      const textToInsert = (needSpaceBefore ? ' ' : '') + emoji + (needSpaceAfter ? ' ' : '');
      
      const newValue = currentValue.slice(0, cursorPos) + textToInsert + currentValue.slice(cursorPos);
      input.value = newValue;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
      const newCursorPos = cursorPos + textToInsert.length;
      input.setSelectionRange(newCursorPos, newCursorPos);
      input.focus();
    }

    // ====== NOTIFICATIONS ======
    function requestNotificationPermission() {
      if ('Notification' in window) {
        if (Notification.permission === 'default') {
          Notification.requestPermission().then(permission => {
            console.log('Notification permission:', permission);
          });
        }
      }
    }

    function setupNotificationListener(){
      database.ref(`userChats/${currentUser.uid}`).off('child_changed');
      database.ref(`userChats/${currentUser.uid}`).on('child_changed', async snap => {
        const chatId = snap.key;
        if(chatId === currentChat && document.visibilityState === 'visible') return;

        const msgSnap = await database.ref(`messages/${chatId}`).orderByChild('timestamp').limitToLast(1).once('value');
        const msgs = msgSnap.val();
        if(!msgs) return;

        const lastMsg = Object.values(msgs)[0];
        if(lastMsg.senderId === currentUser.uid) return;

        const senderName = allUsers[lastMsg.senderId]?.name || '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
        const msgText = lastMsg.text || (lastMsg.fileUrl ? 'üìé –§–∞–π–ª' : '');

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        playNotificationSound();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (toast)
        showToast(senderName.charAt(0).toUpperCase(), senderName, msgText, chatId);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
        if(Notification.permission === 'granted' && document.visibilityState !== 'visible'){
          try {
            const notification = new Notification(senderName, { 
              body: msgText,
              icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23667eea"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>',
              tag: chatId, // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —á–∞—Ç—É
              renotify: true,
              silent: true // –ú—ã –∏–≥—Ä–∞–µ–º —Å–≤–æ–π –∑–≤—É–∫
            });
            
            // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
            notification.onclick = () => {
              window.focus();
              const chat = allChats.find(c => c.id === chatId);
              if(chat) openChat(chatId, chat.type);
              notification.close();
            };
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => notification.close(), 5000);
          } catch(e) {
            console.warn('Notification error:', e);
          }
        }
      });
    }

    // ====== CREATE / USERS ======
    function showCreateMenu(){ showModal('createMenuModal'); }

    function showNewPrivateChat(){
      closeModal('createMenuModal');
      $('userSearchInput').value = '';
      $('userSearchResults').innerHTML = '';
      renderUsersForChat();
      showModal('newPrivateChatModal');
    }

    function renderUsersForChat(){
      const container = $('userSearchResults');
      const users = Object.entries(allUsers).filter(([uid]) => uid !== currentUser.uid);
      const unique = new Map(users);
      const arr = Array.from(unique.entries());

      if(!arr.length){
        container.innerHTML = '<div class="p-4 text-center text-slate-500">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
        return;
      }

      container.innerHTML = arr.map(([uid, user]) => `
        <div class="flex items-center gap-3 p-3 hover:bg-white/5 cursor-pointer rounded-xl" onclick="startPrivateChat('${uid}')" data-uid="${uid}">
          <div class="w-10 h-10 rounded-full gradient-bg grid place-items-center font-bold">${escapeHtml((user?.name || '?').charAt(0).toUpperCase())}</div>
          <div class="min-w-0">
            <div class="font-medium truncate">${getNameWithBadge(user?.name || 'Unknown', user?.email)}</div>
            <div class="text-xs text-slate-400">${user?.online ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}</div>
          </div>
        </div>
      `).join('');
    }

    function searchUsersForChat(){
      const q = $('userSearchInput').value.toLowerCase();
      document.querySelectorAll('#userSearchResults [data-uid]').forEach(item => {
        const name = item.querySelector('.font-medium')?.textContent.toLowerCase() || '';
        item.style.display = name.includes(q) ? '' : 'none';
      });
    }

    async function startPrivateChat(otherUserId){
      closeModal('newPrivateChatModal');
      const chatId = currentUser.uid < otherUserId ? `${currentUser.uid}_${otherUserId}` : `${otherUserId}_${currentUser.uid}`;

      await database.ref(`userChats/${currentUser.uid}/${chatId}`).set({
        type: 'private',
        oderId: otherUserId,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
      await database.ref(`userChats/${otherUserId}/${chatId}`).set({
        type: 'private',
        oderId: currentUser.uid,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });

      setTimeout(() => openChat(chatId, 'private'), 150);
    }

    function showCreateGroup(){
      closeModal('createMenuModal');
      $('groupName').value = '';
      $('groupSearchInput').value = '';
      selectedGroupMembers = [];
      renderSelectedMembers();
      renderUsersForGroup();
      showModal('createGroupModal');
    }

    function renderUsersForGroup(){
      const container = $('groupSearchResults');
      const users = Object.entries(allUsers).filter(([uid]) => uid !== currentUser.uid);
      const unique = new Map(users);
      const arr = Array.from(unique.entries());

      if(!arr.length){
        container.innerHTML = '<div class="p-4 text-center text-slate-500">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
        return;
      }

      container.innerHTML = arr.map(([uid, user]) => {
        const selected = selectedGroupMembers.includes(uid);
        return `
          <div class="flex items-center gap-3 p-3 hover:bg-white/5 cursor-pointer rounded-xl ${selected ? 'bg-violet-600/15' : ''}" onclick="toggleGroupMember('${uid}')" data-uid="${uid}">
            <div class="w-10 h-10 rounded-full gradient-bg grid place-items-center font-bold">${escapeHtml((user?.name || '?').charAt(0).toUpperCase())}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium truncate">${getNameWithBadge(user?.name || 'Unknown', user?.email)}</div>
            </div>
            ${selected ? '<svg class="w-5 h-5 text-violet-300" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>' : ''}
          </div>
        `;
      }).join('');
    }

    function searchUsersForGroup(){
      const q = $('groupSearchInput').value.toLowerCase();
      document.querySelectorAll('#groupSearchResults [data-uid]').forEach(item => {
        const name = item.querySelector('.font-medium')?.textContent.toLowerCase() || '';
        item.style.display = name.includes(q) ? '' : 'none';
      });
    }

    function toggleGroupMember(uid){
      const i = selectedGroupMembers.indexOf(uid);
      if(i >= 0) selectedGroupMembers.splice(i,1);
      else selectedGroupMembers.push(uid);
      renderSelectedMembers();
      renderUsersForGroup();
    }

    function renderSelectedMembers(){
      const container = $('selectedMembers');
      if(!selectedGroupMembers.length){
        container.innerHTML = '';
        return;
      }
      container.innerHTML = selectedGroupMembers.map(uid => {
        const u = allUsers[uid];
        return `
          <div class="flex items-center gap-1 bg-violet-600/20 border border-white/10 rounded-full px-2 py-1">
            <span class="text-sm">${escapeHtml(u?.name || 'User')}</span>
            <button class="text-slate-300 hover:text-white" onclick="toggleGroupMember('${uid}')">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        `;
      }).join('');
    }

    async function createGroup(){
      const name = $('groupName').value.trim();
      if(!name) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
      if(!selectedGroupMembers.length) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');

      try{
        const groupId = database.ref().child('groups').push().key;
        const members = { [currentUser.uid]: true };
        selectedGroupMembers.forEach(uid => members[uid] = true);

        const updates = {};
        updates[`groups/${groupId}`] = {
          name,
          owner: currentUser.uid,
          members,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        Object.keys(members).forEach(uid => {
          updates[`userChats/${uid}/${groupId}`] = { type:'group', updatedAt: firebase.database.ServerValue.TIMESTAMP };
        });

        await database.ref().update(updates);

        closeModal('createGroupModal');
        selectedGroupMembers = [];
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞');
        setTimeout(() => openChat(groupId,'group'), 150);
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É');
      }
    }

    function showCreateChannel(){
      closeModal('createMenuModal');
      $('channelName').value = '';
      $('channelDescription').value = '';
      showModal('createChannelModal');
    }

    async function createChannel(){
      const name = $('channelName').value.trim();
      const description = $('channelDescription').value.trim();
      if(!name) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞');

      try{
        const channelId = database.ref().child('channels').push().key;
        const updates = {};
        updates[`channels/${channelId}`] = {
          name,
          description,
          owner: currentUser.uid,
          members: { [currentUser.uid]: true },
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        updates[`userChats/${currentUser.uid}/${channelId}`] = { type:'channel', updatedAt: firebase.database.ServerValue.TIMESTAMP };

        await database.ref().update(updates);

        closeModal('createChannelModal');
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω');
        setTimeout(() => openChat(channelId,'channel'), 150);
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª');
      }
    }

    // ====== ACCOUNT SWITCHER ======
    function showAccountSwitcher(){
      const accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      const container = $('accountSwitcherList');

      container.innerHTML = accounts.map(acc => {
        const isCurrent = currentUser?.email === acc.email;
        return `
          <div class="flex items-center gap-3 p-3 rounded-xl border border-white/10 ${isCurrent ? 'bg-violet-600/15' : 'hover:bg-white/5 cursor-pointer'}" ${isCurrent ? '' : `onclick=\"switchAccount('${escapeHtml(acc.email)}','${escapeHtml(acc.password)}')\"`}>
            <div class="w-10 h-10 gradient-bg rounded-full grid place-items-center font-bold">${escapeHtml((acc.name||'?').charAt(0).toUpperCase())}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium truncate">${escapeHtml(acc.name || acc.email)}</div>
              <div class="text-xs text-slate-400 truncate">${escapeHtml(acc.email)}</div>
            </div>
            ${isCurrent ? '<span class="text-xs text-violet-300">–¢–µ–∫—É—â–∏–π</span>' : ''}
          </div>
        `;
      }).join('') || '<div class="p-4 text-center text-slate-500">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>';

      showModal('accountSwitcherModal');
    }

    async function switchAccount(email, password){
      closeModal('accountSwitcherModal');
      await auth.signOut();
      await auth.signInWithEmailAndPassword(email, password);
    }

    function addNewAccount(){
      closeModal('accountSwitcherModal');
      auth.signOut();
    }

    // ====== PROFILE ======
    async function showProfile(){
      const snap = await database.ref(`users/${currentUser.uid}`).once('value');
      const user = snap.val() || {};

      $('profileAvatar').textContent = (user.name || '?').charAt(0).toUpperCase();
      $('profileNameDisplay').innerHTML = getNameWithBadge(user.name || 'User', currentUser.email);
      $('profileEmail').textContent = currentUser.email;
      $('newProfileName').value = user.name || '';
      $('newProfileStatus').value = user.status || '';

      showModal('profileModal');
    }

    async function updateProfile(e){
      e.preventDefault();
      const name = $('newProfileName').value.trim();
      const status = $('newProfileStatus').value.trim();
      if(!name) return;

      await database.ref(`users/${currentUser.uid}`).update({ name, status, nameLower: name.toLowerCase() });
      showToast('‚úì','–£—Å–ø–µ—à–Ω–æ','–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
      closeModal('profileModal');

      let accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      accounts = accounts.map(a => a.email === currentUser.email ? { ...a, name } : a);
      localStorage.setItem('flashchat_accounts', JSON.stringify(accounts));
      loadSavedAccounts();

      await loadAllUsers();
      renderChatList();
    }

    // ====== APP SETTINGS ======
    function showAppSettings() {
      loadAppSettings();
      calculateStorageUsage();
      showModal('appSettingsModal');
    }

    function loadAppSettings() {
      const settings = JSON.parse(localStorage.getItem('flashchat_settings') || '{}');
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const defaults = {
        notificationSound: true,
        pushNotifications: false,
        messagePreview: true,
        enterToSend: true,
        autoDownload: true,
        typingIndicator: true,
        readReceipts: true,
        showOnline: true,
        showLastSeen: true,
        fontSize: 14,
        compactMode: false,
        animations: true
      };

      const finalSettings = { ...defaults, ...settings };

      $('settingNotificationSound').checked = finalSettings.notificationSound;
      $('settingPushNotifications').checked = finalSettings.pushNotifications;
      $('settingMessagePreview').checked = finalSettings.messagePreview;
      $('settingEnterToSend').checked = finalSettings.enterToSend;
      $('settingAutoDownload').checked = finalSettings.autoDownload;
      $('settingTypingIndicator').checked = finalSettings.typingIndicator;
      $('settingReadReceipts').checked = finalSettings.readReceipts;
      $('settingShowOnline').checked = finalSettings.showOnline;
      $('settingShowLastSeen').checked = finalSettings.showLastSeen;
      $('settingFontSize').value = finalSettings.fontSize;
      $('fontSizeValue').textContent = finalSettings.fontSize + 'px';
      $('settingCompactMode').checked = finalSettings.compactMode;
      $('settingAnimations').checked = finalSettings.animations;

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      applySettings(finalSettings);
    }

    function saveAppSettings() {
      const settings = {
        notificationSound: $('settingNotificationSound').checked,
        pushNotifications: $('settingPushNotifications').checked,
        messagePreview: $('settingMessagePreview').checked,
        enterToSend: $('settingEnterToSend').checked,
        autoDownload: $('settingAutoDownload').checked,
        typingIndicator: $('settingTypingIndicator').checked,
        readReceipts: $('settingReadReceipts').checked,
        showOnline: $('settingShowOnline').checked,
        showLastSeen: $('settingShowLastSeen').checked,
        fontSize: parseInt($('settingFontSize').value),
        compactMode: $('settingCompactMode').checked,
        animations: $('settingAnimations').checked
      };

      localStorage.setItem('flashchat_settings', JSON.stringify(settings));
      applySettings(settings);
      showToast('‚úÖ', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
    }

    function applySettings(settings) {
      // –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞
      document.documentElement.style.setProperty('--message-font-size', settings.fontSize + 'px');
      
      // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º
      if (settings.compactMode) {
        document.body.classList.add('compact-mode');
      } else {
        document.body.classList.remove('compact-mode');
      }

      // –ê–Ω–∏–º–∞—Ü–∏–∏
      if (!settings.animations) {
        document.body.classList.add('no-animations');
      } else {
        document.body.classList.remove('no-animations');
      }
    }

    function updateFontSize() {
      const size = $('settingFontSize').value;
      $('fontSizeValue').textContent = size + 'px';
      saveAppSettings();
    }

    function toggleCompactMode() {
      saveAppSettings();
    }

    async function togglePushNotifications() {
      const enabled = $('settingPushNotifications').checked;
      
      if (enabled) {
        if ('Notification' in window) {
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') {
            $('settingPushNotifications').checked = false;
            showToast('‚ö†Ô∏è', '–û—Ç–∫–∞–∑–∞–Ω–æ', '–†–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
            return;
          }
        } else {
          $('settingPushNotifications').checked = false;
          showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
          return;
        }
      }
      
      saveAppSettings();
    }

    function calculateStorageUsage() {
      try {
        let totalSize = 0;
        
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä localStorage
        for (let key in localStorage) {
          if (localStorage.hasOwnProperty(key)) {
            totalSize += localStorage[key].length + key.length;
          }
        }
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ KB
        const sizeKB = (totalSize / 1024).toFixed(2);
        const maxSize = 5120; // ~5MB –ª–∏–º–∏—Ç localStorage
        const percentage = (totalSize / (maxSize * 1024)) * 100;
        
        $('storageUsed').textContent = sizeKB + ' KB / 5 MB';
        $('storageBar').style.width = Math.min(percentage, 100) + '%';
        
        if (percentage > 80) {
          $('storageBar').style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        } else if (percentage > 50) {
          $('storageBar').style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
        }
      } catch (err) {
        $('storageUsed').textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
      }
    }

    function clearCache() {
      if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ –Ω–µ —Å–æ–æ–±—â–µ–Ω–∏—è.')) return;
      
      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const accounts = localStorage.getItem('flashchat_accounts');
        const settings = localStorage.getItem('flashchat_settings');
        const theme = localStorage.getItem('theme');
        
        // –û—á–∏—â–∞–µ–º –≤—Å–µ
        localStorage.clear();
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if (accounts) localStorage.setItem('flashchat_accounts', accounts);
        if (settings) localStorage.setItem('flashchat_settings', settings);
        if (theme) localStorage.setItem('theme', theme);
        
        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–ö—ç—à –æ—á–∏—â–µ–Ω');
        calculateStorageUsage();
      } catch (err) {
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à');
      }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    if (currentUser) {
      loadAppSettings();
    }

    // ====== SETTINGS (OWNER) ======
    async function showSettings(chatId, type){
      const snap = await database.ref(`${type}s/${chatId}`).once('value');
      const data = snap.val();
      if(!data || data.owner !== currentUser.uid){
        return showToast('‚ùå','–û—à–∏–±–∫–∞','–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
      }

      $('settingsModal').dataset.chatId = chatId;
      $('settingsModal').dataset.type = type;
      pendingAvatarFile = null;

      $('settingsTitle').textContent = type === 'group' ? '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã' : '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞';
      $('settingsName').value = data.name || '';
      $('settingsDescription').value = data.description || '';
      $('deleteButtonText').textContent = type === 'group' ? '–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É' : '–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª';

      // Avatar
      const avatarLetter = $('settingsAvatarLetter');
      const avatarImg = $('settingsAvatarImg');
      const avatarContainer = $('settingsAvatar');
      
      avatarContainer.className = `chat-avatar chat-avatar-lg ${type === 'group' ? 'gradient-green' : 'gradient-orange'} cursor-pointer`;
      
      if(data.avatarUrl){
        avatarLetter.classList.add('hidden');
        avatarImg.classList.remove('hidden');
        avatarImg.src = data.avatarUrl;
      } else {
        avatarLetter.classList.remove('hidden');
        avatarImg.classList.add('hidden');
        avatarLetter.textContent = (data.name || '?').charAt(0).toUpperCase();
      }

      $('settingsDescriptionBlock').style.display = type === 'channel' ? 'block' : 'none';

      const members = data.members || {};
      $('settingsMemberCount').textContent = Object.keys(members).length;

      const list = $('settingsMembersList');
      list.innerHTML = '';

      for(const uid of Object.keys(members)){
        const u = allUsers[uid];
        if(!u) continue;
        const isOwner = uid === data.owner;
        const isSelf = uid === currentUser.uid;

        list.innerHTML += `
          <div class="flex items-center gap-3 p-2 bg-white/5 border border-white/10 rounded-xl">
            <div class="w-8 h-8 rounded-full gradient-bg grid place-items-center font-bold text-sm">${escapeHtml((u.name || '?').charAt(0).toUpperCase())}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm truncate">${getNameWithBadge(u.name || 'Unknown', u.email)} ${isOwner ? '<span class="text-xs text-violet-300">(–≤–ª–∞–¥–µ–ª–µ—Ü)</span>' : ''}</div>
            </div>
            ${(!isSelf && !isOwner) ? `
              <button class="icon-btn" style="width:36px;height:36px" onclick="removeMember('${chatId}','${type}','${uid}')" title="–£–¥–∞–ª–∏—Ç—å">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            ` : ''}
          </div>
        `;
      }

      showModal('settingsModal');
    }

    function handleAvatarSelect(event){
      const file = event.target.files?.[0];
      if(!file) return;

      if(!file.type.startsWith('image/')){
        showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
      }

      if(file.size > 5 * 1024 * 1024){
        showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å. 5MB)');
        return;
      }

      pendingAvatarFile = file;
      
      // Preview
      const reader = new FileReader();
      reader.onload = (e) => {
        $('settingsAvatarLetter').classList.add('hidden');
        $('settingsAvatarImg').classList.remove('hidden');
        $('settingsAvatarImg').src = e.target.result;
      };
      reader.readAsDataURL(file);
      
      event.target.value = '';
    }

    async function uploadAvatarToImgBB(file){
      return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('key', IMGBB_API_KEY);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://api.imgbb.com/1/upload');

        xhr.onload = () => {
          try{
            const data = JSON.parse(xhr.responseText);
            if(xhr.status === 200 && data.success){
              resolve(data.data.url);
            } else {
              reject(new Error(data?.error?.message || 'Upload failed'));
            }
          } catch(err){
            reject(new Error('Failed to parse response'));
          }
        };

        xhr.onerror = () => reject(new Error('Network error'));
        xhr.send(formData);
      });
    }

    async function saveSettings(){
      const chatId = $('settingsModal').dataset.chatId;
      const type = $('settingsModal').dataset.type;
      const name = $('settingsName').value.trim();
      const description = $('settingsDescription').value.trim();
      if(!name) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

      const updates = { name };
      if(type === 'channel') updates.description = description;

      try{
        // Upload avatar if changed
        if(pendingAvatarFile){
          showToast('‚è≥','–ó–∞–≥—Ä—É–∑–∫–∞','–ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É...');
          const avatarUrl = await uploadAvatarToImgBB(pendingAvatarFile);
          updates.avatarUrl = avatarUrl;
          pendingAvatarFile = null;
        }

        await database.ref(`${type}s/${chatId}`).update(updates);
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        closeModal('settingsModal');

        // Refresh current chat header if open
        if(currentChat === chatId){
          openChat(chatId, type);
        }

        await loadAllUsers();
        loadAllChats();
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
      }
    }

    async function removeMember(chatId, type, uid){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) return;
      try{
        await database.ref(`${type}s/${chatId}/members/${uid}`).remove();
        await database.ref(`userChats/${uid}/${chatId}`).remove();
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª–µ–Ω');
        showSettings(chatId, type);
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
      }
    }

    async function deleteGroupOrChannel(){
      const chatId = $('settingsModal').dataset.chatId;
      const type = $('settingsModal').dataset.type;
      const typeName = type === 'group' ? '–≥—Ä—É–ø–ø—É' : '–∫–∞–Ω–∞–ª';
      if(!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${typeName}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;

      try{
        const snap = await database.ref(`${type}s/${chatId}/members`).once('value');
        const members = snap.val() || {};

        const updates = {};
        Object.keys(members).forEach(uid => {
          updates[`userChats/${uid}/${chatId}`] = null;
        });
        updates[`messages/${chatId}`] = null;
        updates[`${type}s/${chatId}`] = null;

        await database.ref().update(updates);

        closeModal('settingsModal');
        closeChat();
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ', type === 'group' ? '–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞' : '–ö–∞–Ω–∞–ª —É–¥–∞–ª–µ–Ω');
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
      }
    }

    // ====== GLOBAL EVENTS ======
    document.addEventListener('visibilitychange', () => {
      if(currentUser) updateOnlineStatus(!document.hidden);
      if(!document.hidden && currentChat) markAsRead(currentChat);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã/–≤–∫–ª–∞–¥–∫–∏
    window.addEventListener('beforeunload', () => {
      if(currentUser){
        // –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        database.ref(`users/${currentUser.uid}`).update({
          online: false,
          lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('blur', () => {
      if(currentUser) updateOnlineStatus(false);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ–∫—É—Å–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('focus', () => {
      if(currentUser) updateOnlineStatus(true);
    });

    window.addEventListener('resize', () => {
      if(!$('chatScreen').classList.contains('active')) return;

      if(window.innerWidth <= 768){
        if(currentChat){
          $('sidebar').style.display = 'none';
          $('chatArea').style.display = 'flex';
          $('chatArea').classList.add('active');
        } else {
          $('sidebar').style.display = 'flex';
          $('chatArea').style.display = 'none';
          $('chatArea').classList.remove('active');
        }
      } else {
        $('sidebar').style.display = 'flex';
        $('chatArea').style.display = 'flex';
        $('chatArea').classList.remove('active');
      }
    });

    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){
        ['createMenuModal','newPrivateChatModal','createGroupModal','createChannelModal','accountSwitcherModal','profileModal','settingsModal','editMessageModal','createPollModal','videoMessageModal','voiceMessageModal'].forEach(id => closeModal(id));
        stopVideoMessage();
        stopVoiceMessageModal();
        closeImageViewer();
        closeConfirmModal();
        hideMessageContextMenu();
        closeEmoji();
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ confirmModal –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    $('confirmModal').addEventListener('click', (e) => {
      if(e.target.id === 'confirmModal') closeConfirmModal();
    });

    // Close emoji picker on outside click (Telegram-like)
    document.addEventListener('click', (e) => {
      const picker = $('emojiPicker');
      if(!picker.classList.contains('show')) return;

      const inputArea = $('messageInputArea');
      if(inputArea && inputArea.contains(e.target)) return;

      closeEmoji();
    });

    // ====== INIT ======
    console.log('Initializing app...');
    loadSavedAccounts();
    renderEmojiCategory('smileys');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
    console.log('Setting up form handlers...');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    
    if (loginForm) {
      console.log('Login form found, adding handler');
      loginForm.addEventListener('submit', login);
    } else {
      console.error('Login form not found!');
    }
    
    if (registerForm) {
      console.log('Register form found, adding handler');
      registerForm.addEventListener('submit', register);
    } else {
      console.error('Register form not found!');
    }
    
    // –£–ª—É—á—à–µ–Ω–∏–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    function improveButtonClicks() {
      const buttons = document.querySelectorAll('.icon-btn, .send-btn');
      buttons.forEach(btn => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        if (btn.dataset.touchHandlersAdded) return;
        btn.dataset.touchHandlersAdded = 'true';
        
        // –î–æ–±–∞–≤–ª—è–µ–º touch —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ª—É—á—à–µ–π –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏
        btn.addEventListener('touchstart', function(e) {
          this.style.opacity = '0.7';
        }, { passive: true });
        
        btn.addEventListener('touchend', function(e) {
          this.style.opacity = '';
        }, { passive: true });
        
        btn.addEventListener('touchcancel', function(e) {
          this.style.opacity = '';
        }, { passive: true });
      });
    }
    
    // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    setTimeout(() => {
      improveButtonClicks();
    }, 500);
    
    // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ DOM (–∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–∞—Ç) —Å debounce
    let mutationTimeout;
    const observer = new MutationObserver(() => {
      clearTimeout(mutationTimeout);
      mutationTimeout = setTimeout(() => {
        improveButtonClicks();
      }, 100);
    });
    
    // –ù–∞–±–ª—é–¥–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞ chatScreen, –∞ –Ω–µ –∑–∞ –≤—Å–µ–º body
    setTimeout(() => {
      const chatScreen = document.getElementById('chatScreen');
      if (chatScreen) {
        observer.observe(chatScreen, {
          childList: true,
          subtree: true
        });
      }
    }, 1000);

    // ============================================
    // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ö–ê–ö –í TELEGRAM
    // ============================================

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let replyToMessageId = null;
    let replyToMessageData = null;
    let pinnedMessageId = null;

    // ====== 1. –û–¢–í–ï–¢ –ù–ê –°–û–û–ë–©–ï–ù–ò–ï (REPLY) ======
    function replyToMessage() {
      hideMessageContextMenu();
      if (!currentMessageId || !currentChat) return;

      database.ref(`messages/${currentChat}/${currentMessageId}`).once('value', snap => {
        const msg = snap.val();
        if (!msg) return;

        replyToMessageId = currentMessageId;
        replyToMessageData = msg;
        showReplyPanel(msg);
      });
    }

    function showReplyPanel(msg) {
      const senderName = allUsers[msg.senderId]?.name || 'Unknown';
      const messageText = msg.text || (msg.fileUrl ? 'üìé –§–∞–π–ª' : '');

      const replyPanel = document.createElement('div');
      replyPanel.id = 'replyPanel';
      replyPanel.className = 'reply-panel';
      replyPanel.innerHTML = `
        <div class="reply-content">
          <div class="reply-line"></div>
          <div class="reply-info">
            <div class="reply-sender">${escapeHtml(senderName)}</div>
            <div class="reply-text">${escapeHtml(messageText).substring(0, 50)}${messageText.length > 50 ? '...' : ''}</div>
          </div>
        </div>
        <button onclick="cancelReply()" class="reply-cancel">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      `;

      const messageInputArea = $('messageInputArea');
      const existingPanel = $('replyPanel');
      if (existingPanel) existingPanel.remove();
      
      messageInputArea.insertBefore(replyPanel, messageInputArea.firstChild);
      $('messageInput').focus();
    }

    function cancelReply() {
      replyToMessageId = null;
      replyToMessageData = null;
      const panel = $('replyPanel');
      if (panel) panel.remove();
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º sendMessage —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å reply
    const originalSendMessage = sendMessage;
    sendMessage = async function(e) {
      e.preventDefault();
      if(isUploading) return showToast('‚è≥','–ü–æ–¥–æ–∂–¥–∏—Ç–µ','–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...');
      if(pendingFile) return sendFileWithCaption();

      const input = $('messageInput');
      const text = input.value.trim();
      if(!text || !currentChat) return;

      input.value = '';

      if(typingTimeout){
        clearTimeout(typingTimeout);
        database.ref(`typing/${currentChat}/${currentUser.uid}`).set(false);
      }

      const messageData = {
        senderId: currentUser.uid,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        readBy: { [currentUser.uid]: true },
        text
      };

      // –î–æ–±–∞–≤–ª—è–µ–º reply –µ—Å–ª–∏ –µ—Å—Ç—å
      if(replyToMessageId && replyToMessageData){
        messageData.replyTo = {
          messageId: replyToMessageId,
          senderId: replyToMessageData.senderId,
          text: replyToMessageData.text || 'üìé –§–∞–π–ª'
        };
        cancelReply();
      }

      await database.ref(`messages/${currentChat}`).push(messageData);
      await touchChatUpdatedAt(currentChat);
      closeEmoji();
    };

    // ====== 2. –ü–ï–†–ï–°–´–õ–ö–ê –°–û–û–ë–©–ï–ù–ò–ô (FORWARD) ======
    function forwardMessage() {
      hideMessageContextMenu();
      if (!currentMessageId || !currentChat) return;

      database.ref(`messages/${currentChat}/${currentMessageId}`).once('value', snap => {
        const msg = snap.val();
        if (!msg) return;
        showForwardModal(currentMessageId, msg);
      });
    }

    function showForwardModal(msgId, msg) {
      const modal = document.createElement('div');
      modal.id = 'forwardModal';
      modal.className = 'modal show';
      modal.onclick = (e) => { if (e.target.id === 'forwardModal') closeForwardModal(); };

      const chatsList = allChats.filter(c => c.id !== currentChat).map(chat => {
        const name = chat.type === 'private' 
          ? (allUsers[chat.oderId]?.name || 'Unknown')
          : (chat.name || 'Group');
        
        return `
          <div class="chat-item" onclick="forwardToChat('${chat.id}', '${msgId}')">
            <div class="w-10 h-10 rounded-full gradient-bg grid place-items-center font-bold">
              ${escapeHtml(name.charAt(0).toUpperCase())}
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-medium truncate">${escapeHtml(name)}</div>
              <div class="text-xs text-slate-400">${chat.type === 'private' ? '–õ–∏—á–Ω—ã–π —á–∞—Ç' : '–ì—Ä—É–ø–ø–∞'}</div>
            </div>
          </div>
        `;
      }).join('');

      modal.innerHTML = `
        <div class="sheet p-4">
          <h3 class="text-lg font-bold mb-4">–ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
          <div class="space-y-2 max-h-96 overflow-auto scrollbar">
            ${chatsList || '<div class="text-center text-slate-400 py-4">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–∞—Ç–æ–≤</div>'}
          </div>
          <button class="w-full mt-4 py-2 text-slate-400 hover:text-white" onclick="closeForwardModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function forwardToChat(chatId, msgId) {
      try {
        const snap = await database.ref(`messages/${currentChat}/${msgId}`).once('value');
        const msg = snap.val();
        if (!msg) return;

        const forwardedMsg = {
          senderId: currentUser.uid,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          readBy: { [currentUser.uid]: true },
          text: msg.text || '',
          forwarded: {
            from: msg.senderId,
            originalChat: currentChat
          }
        };

        if (msg.fileUrl) {
          forwardedMsg.fileUrl = msg.fileUrl;
          forwardedMsg.fileName = msg.fileName;
          forwardedMsg.fileType = msg.fileType;
        }

        await database.ref(`messages/${chatId}`).push(forwardedMsg);
        await touchChatUpdatedAt(chatId);

        closeForwardModal();
        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ');
      } catch (err) {
        console.error('Forward error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å–ª–∞—Ç—å');
      }
    }

    function closeForwardModal() {
      const modal = $('forwardModal');
      if (modal) modal.remove();
    }

    // ====== 3. –ó–ê–ö–†–ï–ü–õ–ï–ù–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø (PIN) ======
    async function pinMessage() {
      hideMessageContextMenu();
      if (!currentMessageId || !currentChat) return;

      try {
        const snap = await database.ref(`messages/${currentChat}/${currentMessageId}`).once('value');
        const msg = snap.val();
        if (!msg) return;

        await database.ref(`groupChats/${currentChat}/pinnedMessage`).set({
          messageId: currentMessageId,
          text: msg.text || 'üìé –§–∞–π–ª',
          senderId: msg.senderId,
          pinnedBy: currentUser.uid,
          pinnedAt: firebase.database.ServerValue.TIMESTAMP
        });

        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ');
        loadPinnedMessage();
      } catch (err) {
        console.error('Pin error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä–µ–ø–∏—Ç—å');
      }
    }

    async function unpinMessage() {
      if (!currentChat) return;

      try {
        await database.ref(`groupChats/${currentChat}/pinnedMessage`).remove();
        $('pinnedMessage').classList.remove('show');
        pinnedMessageId = null;
        showToast('‚úÖ', '–£—Å–ø–µ—à–Ω–æ', '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ');
      } catch (err) {
        console.error('Unpin error:', err);
      }
    }

    async function loadPinnedMessage() {
      if (!currentChat) return;

      const snap = await database.ref(`groupChats/${currentChat}/pinnedMessage`).once('value');
      const pinned = snap.val();

      if (pinned) {
        pinnedMessageId = pinned.messageId;
        $('pinnedMessageText').textContent = pinned.text;
        $('pinnedMessage').classList.add('show');
      } else {
        $('pinnedMessage').classList.remove('show');
        pinnedMessageId = null;
      }
    }

    function scrollToPinnedMessage() {
      if (!pinnedMessageId) return;
      const msgEl = document.getElementById(`msg-${pinnedMessageId}`);
      if (msgEl) {
        msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        msgEl.style.animation = 'highlight 1s';
      }
    }

    // ====== 4. –¢–ï–ú–ù–ê–Ø/–°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê ======
    let isDarkTheme = true;

    function toggleTheme() {
      isDarkTheme = !isDarkTheme;
      document.body.classList.toggle('light-theme', !isDarkTheme);
      localStorage.setItem('theme', isDarkTheme ? 'dark' : 'light');
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–º—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      isDarkTheme = false;
      document.body.classList.add('light-theme');
    }

    // ====== 5. –ò–ó–ë–†–ê–ù–ù–û–ï / SAVED MESSAGES ======
    async function saveToFavorites() {
      console.log('saveToFavorites called', { currentMessageId, currentChat });
      hideMessageContextMenu();
      if (!currentMessageId || !currentChat) {
        console.log('No message or chat selected');
        return;
      }

      try {
        console.log('Fetching message from:', `messages/${currentChat}/${currentMessageId}`);
        const snap = await database.ref(`messages/${currentChat}/${currentMessageId}`).once('value');
        const msg = snap.val();
        console.log('Message data:', msg);
        
        if (!msg) {
          console.log('Message not found');
          return;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
        const savedMsg = {
          senderId: msg.senderId,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          text: msg.text || '',
          originalChat: currentChat,
          originalMessageId: currentMessageId,
          savedAt: firebase.database.ServerValue.TIMESTAMP
        };

        // –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        if (msg.fileUrl) {
          savedMsg.fileUrl = msg.fileUrl;
          savedMsg.fileName = msg.fileName;
          savedMsg.fileType = msg.fileType;
        }

        // –ö–æ–ø–∏—Ä—É–µ–º reply –µ—Å–ª–∏ –µ—Å—Ç—å
        if (msg.replyTo) {
          savedMsg.replyTo = msg.replyTo;
        }

        console.log('Saving to:', `savedMessages/${currentUser.uid}`, savedMsg);
        await database.ref(`savedMessages/${currentUser.uid}`).push(savedMsg);
        console.log('Message saved successfully');
        showToast('‚≠ê', '–£—Å–ø–µ—à–Ω–æ', '–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
      } catch (err) {
        console.error('Save to favorites error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + err.message);
      }
    }

    async function openSavedMessages() {
      console.log('openSavedMessages called');
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç
      if (currentChat) {
        database.ref(`messages/${currentChat}`).off();
        database.ref(`typing/${currentChat}`).off();
      }

      currentChat = `saved_${currentUser.uid}`;
      currentChatType = 'saved';
      console.log('Set currentChat to:', currentChat, 'currentChatType:', currentChatType);

      // Mobile: switch panels
      if (window.innerWidth <= 768) {
        $('sidebar').style.display = 'none';
        $('chatArea').style.display = 'flex';
        $('chatArea').classList.add('active');
      } else {
        $('chatArea').style.display = 'flex';
      }

      $('emptyChat').style.display = 'none';
      $('activeChat').classList.add('active');
      closeEmoji();

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
      const avatarEl = $('chatAvatar');
      avatarEl.innerHTML = '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>';
      avatarEl.className = 'chat-avatar chat-avatar-sm';
      avatarEl.style.background = 'linear-gradient(135deg, #f59e0b 0%, #f97316 100%)';
      
      $('chatName').textContent = '‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
      $('chatStatus').textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è';
      $('chatHeaderActions').innerHTML = '';

      // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      $('pinnedMessage').classList.remove('show');
      $('typingIndicator').classList.add('hidden');

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      console.log('Calling loadSavedMessages...');
      loadSavedMessages();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
      $('messageInputArea').style.display = 'block';
      $('channelNotice').style.display = 'none';

      requestAnimationFrame(() => {
        $('messagesContainer').scrollTop = $('messagesContainer').scrollHeight;
      });
    }

    function loadSavedMessages() {
      console.log('loadSavedMessages called for user:', currentUser.uid);
      const container = $('messagesContainer');
      container.innerHTML = '';

      const ref = database.ref(`savedMessages/${currentUser.uid}`);
      console.log('Listening to:', `savedMessages/${currentUser.uid}`);
      
      ref.orderByChild('savedAt').off();
      ref.orderByChild('savedAt').on('child_added', snap => {
        console.log('Saved message received:', snap.key, snap.val());
        const msg = snap.val();
        const msgId = snap.key;
        addSavedMessageToUI(msg, msgId);
      });

      ref.on('child_removed', snap => {
        console.log('Saved message removed:', snap.key);
        const msgId = snap.key;
        const msgEl = document.getElementById(`msg-${msgId}`);
        if (msgEl) msgEl.remove();
      });
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      ref.once('value', snap => {
        const count = snap.numChildren();
        console.log('Total saved messages:', count);
        if (count === 0) {
          container.innerHTML = '<div class="p-6 text-center text-slate-400">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
        }
      });
    }

    function addSavedMessageToUI(msg, msgId) {
      const container = $('messagesContainer');

      let senderLine = '';
      const sender = allUsers[msg.senderId];
      if (sender) {
        senderLine = `<div class="sender-line">${getNameWithBadge(sender?.name || 'Unknown', sender?.email)}</div>`;
      }

      let content = '';

      // –î–æ–±–∞–≤–ª—è–µ–º reply –µ—Å–ª–∏ –µ—Å—Ç—å
      if (msg.replyTo) {
        const replySender = allUsers[msg.replyTo.senderId]?.name || 'Unknown';
        content += `
          <div class="reply-in-message" style="margin-bottom:10px; padding:10px 12px; background:rgba(0,0,0,.4); border-left:4px solid #8b5cf6; border-radius:8px; backdrop-filter:blur(10px);">
            <div class="reply-name" style="font-size:12px; font-weight:700; color:#a78bfa; margin-bottom:4px; display:flex; align-items:center; gap:4px;">
              <svg style="width:14px; height:14px; flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
              ${escapeHtml(replySender)}
            </div>
            <div class="reply-msg" style="font-size:13px; color:rgba(255,255,255,.9); line-height:1.5; padding-left:18px;">${escapeHtml(msg.replyTo.text).substring(0, 100)}${msg.replyTo.text.length > 100 ? '...' : ''}</div>
          </div>
        `;
      }

      // –§–∞–π–ª—ã
      if (msg.fileUrl) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å–ª–∏ —ç—Ç–æ –∫—Ä—É–∂–æ–∫ (–≤–∏–¥–µ–æ-—Å–æ–æ–±—â–µ–Ω–∏–µ)
        if(msg.isVideoMessage){
          const fileId = msg.fileUrl.replace('firebase-file://', '');
          content += `
            <div class="video-message-container mb-2" onclick="playVideoMessage('${msgId}')">
              <video id="video-${msgId}" data-file-id="${fileId}" loop muted></video>
              <div class="video-message-play">
                <svg style="width:64px; height:64px; color:white;" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
              </div>
            </div>
          `;
          loadFirebaseFile(fileId, msgId);
        }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å–ª–∏ —ç—Ç–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        else if(msg.isVoiceMessage){
          const fileId = msg.fileUrl.replace('firebase-file://', '');
          const duration = msg.duration || 0;
          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          const durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          content += `
            <div class="audio-player mb-2" id="audio-player-${msgId}">
              <button class="audio-play-btn" onclick="toggleAudioPlayback('${msgId}', '${fileId}')">
                <svg class="play-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
                <svg class="pause-icon hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75A.75.75 0 007.25 3h-1.5zM12.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75h-1.5z"/></svg>
              </button>
              <div class="audio-waveform">
                ${Array(20).fill(0).map((_, i) => {
                  const height = Math.random() * 60 + 20;
                  return `<div class="audio-waveform-bar" style="height:${height}%"></div>`;
                }).join('')}
              </div>
              <div class="audio-time">${durationText}</div>
              <audio id="audio-${msgId}" data-file-id="${fileId}" style="display:none;"></audio>
            </div>
          `;
          loadFirebaseFile(fileId, msgId);
        }
        else if (msg.fileUrl.startsWith('firebase-file://')) {
          const fileId = msg.fileUrl.replace('firebase-file://', '');
          
          if (msg.fileType && msg.fileType.startsWith('image/')) {
            content += `
              <div class="message-media mb-2">
                <img loading="lazy" data-file-id="${fileId}" alt="image" style="cursor:pointer" onclick="viewFirebaseFile('${fileId}')" />
              </div>
            `;
            loadFirebaseFile(fileId, msgId);
          } else if (msg.fileType && msg.fileType.startsWith('video/')) {
            content += `
              <div class="message-media mb-2">
                <video controls data-file-id="${fileId}"></video>
              </div>
            `;
            loadFirebaseFile(fileId, msgId);
          } else {
            content += `
              <div class="file-chip mb-2" onclick="downloadFirebaseFile('${fileId}', '${escapeHtml(msg.fileName || 'file')}')" style="cursor:pointer">
                <svg class="w-8 h-8 text-violet-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                <div class="min-w-0">
                  <div class="text-sm font-medium truncate">${escapeHtml(msg.fileName || '–§–∞–π–ª')}</div>
                  <div class="text-xs text-slate-400">–°–∫–∞—á–∞—Ç—å</div>
                </div>
              </div>
            `;
          }
        } else {
          if (msg.fileType && msg.fileType.startsWith('image/')) {
            content += `
              <div class="message-media mb-2">
                <img loading="lazy" src="${msg.fileUrl}" alt="image" onclick="viewImage('${msg.fileUrl}')" style="cursor:pointer" />
              </div>
            `;
          } else if (msg.fileType && msg.fileType.startsWith('video/')) {
            content += `
              <div class="message-media mb-2">
                <video controls src="${msg.fileUrl}"></video>
              </div>
            `;
          } else {
            content += `
              <a href="${msg.fileUrl}" target="_blank" class="file-chip mb-2">
                <svg class="w-8 h-8 text-violet-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                <div class="min-w-0">
                  <div class="text-sm font-medium truncate">${escapeHtml(msg.fileName || '–§–∞–π–ª')}</div>
                  <div class="text-xs text-slate-400">–û—Ç–∫—Ä—ã—Ç—å</div>
                </div>
              </a>
            `;
          }
        }
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ä–æ—Å –µ—Å–ª–∏ –µ—Å—Ç—å
      if(msg.poll){
        const poll = msg.poll;
        const hasVoted = poll.options.some(opt => opt.voters && opt.voters[currentUser.uid]);
        
        content += `
          <div class="poll-container" style="margin-bottom:8px;">
            <div class="poll-question" style="font-size:15px; font-weight:600; margin-bottom:12px; line-height:1.4;">
              ${escapeHtml(poll.question)}
            </div>
        `;
        
        poll.options.forEach((option, index) => {
          const percentage = poll.totalVotes > 0 ? Math.round((option.votes / poll.totalVotes) * 100) : 0;
          const isVoted = option.voters && option.voters[currentUser.uid];
          const votedClass = hasVoted ? 'voted' : '';
          const votedStyle = isVoted ? 'border: 2px solid rgba(139,92,246,.9);' : '';
          
          content += `
            <div class="poll-option ${votedClass}" style="${votedStyle} cursor:default;">
              <div class="poll-progress" style="width:${percentage}%;"></div>
              <div class="poll-option-content">
                <div style="display:flex; align-items:center; gap:8px;">
                  ${isVoted ? '<svg style="width:16px; height:16px; color:#8b5cf6; flex-shrink:0;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' : ''}
                  <span style="font-size:14px;">${escapeHtml(option.text)}</span>
                </div>
                <div class="poll-votes">${percentage}%</div>
              </div>
            </div>
          `;
        });
        
        const votersText = poll.totalVotes === 1 ? '–≥–æ–ª–æ—Å' : poll.totalVotes < 5 ? '–≥–æ–ª–æ—Å–∞' : '–≥–æ–ª–æ—Å–æ–≤';
        content += `
            <div style="font-size:12px; color:rgba(148,163,184,.7); margin-top:8px; text-align:center;">
              ${poll.totalVotes} ${votersText}${poll.anonymous ? ' ‚Ä¢ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –æ–ø—Ä–æ—Å' : ''}
            </div>
          </div>
        `;
      }

      if (msg.text) {
        const captionClass = (msg.fileUrl && msg.fileType && (msg.fileType.startsWith('image/') || msg.fileType.startsWith('video/'))) ? 'msg-text media-caption' : 'msg-text';
        content += `<div class="${captionClass}">${escapeHtml(msg.text)}</div>`;
      }

      const row = document.createElement('div');
      row.className = 'message-row out fade-in';
      row.id = `msg-${msgId}`;

      row.innerHTML = `
        <div class="msg-wrap">
          ${senderLine}
          <div class="bubble out" oncontextmenu="showSavedMessageMenu(event,'${msgId}')" onclick="handleMessageTap(event,'${msgId}')">
            ${content}
            <div class="meta">
              <span class="time">${formatTime(msg.timestamp)}</span>
            </div>
          </div>
        </div>
      `;

      container.appendChild(row);
      const nearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 120;
      if (nearBottom) container.scrollTop = container.scrollHeight;
    }

    function showSavedMessageMenu(e, msgId) {
      e.preventDefault();
      currentMessageId = msgId;
      const menu = $('messageContextMenu');
      
      // –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
      $('replyMessageBtn').style.display = 'none';
      $('forwardMessageBtn').style.display = 'flex';
      $('pinMessageBtn').style.display = 'none';
      $('saveToFavoritesBtn').style.display = 'none';
      $('editMessageBtn').style.display = 'none';
      $('deleteMessageBtn').style.display = 'flex';
      $('copyMessageBtn').style.display = 'flex';
      
      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      database.ref(`savedMessages/${currentUser.uid}/${msgId}`).once('value', snap => {
        const msg = snap.val();
        currentMessageText = msg?.text || '';
      });
      
      menu.classList.add('show');

      const rect = e.target.getBoundingClientRect();
      const menuWidth = 200;
      const menuHeight = 180;
      
      let left = Math.min(rect.left, window.innerWidth - menuWidth - 10);
      left = Math.max(10, left);
      
      let top = rect.top - menuHeight;
      if (top < 10) top = rect.bottom + 10;
      
      menu.style.left = left + 'px';
      menu.style.top = top + 'px';

      setTimeout(() => {
        document.addEventListener('click', hideMessageContextMenu, { once: true });
      }, 0);
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º deleteMessage –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–±—Ä–∞–Ω–Ω—ã–º
    const originalDeleteMessage = deleteMessage;
    deleteMessage = async function() {
      hideMessageContextMenu();
      if (!currentMessageId) return;

      if (currentChatType === 'saved') {
        // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        messageToDelete = currentMessageId;
        $('confirmModal').classList.add('show');
      } else {
        // –û–±—ã—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
        await originalDeleteMessage();
      }
    };

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º confirmDeleteMessage –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–±—Ä–∞–Ω–Ω—ã–º
    const originalConfirmDeleteMessage = confirmDeleteMessage;
    confirmDeleteMessage = async function() {
      closeConfirmModal();
      
      if (!messageToDelete) return;

      console.log('Deleting message:', messageToDelete, 'from chat:', currentChat, 'type:', currentChatType);

      try {
        if (currentChatType === 'saved') {
          // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
          console.log('Deleting from saved messages...');
          await database.ref(`savedMessages/${currentUser.uid}/${messageToDelete}`).remove();
          const msgEl = document.getElementById(`msg-${messageToDelete}`);
          if (msgEl) {
            msgEl.remove();
            console.log('Message element removed from DOM');
          }
          showCopyToast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        } else {
          // –û–±—ã—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
          if (!currentChat) {
            console.error('No current chat selected');
            return;
          }
          console.log('Deleting from messages...');
          await database.ref(`messages/${currentChat}/${messageToDelete}`).remove();
          console.log('Message deleted from Firebase');
          const msgEl = document.getElementById(`msg-${messageToDelete}`);
          if (msgEl) {
            msgEl.remove();
            console.log('Message element removed from DOM');
          } else {
            console.warn('Message element not found in DOM:', `msg-${messageToDelete}`);
          }
          showCopyToast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
        }
      } catch (err) {
        console.error('Delete message error:', err);
        showToast('‚ùå', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + err.message);
      }
      
      messageToDelete = null;
    };

    // Close emoji picker on outside click (Telegram-like)
    document.addEventListener('click', (e) => {
      const picker = $('emojiPicker');
      if(!picker.classList.contains('show')) return;

      const emojiBtn = document.querySelector('[onclick*="toggleEmoji"]');
      if(emojiBtn && emojiBtn.contains(e.target)) return;

      const inputArea = $('messageInputArea');
      if(inputArea && inputArea.contains(e.target)) return;

      closeEmoji();
    });

    // ====== INIT ======
    loadSavedAccounts();
    renderEmojiCategory('smileys');

  </script>

</body>
</html>